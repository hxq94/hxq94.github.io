<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å°zâ€˜s life</title>
  
  
  <link href="https://hxq94.github.io/atom.xml" rel="self"/>
  
  <link href="https://hxq94.github.io/"/>
  <updated>2023-12-24T15:41:18.886Z</updated>
  <id>https://hxq94.github.io/</id>
  
  <author>
    <name>libei</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å‘½ä»¤</title>
    <link href="https://hxq94.github.io/2023/12/23/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <id>https://hxq94.github.io/2023/12/23/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</id>
    <published>2023-12-23T06:01:05.827Z</published>
    <updated>2023-12-24T15:41:18.886Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æ•´äº†ä¸‹ä»“åº“ï¼Œå’Œç”µè„‘ä¸Šçš„æ–‡ä»¶ï¼Œå‘ç°æœ‰å¾ˆå¤šæ˜¯é›¶æ•£çš„ï¼Œä¸æ˜¯å¤ªè§„æ•´ï¼ˆè™½ç„¶ä¹‹å‰ä¹Ÿä¸æ˜¯ä¹±æ”¾çš„ï¼‰ï¼Œä½†æ˜¯æ–‡ä»¶å¤šäº†å°±æœ‰ç‚¹ä¹±äº†ï¼Œä»Šå¤©æŠ½ç©ºæŠŠé¡¹ç›®æ•´ç†ä¸‹</p><span id="more"></span><h3 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h3><h4 id="mac-åˆ‡æ¢jdkç‰ˆæœ¬"><a href="#mac-åˆ‡æ¢jdkç‰ˆæœ¬" class="headerlink" title="mac åˆ‡æ¢jdkç‰ˆæœ¬"></a>mac åˆ‡æ¢jdkç‰ˆæœ¬</h4><blockquote><p> mac åˆ‡æ¢jdkç‰ˆæœ¬</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">.zshrcæ–‡ä»¶ä¸­ æ·»åŠ ä»¥ä¸‹é…ç½®:</span></span><br><span class="line">export JAVA_8_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk1.8.0_261.jdk/Contents/Home&quot;</span><br><span class="line">export JAVA_17_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk-17.jdk/Contents/Home&quot;</span><br><span class="line">export JAVA_HOME=$JAVA_8_HOME</span><br><span class="line">alias jdk8=&quot;export JAVA_HOME=$JAVA_8_HOME&quot;</span><br><span class="line">alias jdk17=&quot;export JAVA_HOME=$JAVA_17_HOME&quot;</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.zshrc</span><br></pre></td></tr></table></figure><h4 id="kafkaå¿«é€Ÿä½“éªŒdocker-compose"><a href="#kafkaå¿«é€Ÿä½“éªŒdocker-compose" class="headerlink" title="kafkaå¿«é€Ÿä½“éªŒdocker-compose"></a>kafkaå¿«é€Ÿä½“éªŒdocker-compose</h4><blockquote><p>kafkaå¿«é€Ÿä½“éªŒdocker-compose</p></blockquote><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;4&quot;</span></span><br><span class="line">services:</span><br><span class="line">  zookeeper:</span><br><span class="line">    image: <span class="string">&#x27;bitnami/zookeeper:latest&#x27;</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&#x27;2181:2181&#x27;</span></span><br><span class="line">    environment:</span><br><span class="line">      <span class="comment"># åŒ¿åç™»å½•--å¿…é¡»å¼€å¯</span></span><br><span class="line">      - ALLOW_ANONYMOUS_LOGIN=yes</span><br><span class="line">  <span class="comment">#volumes:</span></span><br><span class="line">  <span class="comment">#- ./zookeeper:/bitnami/zookeeper</span></span><br><span class="line">  <span class="comment"># è¯¥é•œåƒå…·ä½“é…ç½®å‚è€ƒ https://github.com/bitnami/bitnami-docker-kafka/blob/master/README.md</span></span><br><span class="line">  kafka:</span><br><span class="line">    image: <span class="string">&#x27;bitnami/kafka:2.8.0&#x27;</span></span><br><span class="line">    container_name: <span class="string">&#x27;small-kafka&#x27;</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&#x27;9092:9092&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;9999:9095&#x27;</span></span><br><span class="line">    environment:</span><br><span class="line">      - KAFKA_BROKER_ID=<span class="number">1</span></span><br><span class="line">      - KAFKA_CFG_LISTENERS=PLAINTEXT://:<span class="number">9092</span></span><br><span class="line">      <span class="comment"># å®¢æˆ·ç«¯è®¿é—®åœ°å€ï¼Œæ›´æ¢æˆè‡ªå·±çš„</span></span><br><span class="line">      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://<span class="number">192.168</span>.<span class="number">26.100</span>:<span class="number">9092</span></span><br><span class="line">      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:<span class="number">2181</span></span><br><span class="line">      <span class="comment"># å…è®¸ä½¿ç”¨PLAINTEXTåè®®(é•œåƒä¸­é»˜è®¤ä¸ºå…³é—­,éœ€è¦æ‰‹åŠ¨å¼€å¯)</span></span><br><span class="line">      - ALLOW_PLAINTEXT_LISTENER=yes</span><br><span class="line">      <span class="comment"># å…³é—­è‡ªåŠ¨åˆ›å»º topic åŠŸèƒ½</span></span><br><span class="line">      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=false</span><br><span class="line">      <span class="comment"># å…¨å±€æ¶ˆæ¯è¿‡æœŸæ—¶é—´ 6 å°æ—¶(æµ‹è¯•æ—¶å¯ä»¥è®¾ç½®çŸ­ä¸€ç‚¹)</span></span><br><span class="line">      - KAFKA_CFG_LOG_RETENTION_HOURS=<span class="number">6</span></span><br><span class="line">      <span class="comment"># å¼€å¯JMXç›‘æ§</span></span><br><span class="line">      <span class="comment"># - JMX_PORT=9999</span></span><br><span class="line">    <span class="comment">#volumes:</span></span><br><span class="line">    <span class="comment">#- ./kafka:/bitnami/kafka</span></span><br><span class="line">    depends_on:</span><br><span class="line">      - zookeeper</span><br><span class="line">  <span class="comment"># Web ç®¡ç†ç•Œé¢ å¦å¤–ä¹Ÿå¯ä»¥ç”¨exporter+prometheus+grafanaçš„æ–¹å¼æ¥ç›‘æ§ https://github.com/danielqsj/kafka_exporter</span></span><br><span class="line">  kafka_manager:</span><br><span class="line">    image: <span class="string">&#x27;hlebalbau/kafka-manager:latest&#x27;</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      ZK_HOSTS: <span class="string">&quot;zookeeper:2181&quot;</span></span><br><span class="line">      APPLICATION_SECRET: letmein</span><br><span class="line">    depends_on:</span><br><span class="line">      - zookeeper</span><br><span class="line">      - kafka</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹git-config"><a href="#æŸ¥çœ‹git-config" class="headerlink" title="æŸ¥çœ‹git config"></a>æŸ¥çœ‹git config</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰çš„é…ç½®ä»¥åŠå®ƒä»¬æ‰€åœ¨çš„æ–‡ä»¶ï¼š</span><br><span class="line"></span><br><span class="line">$ git config --list --show-origin</span><br></pre></td></tr></table></figure><h4 id="å¤‡ä»½hexo"><a href="#å¤‡ä»½hexo" class="headerlink" title="å¤‡ä»½hexo"></a>å¤‡ä»½hexo</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. å…ˆæ‹‰ä¸€ä¸ªæ–°çš„åˆ†æ”¯åšå¤‡ä»½ï¼Œæˆ‘è¿™é‡Œå«hexo</span><br><span class="line">2. ç”±äºhexoå…¶å®æäº¤åˆ°gitçš„æ˜¯.depoy.gitçš„ä¸œè¥¿ï¼Œblogä¸‹æ˜¯æ²¡æœ‰.gitçš„æ‰€ä»¥æˆ‘ä»¬å…ˆè¦åœ¨blog çš„æ ¹ç›®å½• æ‰§è¡Œ git init</span><br><span class="line">3. ç”±äºæ­¤æ—¶è¿˜æ²¡æœ‰å’Œè¿œç¨‹å…³è”èµ·æ¥ï¼Œæ‰€ä»¥è¦æ‰§è¡Œ </span><br><span class="line">git remote add origin git@github.com:hxq94/hxq94.github.io.git</span><br><span class="line">4. ç„¶åæ‰§è¡Œgit remote -v æŸ¥çœ‹æ˜¯å¦å·²ç»å…³è”</span><br><span class="line">5. ç„¶ågit fetch </span><br><span class="line">6. git checkout hexo</span><br><span class="line">5. ç„¶åæ‰§è¡Œgit add .</span><br><span class="line">6. å¯ä»¥ä½¿ç”¨git status æŸ¥çœ‹æ·»åŠ çš„æ–‡ä»¶</span><br><span class="line">7. ç„¶ågit commit -m &quot;init&quot;</span><br><span class="line">8. ç„¶ågit push -u origin hexo</span><br></pre></td></tr></table></figure><h4 id="æ¢å¤hexo"><a href="#æ¢å¤hexo" class="headerlink" title="æ¢å¤hexo"></a>æ¢å¤hexo</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. git clone &quot;git@github.com:hxq94/hxq94.github.io.git&quot;</span><br><span class="line">2. npm install hexo-cli</span><br><span class="line">3. npm install</span><br><span class="line">4. npm install hexo-deployer-git</span><br><span class="line">5. å’Œä¹‹å‰ä¸€æ · hexo clean  g  d</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»Šå¤©æ•´äº†ä¸‹ä»“åº“ï¼Œå’Œç”µè„‘ä¸Šçš„æ–‡ä»¶ï¼Œå‘ç°æœ‰å¾ˆå¤šæ˜¯é›¶æ•£çš„ï¼Œä¸æ˜¯å¤ªè§„æ•´ï¼ˆè™½ç„¶ä¹‹å‰ä¹Ÿä¸æ˜¯ä¹±æ”¾çš„ï¼‰ï¼Œä½†æ˜¯æ–‡ä»¶å¤šäº†å°±æœ‰ç‚¹ä¹±äº†ï¼Œä»Šå¤©æŠ½ç©ºæŠŠé¡¹ç›®æ•´ç†ä¸‹&lt;/p&gt;</summary>
    
    
    
    <category term="å¸¸ç”¨å‘½ä»¤" scheme="https://hxq94.github.io/categories/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    
    <category term="å¸¸ç”¨" scheme="https://hxq94.github.io/categories/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/%E5%B8%B8%E7%94%A8/"/>
    
    
    <category term="å¸¸ç”¨" scheme="https://hxq94.github.io/tags/%E5%B8%B8%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>netty</title>
    <link href="https://hxq94.github.io/2023/06/13/netty/"/>
    <id>https://hxq94.github.io/2023/06/13/netty/</id>
    <published>2023-06-13T14:22:35.022Z</published>
    <updated>2023-06-18T12:05:27.667Z</updated>
    
    <content type="html"><![CDATA[<p>nio è™½ç„¶ä½¿ç”¨äº†å¤šè·¯å¤ç”¨ï¼Œä½†æ˜¯çœŸæ­£å®ç°ä¸€ä¸ªç½‘ç»œç¼–ç¨‹è¿˜éœ€è¦è€ƒè™‘å¾ˆå¤šé—®é¢˜ï¼Œæ‰€ä»¥å‡ºç°äº†nettyè¿™ç§åŸºäºnioçš„ç½‘ç»œç¼–ç¨‹æ¡†æ¶ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬ç®€åŒ–å¼€å‘ç½‘ç»œç›¸å…³é—®é¢˜çš„éš¾åº¦ï¼Œnettyä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼æ¥æ¥æ”¶å„ç§äº‹ä»¶ï¼Œå¹¶æä¾›é“¾å¼pipelineçš„æ–¹å¼å¸®åŠ©æˆ‘ä»¬å¤„ç†æ•°æ®ï¼Œå¹¶ä¸”å¢å¼ºäº†nioçš„ByteBufferï¼Œè¿˜æä¾›äº†ä¸€ç³»åˆ—ä¾‹å¦‚å¿ƒè·³ã€å¼‚æ­¥ç­‰æ–¹å¼æ¥å¸®åŠ©æˆ‘ä»¬æ„å»ºä»£ç </p><span id="more"></span><h3 id="nettyæ¶æ„"><a href="#nettyæ¶æ„" class="headerlink" title="nettyæ¶æ„"></a>nettyæ¶æ„</h3><p>ä»ç½‘ä¸Šæ‰¾äº†ä¸¤å¼ å›¾ï¼Œnettyçš„æ€»ä½“æ¶æ„ï¼Œä»¥åŠnettyçš„çº¿ç¨‹æ¨¡å‹å¦‚ä¸‹</p><p><img src="/img/nio/0041.png"></p><p>è¿™å¼ å›¾è¡¨æ˜äº†nettyå¯ä»¥æœ‰å¤šä¸ªeventloopGroup æ¯ä¸ªeventLoopGroupä¸­åŒ…å«å¤šä¸ªeventLoopï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¼‚æ­¥æ‰§è¡Œä¸€äº›ioäº‹ä»¶ï¼Œå¹¶ä¸”è¿˜è¡¨æ˜nettyä¸­æœ‰å¤šæ¡æµæ°´çº¿ï¼Œå…¶ä¸­æ¯ä¸ªæµæ°´çº¿piplineéƒ½å¿…ç„¶æœ‰ä¸€ä¸ªheadå’Œtailçš„åŒå‘é“¾è¡¨æ¥å¯¹åº”å…¥ç«™å’Œå‡ºç«™ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå‡ºæˆ˜éœ€è¦ç¼–ç ï¼Œå…¥ç«™éœ€è¦è§£ç ï¼Œå¦‚æœpipelineä¸Šçš„äº‹ä»¶éœ€è¦å¤„ç†å¾ˆä¹…ï¼Œé‚£ä¹ˆå¯ä»¥äº¤ç»™é“¾ä¸Šçš„ä¸‹ä¸€ä¸ªå¤„ç†å™¨å¤„ç†ï¼Œä¹Ÿå¯ä»¥æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œï¼Œè¿™æ ·å˜ç›¸æé«˜äº†å¤„ç†é€Ÿåº¦<br><img src="/img/nio/nio_eventloop.png"></p><p>é€šè¿‡eventLoopå¯ä»¥æ‹¿åˆ°channelï¼Œè¿›è€Œå¤„ç†æˆ‘ä»¬çš„ioäº‹ä»¶</p><h3 id="ä¸Šä¸€ä¸ªæ —å­"><a href="#ä¸Šä¸€ä¸ªæ —å­" class="headerlink" title="ä¸Šä¸€ä¸ªæ —å­"></a>ä¸Šä¸€ä¸ªæ —å­</h3><h4 id="æœ€ç®€å•çš„nettyæœåŠ¡å™¨"><a href="#æœ€ç®€å•çš„nettyæœåŠ¡å™¨" class="headerlink" title="æœ€ç®€å•çš„nettyæœåŠ¡å™¨"></a>æœ€ç®€å•çš„nettyæœåŠ¡å™¨</h4><p>ä¸€ä¸ªç®€å•çš„nettyçš„ç½‘ç»œç¼–ç¨‹ğŸŒ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡å™¨ç«¯</span></span><br><span class="line"><span class="keyword">package</span> com.hyf.demo.netty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LogLevel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServerDemo</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯ä»¥ç»™æŸä¸ªhandleræŒ‡å®šç‰¹å®šçš„NioEventLoopGroup</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">defaultEventLoopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoopGroup</span>();</span><br><span class="line">        <span class="comment">//  çº¿ç¨‹æ•°é»˜è®¤æ˜¯è¿™ä¹ˆå¤š private static final int DEFAULT_EVENT_LOOP_THREADS = Math.max(1, SystemPropertyUtil.getInt(&quot;io.netty.eventLoopThreads&quot;, NettyRuntime.availableProcessors() * 2));</span></span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>()</span><br><span class="line">                <span class="comment">// ä¸€ä¸ªåªå¤„ç†accept äº‹ä»¶  ä¸€ä¸ªå¤„ç†å…¶ä»–äº‹ä»¶  acceptäº‹ä»¶çš„NioEventLoopGroupä¸ç®¡è®¾ç½®å‡ ï¼Œå…¶å®åˆ°æœ€åéƒ½æ˜¯1</span></span><br><span class="line">                .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>), <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>))</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                <span class="comment">// è¿™é‡Œæ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™SocketChannelçš„ è€Œä¸æ˜¯ç»™ServerSocketChannelçš„</span></span><br><span class="line">                .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel nioSocketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// åŠ ä¸ªæ—¥å¿—</span></span><br><span class="line">                        nioSocketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>());</span><br><span class="line">                        <span class="comment">// æ‹¿åˆ°pipeline è®¾ç½®è§£ç å™¨</span></span><br><span class="line"><span class="comment">//                        nioSocketChannel.pipeline().addLast(new StringDecoder());</span></span><br><span class="line">                        <span class="comment">// è¿™é‡Œä¸ºä»€ä¹ˆç”¨ChannelInboundHandlerAdapter è€Œä¸æ˜¯ChannelInboundHandler</span></span><br><span class="line">                        <span class="comment">// æ˜¯å› ä¸ºä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼ï¼Œå¯ä»¥æŒ‡å®šå“ªäº›æ–¹æ³•æˆ‘å¯ä»¥å®ç°ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶å®ç°</span></span><br><span class="line">                        <span class="comment">// è¿™é‡Œå¦‚æœæ–¹æ³•è¦å‘ä¸‹ä¼ é€’ å…¶å®å¯ä»¥ä½¿ç”¨ChannelInboundHandlerAdapter  å¦‚æœè¦ç›´æ¥é‡Šæ”¾ å¯ä»¥ä½¿ç”¨SimpleChannelInboundHandler</span></span><br><span class="line">                        nioSocketChannel.pipeline().addLast(<span class="string">&quot;handler1&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                                <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                                log.info(buf.toString(Charset.defaultCharset()));</span><br><span class="line">                                <span class="comment">// ä¼šå‘ä¸‹ä¸€ä¸ªhandlerä¼ é€’æ•°æ®  // ç°åœ¨ä½¿ç”¨çš„ChannelInboundHandlerAdapter æ‰€ä»¥éœ€è¦è°ƒç”¨è¿™ä¸€å¥ å¦‚æœæ˜¯SimpleChannelInboundHandlerå°±ä¸éœ€è¦äº†</span></span><br><span class="line">                                ctx.fireChannelRead(msg);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;).addLast(defaultEventLoopGroup, <span class="string">&quot;handler2&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext channelHandlerContext, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                                <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                                <span class="comment">// è¿™é‡Œæ‰“å‡ºçš„çº¿ç¨‹å’Œhandler1 æ‰“å‡ºæ¥çš„ä¸ä¸€æ ·</span></span><br><span class="line">                                log.info(buf.toString(Charset.defaultCharset()));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// ç»‘å®šæœåŠ¡ç«¯ç«¯å£</span></span><br><span class="line">                &#125;).bind(<span class="number">9999</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// èƒ½åœ¨å…³é—­ååšä¸€äº›å¤„ç†</span></span><br><span class="line">        channelFuture.channel().closeFuture().sync();</span><br><span class="line">        <span class="comment">// ç¡®ä¿æ˜¯åœ¨è¿æ¥å…³é—­åšçš„å¤„ç†</span></span><br><span class="line">        log.info(<span class="string">&quot;close do something...&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¼˜é›…å…³é—­ä¸€äº›eventLoopGroupä¸­çš„çº¿ç¨‹</span></span><br><span class="line">        defaultEventLoopGroup.shutdownGracefully();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// client </span></span><br><span class="line"><span class="keyword">package</span> com.hyf.demo.netty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyClientDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">eventExecutors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>().group(eventExecutors)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line">                             <span class="meta">@Override</span></span><br><span class="line">                             <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                                 channel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>());</span><br><span class="line">                                 channel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// å¼‚æ­¥éé˜»å¡</span></span><br><span class="line">                .connect(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>)</span><br><span class="line">                <span class="comment">// ç”±äºnettyä¸­éƒ½æ˜¯å¼‚æ­¥çš„ æ‰€ä»¥è¦syncç­‰å¾…</span></span><br><span class="line">                .sync()</span><br><span class="line">                <span class="comment">// è·å–æŠ½è±¡è¿‡åçš„channelé€šé“</span></span><br><span class="line">                .channel()</span><br><span class="line">                <span class="comment">// å†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº</span></span><br><span class="line">                .writeAndFlush(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// èƒ½åœ¨å…³é—­ååšä¸€äº›å¤„ç†</span></span><br><span class="line">        channelFuture.channel().closeFuture().sync();</span><br><span class="line">        <span class="comment">// ç¡®ä¿æ˜¯åœ¨è¿æ¥å…³é—­åšçš„å¤„ç†</span></span><br><span class="line">        log.info(<span class="string">&quot;close do something...&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¼˜é›…å…³é—­ä¸€äº›eventLoopGroupä¸­çš„çº¿ç¨‹</span></span><br><span class="line">        eventExecutors.shutdownGracefully();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„æœåŠ¡å™¨ã€å®¢æˆ·ç«¯ç¼–ç¨‹æ¨¡ç‰ˆä»£ç ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬çš„ä»£ç ä¹Ÿå°±æ˜¯æ ¹æ®è¿™ä¸ªæ¨¡ç‰ˆæ¥æ‰©å±•äº†ï¼Œä»–çš„å…·ä½“æµç¨‹å¦‚ä¸‹</p><h3 id="ä»£ç æµç¨‹å›¾"><a href="#ä»£ç æµç¨‹å›¾" class="headerlink" title="ä»£ç æµç¨‹å›¾"></a>ä»£ç æµç¨‹å›¾</h3><p><img src="/img/nio/netty_liuchen.png"></p><p>ä»¥ä¸Šæµç¨‹è¯´æ˜äº†ä»¥ä¸‹å‡ ç‚¹</p><ol><li>nettyæ˜¯å¼‚æ­¥çš„ï¼Œå¯ä»¥åˆ†é…workGroup çº¿ç¨‹æ±  å’Œ boosGroupçº¿ç¨‹æ± ï¼Œå¯åŠ¨æ˜¯é€šè¿‡BootStrapæ¥å¯åŠ¨çš„</li><li>NioEventLoopGroup æä¾›äº†nextæ¥å£ï¼Œå¯ä»¥æŒ‰ç…§è´Ÿè½½å‡è¡¡ç­–ç•¥æ¥æŒ‡å®šå“ªä¸ªNioEventLoopæ¥å·¥ä½œ</li></ol><ul><li>å› ä¸ºå®ç°äº†ScheduledExecutorService æ‰€ä»¥å¯ä»¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€æ™®é€šä»»åŠ¡ ä»¥åŠIoäº‹ä»¶çš„å¤„ç† ä½†æ˜¯DefaultEventLoopGroupå¤„ç†ä¸äº†IOäº‹ä»¶</li></ul><ol start="3"><li>æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“</li><li>æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf</li><li> æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº</li></ol><ul><li>å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆâ€¦ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰</li><li>handler åˆ† Inbound å’Œ Outbound ä¸¤ç±»</li><li>æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº<ul><li>å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰</li><li>å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡</li><li>å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº</li></ul></li></ul><h3 id="ByteBuf"><a href="#ByteBuf" class="headerlink" title="ByteBuf"></a>ByteBuf</h3><blockquote><p>ByteBufæ˜¯nettyåœ¨nio ByteBufferä¸Šåšçš„å¢å¼º</p></blockquote><p>é’ˆå¯¹äºByteBuf æœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„</p><ol><li>ByteBufå¯ä»¥å¼€è¾Ÿç›´æ¥å†…å­˜  ä¹Ÿå¯ä»¥å¼€è¾Ÿå †å†…å­˜ ç›´æ¥å†…å­˜éœ€è¦æ‰‹åŠ¨ç®¡ç†é‡Šæ”¾</li><li>ByteBufå…·å¤‡æ± åŒ–å’Œéæ± åŒ–èƒ½åŠ› æ± åŒ–æé«˜å·¥ä½œæ•ˆç‡ï¼Œä½†æ˜¯å¤æ‚åº¦å˜é«˜</li><li>å¯ä»¥ä½¿ç”¨sliceåˆ‡ç‰‡  æ¥æ¨¡æ‹ŸåŠåŒ…ç°è±¡</li><li>ä»–æœ‰å¾ˆå¤šå’Œé›¶æ‹·è´ç›¸å…³çš„ç±»ï¼Œæ¯”å¦‚copy\duplicate\sliceç­‰</li></ol><h3 id="ç²˜åŒ…åŠåŒ…ç°è±¡åŸå› "><a href="#ç²˜åŒ…åŠåŒ…ç°è±¡åŸå› " class="headerlink" title="ç²˜åŒ…åŠåŒ…ç°è±¡åŸå› "></a>ç²˜åŒ…åŠåŒ…ç°è±¡åŸå› </h3><p>ç²˜åŒ…åŠåŒ…å‡ºç°çš„åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹</p><ol><li>åº”ç”¨å±‚æœ‰æ¥æ”¶å’Œå‘é€ç¼“å†²åŒºé™åˆ¶</li><li>ä¼ è¾“å±‚æœ‰æ»‘åŠ¨çª—å£æœºåˆ¶</li><li>ç½‘ç»œå±‚æœ‰MTU MCCé™åˆ¶</li></ol><h3 id="ç²˜åŒ…åŠåŒ…è§£å†³æ–¹æ¡ˆ"><a href="#ç²˜åŒ…åŠåŒ…è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ç²˜åŒ…åŠåŒ…è§£å†³æ–¹æ¡ˆ"></a>ç²˜åŒ…åŠåŒ…è§£å†³æ–¹æ¡ˆ</h3><p>åœ¨nettyä¸­æœ‰ä»¥ä¸‹å‡ ç§è§£å†³æ–¹æ¡ˆ</p><ol><li>çŸ­è¿æ¥ æ¯æ¬¡å‘é€å®Œæ•°æ®å°±æ–­å¼€è¿æ¥ å¯ä»¥è§£å†³ç²˜åŒ…é—®é¢˜ è§£å†³ä¸äº†åŠåŒ…é—®é¢˜</li><li>nettyæä¾›çš„å®šé•¿è§£ç å™¨ ï¼Œå¯ä»¥è§£å†³é—®é¢˜ ä½†æ˜¯æµªè´¹ç©ºé—´</li><li>åˆ†éš”ç¬¦è§£ç å™¨ ï¼Œå¯ä»¥è§£å†³é—®é¢˜ ä½†æ˜¯æ•ˆç‡ä½ éœ€è¦æ‰¾åˆ°åˆ†éš”ç¬¦</li><li>å¸§è§£ç å™¨:<em>LengthFieldBasedFrameDecoder</em> è¿™ä¸ªè§£ç å™¨æä¾›çš„å‚æ•°è§£é‡Šå¦‚ä¸‹</li></ol><ul><li>maxFrameLength è¶…è¿‡è¿™ä¸ªé•¿åº¦äº†è¿˜æ²¡å®Œ å°±æŠ¥é”™</li><li>lengthFieldOffset é•¿åº¦å­—æ®µåç§»é‡ï¼ˆå°±æ˜¯ä»£è¡¨å®é™…å†…å®¹æœ‰å¤šé•¿çš„çš„é•¿åº¦å­—æ®µæ˜¯ä»ç¬¬å‡ ä¸ªå­—èŠ‚å¼€å§‹çš„ï¼‰</li><li>lengthFieldLength ç”¨æ¥è®°å½•å†…å®¹é•¿åº¦çš„å­—æ®µçš„å®é™…å­—èŠ‚æ˜¯å¤šå°‘</li><li>lengthAdjustment é•¿åº¦å­—æ®µä¸ºåŸºå‡† è¿˜æœ‰å‡ ä¸ªå­—æ®µæ˜¯å†…å®¹</li><li>initialBytesToStrip ä»å¤´å‰¥ç¦»å‡ ä¸ªå­—èŠ‚ï¼ˆç›¸å½“äºåœ¨æœ€ç»ˆçš„ç»“æœæ˜¯æ²¡æœ‰å‰¥ç¦»çš„é‚£å‡ ä¸ªå­—èŠ‚çš„ï¼‰</li></ul><h3 id="è‡ªå®šä¹‰httpåè®®çš„ä¸€ä¸ªä¾‹å­"><a href="#è‡ªå®šä¹‰httpåè®®çš„ä¸€ä¸ªä¾‹å­" class="headerlink" title="è‡ªå®šä¹‰httpåè®®çš„ä¸€ä¸ªä¾‹å­"></a>è‡ªå®šä¹‰httpåè®®çš„ä¸€ä¸ªä¾‹å­</h3> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">NioEventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"><span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">    serverBootstrap.group(boss, worker);</span><br><span class="line">    serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>());</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;HttpRequest&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, HttpRequest msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    <span class="comment">// è·å–è¯·æ±‚</span></span><br><span class="line">                    log.debug(msg.uri());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è¿”å›å“åº”</span></span><br><span class="line">                    <span class="type">DefaultFullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span></span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(msg.protocolVersion(), HttpResponseStatus.OK);</span><br><span class="line"></span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="string">&quot;&lt;h1&gt;Hello, world!&lt;/h1&gt;&quot;</span>.getBytes();</span><br><span class="line"></span><br><span class="line">                    response.headers().setInt(CONTENT_LENGTH, bytes.length);</span><br><span class="line">                    response.content().writeBytes(bytes);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å†™å›å“åº”</span></span><br><span class="line">                    ctx.writeAndFlush(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">/*ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;</span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;</span></span><br><span class="line"><span class="comment">                    log.debug(&quot;&#123;&#125;&quot;, msg.getClass());</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    if (msg instanceof HttpRequest) &#123; // è¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    &#125; else if (msg instanceof HttpContent) &#123; //è¯·æ±‚ä½“</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;);*/</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8080</span>).sync();</span><br><span class="line">    channelFuture.channel().closeFuture().sync();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;server error&quot;</span>, e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    boss.shutdownGracefully();</span><br><span class="line">    worker.shutdownGracefully();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œåè®¿é—®æµè§ˆå™¨ lcoalhost:8080 æµè§ˆå™¨æ‰“å‡ºhello word</p><h3 id="è‡ªå®šä¹‰åè®®çš„ä¾‹å­"><a href="#è‡ªå®šä¹‰åè®®çš„ä¾‹å­" class="headerlink" title="è‡ªå®šä¹‰åè®®çš„ä¾‹å­"></a>è‡ªå®šä¹‰åè®®çš„ä¾‹å­</h3><p>è‡ªå®šä¹‰åè®®éœ€è¦æ»¡è¶³ä»¥ä¸‹è¦æ±‚</p><ul><li>é­”æ•°ï¼Œç”¨æ¥åœ¨ç¬¬ä¸€æ—¶é—´åˆ¤å®šæ˜¯å¦æ˜¯æ— æ•ˆæ•°æ®åŒ…</li><li>ç‰ˆæœ¬å·ï¼Œå¯ä»¥æ”¯æŒåè®®çš„å‡çº§</li><li>åºåˆ—åŒ–ç®—æ³•ï¼Œæ¶ˆæ¯æ­£æ–‡åˆ°åº•é‡‡ç”¨å“ªç§åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹å¼ï¼Œå¯ä»¥ç”±æ­¤æ‰©å±•ï¼Œä¾‹å¦‚ï¼šjsonã€protobufã€hessianã€jdk</li><li>æŒ‡ä»¤ç±»å‹ï¼Œæ˜¯ç™»å½•ã€æ³¨å†Œã€å•èŠã€ç¾¤èŠâ€¦ è·Ÿä¸šåŠ¡ç›¸å…³</li><li>è¯·æ±‚åºå·ï¼Œä¸ºäº†åŒå·¥é€šä¿¡ï¼Œæä¾›å¼‚æ­¥èƒ½åŠ›</li><li>æ­£æ–‡é•¿åº¦</li><li>æ¶ˆæ¯æ­£æ–‡</li></ul><p>ä¸€ä¸ªğŸŒ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.netty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBufAllocator;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.ByteToMessageCodec;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.MessageToMessageCodec;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageCodecSharable</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageCodec</span>&lt;ByteBuf, Message&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Message msg, List&lt;Object&gt; outList)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// å°†msgå†…å®¹ å†™å…¥nettyå¸®åŠ©æˆ‘ä»¬åˆ›å»ºçš„Bytebufä¸­</span></span><br><span class="line"><span class="comment">//        ByteBuf out = ctx.alloc().buffer();</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">out</span>  <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// 1. 4 å­—èŠ‚çš„é­”æ•°</span></span><br><span class="line">        out.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">        <span class="comment">// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,</span></span><br><span class="line">        out.writeByte(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1</span></span><br><span class="line">        out.writeByte(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹</span></span><br><span class="line">        out.writeByte(msg.getMessageType());</span><br><span class="line">        <span class="comment">// 5. 4 ä¸ªå­—èŠ‚</span></span><br><span class="line">        out.writeInt(msg.getSequenceId());</span><br><span class="line">        <span class="comment">// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……</span></span><br><span class="line">        out.writeByte(<span class="number">0xff</span>);</span><br><span class="line">        <span class="comment">// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(msg);</span><br><span class="line">        <span class="type">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line">        <span class="comment">// 7. é•¿åº¦</span></span><br><span class="line">        out.writeInt(bytes.length);</span><br><span class="line">        <span class="comment">// 8. å†™å…¥å†…å®¹</span></span><br><span class="line">        out.writeBytes(bytes);</span><br><span class="line">        outList.add(out);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">magicNum</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">serializerType</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sequenceId</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        in.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        in.readBytes(bytes, <span class="number">0</span>, length);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> (Message) ois.readObject();</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, magicNum, version, serializerType, messageType, sequenceId, length);</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, message);</span><br><span class="line">        <span class="comment">// ä¸ºäº†ç»™ä¸‹ä¸€ä¸ªhandlerä½¿ç”¨</span></span><br><span class="line">        out.add(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ç±»</span></span><br><span class="line"><span class="keyword">package</span> com.hyf.demo.netty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBufAllocator;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.embedded.EmbeddedChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">EmbeddedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddedChannel</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(),</span><br><span class="line"><span class="comment">//                new LengthFieldBasedFrameDecoder(</span></span><br><span class="line"><span class="comment">//                        1024, 12, 4, 0, 0),</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">MessageCodecSharable</span>()</span><br><span class="line">        );</span><br><span class="line"><span class="comment">// encode</span></span><br><span class="line"><span class="comment">//        Message message = new Message(&quot;zhangsan&quot;, &quot;123&quot;);</span></span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        channel.writeOutbound(message);</span></span><br><span class="line"><span class="comment">// decode</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">        List&lt;Object&gt; messageList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MessageCodecSharable</span>().encode(<span class="literal">null</span>, message, messageList);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        System.out.println(messageList);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        channel.writeInbound(convertListToByteBuf(messageList));</span><br><span class="line"><span class="comment">//        ByteBuf s1 = buf.slice(0, 100);</span></span><br><span class="line"><span class="comment">//        ByteBuf s2 = buf.slice(100, buf.readableBytes() - 100);</span></span><br><span class="line"><span class="comment">//        s1.retain(); // å¼•ç”¨è®¡æ•° 2</span></span><br><span class="line"><span class="comment">//        channel.writeInbound(s1); // release 1</span></span><br><span class="line"><span class="comment">//        channel.writeInbound(s2);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ByteBuf <span class="title function_">convertListToByteBuf</span><span class="params">(List&lt;Object&gt; list)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ByteBuf</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> Unpooled.buffer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„è¾“å‡ºæµ</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºObjectMapperå¯¹è±¡</span></span><br><span class="line">            <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°†åˆ—è¡¨è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">            <span class="type">byte</span>[] byteArray = objectMapper.writeValueAsBytes(list);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°†å­—èŠ‚æ•°ç»„è¾“å‡ºæµçš„å†…å®¹å†™å…¥ByteBuf</span></span><br><span class="line">            byteBuf.writeBytes(byteArrayOutputStream.toByteArray());</span><br><span class="line"></span><br><span class="line">            byteBuf.writeBytes(byteArray);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> byteBuf;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;nio è™½ç„¶ä½¿ç”¨äº†å¤šè·¯å¤ç”¨ï¼Œä½†æ˜¯çœŸæ­£å®ç°ä¸€ä¸ªç½‘ç»œç¼–ç¨‹è¿˜éœ€è¦è€ƒè™‘å¾ˆå¤šé—®é¢˜ï¼Œæ‰€ä»¥å‡ºç°äº†nettyè¿™ç§åŸºäºnioçš„ç½‘ç»œç¼–ç¨‹æ¡†æ¶ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬ç®€åŒ–å¼€å‘ç½‘ç»œç›¸å…³é—®é¢˜çš„éš¾åº¦ï¼Œnettyä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼æ¥æ¥æ”¶å„ç§äº‹ä»¶ï¼Œå¹¶æä¾›é“¾å¼pipelineçš„æ–¹å¼å¸®åŠ©æˆ‘ä»¬å¤„ç†æ•°æ®ï¼Œå¹¶ä¸”å¢å¼ºäº†nioçš„ByteBufferï¼Œè¿˜æä¾›äº†ä¸€ç³»åˆ—ä¾‹å¦‚å¿ƒè·³ã€å¼‚æ­¥ç­‰æ–¹å¼æ¥å¸®åŠ©æˆ‘ä»¬æ„å»ºä»£ç &lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="https://hxq94.github.io/categories/java/"/>
    
    <category term="ç½‘ç»œç¼–ç¨‹" scheme="https://hxq94.github.io/categories/java/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="ç½‘ç»œç¼–ç¨‹" scheme="https://hxq94.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>NIO</title>
    <link href="https://hxq94.github.io/2023/05/08/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    <id>https://hxq94.github.io/2023/05/08/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/</id>
    <published>2023-05-08T12:27:38.788Z</published>
    <updated>2023-06-13T14:22:32.466Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡è¯´è¿‡äº†åŸºç¡€IOæµçš„æ“ä½œï¼Œè¿™ç¯‡ç®€å•è¯´ä¸€ä¸‹ç½‘ç»œç¼–ç¨‹ï¼Œç½‘ç»œç¼–ç¨‹å°±æˆ‘è‡ªå·±ç†è§£å°±æ˜¯åœ¨ç½‘ç»œä¸–ç•Œä¸­è¿›è¡Œæ•°æ®çš„äº’ç›¸ä¼ é€’ï¼Œå®ƒåŸºäºOSIä¸ƒå±‚æ¨¡å‹ï¼Œè¿›è¡Œå±‚å±‚å°è£…ï¼Œæ¥å°†æ•°æ®æœ€ç»ˆå°è£…æˆäº†ä¸€ä¸ªä¸ªæ•°æ®åŒ…ï¼Œç„¶åå‘å¾€å¦å¤–ä¸€ç«¯ï¼Œè¿™ç¯‡æš‚æ—¶ä¸è¯´TCPã€UDPä»¥åŠsocketé€šä¿¡çš„å…¶å®ƒåè®®ï¼Œè¿™ç¯‡åªè¯´ä¸€ä¸‹è·ŸIOç›¸å…³çš„ç½‘ç»œç¼–ç¨‹</p><span id="more"></span><h3 id="ç›´æ¥ä¸Šæ —å­"><a href="#ç›´æ¥ä¸Šæ —å­" class="headerlink" title="ç›´æ¥ä¸Šæ —å­"></a>ç›´æ¥ä¸Šæ —å­</h3><h4 id="æœ€ç®€å•çš„IO"><a href="#æœ€ç®€å•çš„IO" class="headerlink" title="æœ€ç®€å•çš„IO"></a>æœ€ç®€å•çš„IO</h4><p>ä¸€ä¸ªç®€å•çš„åŸºäºIOçš„ç½‘ç»œç¼–ç¨‹ğŸŒ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Server</span></span><br><span class="line"><span class="keyword">package</span> com.hyf.demo.bio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºè¿æ¥</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>();</span><br><span class="line">            <span class="type">SocketAddress</span> <span class="variable">socketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>);</span><br><span class="line">            serverSocket.bind(socketAddress);</span><br><span class="line">            System.out.println(<span class="string">&quot;ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥&quot;</span>);</span><br><span class="line">            <span class="comment">// 1.è¿™é‡Œä¼šç­‰å¾…å®¢æˆ·ç«¯è¿æ¥é˜»å¡</span></span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¯»å–socketè¾“å…¥æµä¸­çš„æ•°æ®</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line"></span><br><span class="line">            String msg;</span><br><span class="line">            <span class="comment">// 2. è¿™é‡Œä¼šé˜»å¡ç­‰å¾…å®¢æˆ·ç«¯æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">while</span> ((msg = inputStream.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(msg);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client</span></span><br><span class="line"><span class="keyword">package</span> com.hyf.demo.bio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºsocket</span></span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>();</span><br><span class="line">        <span class="type">SocketAddress</span> <span class="variable">socketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket.connect(socketAddress);</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿æ¥æœåŠ¡ç«¯æˆåŠŸ&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(System.in));</span><br><span class="line"></span><br><span class="line">            String msg;</span><br><span class="line">            <span class="comment">// è¿™é‡Œä¼šç­‰å¾…æ§åˆ¶å°è¾“å…¥ é˜»å¡</span></span><br><span class="line">            <span class="keyword">while</span> ((msg = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">                <span class="comment">// ä½¿ç”¨äº†readline éœ€è¦åŠ å…¥\n \rç­‰ ä¸ç„¶ä¸ç®—ä¸€è¡Œ</span></span><br><span class="line">                outputStream.write((msg+<span class="string">&quot;\n&quot;</span>).getBytes());</span><br><span class="line">                outputStream.flush();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å­˜åœ¨çš„é—®é¢˜"><a href="#å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="å­˜åœ¨çš„é—®é¢˜"></a>å­˜åœ¨çš„é—®é¢˜</h3><p>ä¸Šé¢çš„ä»£ç è¿è¡Œèµ·æ¥åï¼Œå¯ä»¥åœ¨æ§åˆ¶å°è¿›è¡ŒåŸºæœ¬çš„ç®€å•çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„é€šè®¯ï¼Œä½†æ˜¯ä¸Šé¢çš„ä»£ç æœ‰å‡ ä¸ªé—®é¢˜</p><ol><li>åªèƒ½æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥</li><li>æœåŠ¡ç«¯ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥åªèƒ½é˜»å¡ç­‰å¾…</li></ol><h3 id="è§£å†³åªèƒ½æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥"><a href="#è§£å†³åªèƒ½æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥" class="headerlink" title="è§£å†³åªèƒ½æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥"></a>è§£å†³åªèƒ½æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥</h3><blockquote><p>è§£å†³åªèƒ½æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥</p></blockquote><p>ç›´æ¥ä¸Šä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">Server</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.hyf.demo.bio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingDeque;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å­˜å‚¨socketçš„list è¿™é‡Œæ¶‰åŠåˆ°å¤šçº¿ç¨‹ç¼–ç¨‹ æ‰€ä»¥å¯ä»¥ä½¿ç”¨å¸¦é”çš„list ä½†æ˜¯è¿™é‡Œdemoçš„è¯ è‡ªå·±ä½¿ç”¨synchronizedä»£ç å»å†™</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œå¯ä»¥ä½¿ç”¨CopyOnWriteArrayList ä½†æ˜¯CopyOnWriteArrayList è¿­ä»£åˆ é™¤çš„æ—¶å€™ä¼šæœ‰é—®é¢˜</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥å¯ä»¥ä½¿ç”¨Collections.synchronizedList(new ArrayList&lt;&gt;());</span></span><br><span class="line">        List&lt;Socket&gt; socketList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">5</span>, <span class="number">10</span>,</span><br><span class="line">                <span class="number">60L</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingDeque</span>&lt;&gt;(<span class="number">5</span>), <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">                <span class="keyword">return</span> thread;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardOldestPolicy());</span><br><span class="line">        <span class="comment">// åˆ›å»ºè¿æ¥</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>();</span><br><span class="line">            <span class="type">SocketAddress</span> <span class="variable">socketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>);</span><br><span class="line">            serverSocket.bind(socketAddress);</span><br><span class="line">            System.out.println(<span class="string">&quot;ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¼€å¯ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨å¤„ç†å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">                        socketList.add(socket);</span><br><span class="line">                        System.out.println(<span class="string">&quot;æ–°åŠ å…¥ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç«¯å£ &quot;</span> + socket.getPort());</span><br><span class="line">                        TimeUnit.MILLISECONDS.sleep(<span class="number">200</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1.è¿™é‡Œä¼šç­‰å¾…å®¢æˆ·ç«¯è¿æ¥é˜»å¡</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (Server.class) &#123;</span><br><span class="line">                    <span class="comment">// éå†socketList</span></span><br><span class="line">                    Iterator&lt;Socket&gt; iterator = socketList.iterator();</span><br><span class="line">                    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                        iterator.remove();</span><br><span class="line">                        <span class="comment">// è¯»å–socketè¾“å…¥æµä¸­çš„æ•°æ®</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 2. è¿™é‡Œä¼šé˜»å¡ç­‰å¾…å®¢æˆ·ç«¯æ¶ˆæ¯</span></span><br><span class="line">                        threadPoolExecutor.execute(() -&gt; &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="type">BufferedReader</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line">                                String msg;</span><br><span class="line">                                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (((msg = inputStream.readLine()) != <span class="literal">null</span>)) &#123;</span><br><span class="line">                                        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; ç«¯å£ &quot;</span> + socket.getPort() + <span class="string">&quot; &quot;</span> + msg);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client</span></span><br><span class="line"><span class="keyword">package</span> com.hyf.demo.bio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºsocket</span></span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>();</span><br><span class="line">        <span class="type">SocketAddress</span> <span class="variable">socketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket.connect(socketAddress);</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿æ¥æœåŠ¡ç«¯æˆåŠŸ&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(System.in));</span><br><span class="line"></span><br><span class="line">            String msg;</span><br><span class="line">            <span class="comment">// è¿™é‡Œä¼šç­‰å¾…æ§åˆ¶å°è¾“å…¥ é˜»å¡</span></span><br><span class="line">            <span class="keyword">while</span> ((msg = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">                <span class="comment">// ä½¿ç”¨äº†readline éœ€è¦åŠ å…¥\n \rç­‰ ä¸ç„¶ä¸ç®—ä¸€è¡Œ</span></span><br><span class="line">                outputStream.write((msg+<span class="string">&quot;\n&quot;</span>).getBytes());</span><br><span class="line">                outputStream.flush();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serverè¾“å‡ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span><br><span class="line">æ–°åŠ å…¥ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç«¯å£ 54968</span><br><span class="line">æ–°åŠ å…¥ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç«¯å£ 54972</span><br><span class="line">Thread-1 ç«¯å£ 54968 æˆ‘æ˜¯å®¢æˆ·ç«¯1</span><br><span class="line">Thread-2 ç«¯å£ 54972 æˆ‘æ˜¯å®¢æˆ·ç«¯2</span><br></pre></td></tr></table></figure><p>clientè¾“å‡ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¿æ¥æœåŠ¡ç«¯æˆåŠŸ</span><br><span class="line">æˆ‘æ˜¯å®¢æˆ·ç«¯1</span><br></pre></td></tr></table></figure><h4 id="è§£å†³ç¬¬äºŒä¸ªé—®é¢˜"><a href="#è§£å†³ç¬¬äºŒä¸ªé—®é¢˜" class="headerlink" title="è§£å†³ç¬¬äºŒä¸ªé—®é¢˜"></a>è§£å†³ç¬¬äºŒä¸ªé—®é¢˜</h4><blockquote><p>æœåŠ¡ç«¯åªèƒ½é˜»å¡ç­‰å¾…</p></blockquote><p>è¿™ä¸ªé—®é¢˜å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯BIOï¼Œæ‰€ä»¥åªèƒ½é˜»å¡ç­‰å¾…ï¼Œé å¼€å¤šä¸ªçº¿ç¨‹å»è¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿåªèƒ½åº”å¯¹è¿æ¥æ•°æ¯”è¾ƒå°‘çš„æƒ…æ™¯ï¼Œå¦‚æœè¿æ¥æ•°ä¸€æ—¦ä¸Šæ¥ï¼Œé‚£ä¹ˆä¸€ç›´å¼€çº¿ç¨‹ä¹Ÿæ˜¯ä¸€ç¬”å¾ˆå¤§çš„å¼€é”€ï¼Œæ‰€ä»¥æ‰æœ‰äº†NIOè¿™æ ·çš„çš„éé˜»å¡IOæ¥è§£å†³è¿™ä¸ªé—®é¢˜</p><h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h3><p>NIOå’Œ IOçš„åŒºåˆ« é˜»å¡çš„ IO ä¼šé˜»å¡åœ¨ IO æ“ä½œä¸Š, NIO é˜»å¡åœ¨äº‹ä»¶è·å–ä¸Š</p><p>NIOè§£å†³çš„é—®é¢˜</p><ol><li>å·¥ä½œåœ¨éé˜»å¡çº¿ç¨‹ä¸Šï¼Œçº¿ç¨‹åˆ©ç”¨ç‡æé«˜</li><li>é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šçš„åœºæ™¯ï¼Œä½†æ˜¯æµé‡è¾ƒå°‘</li></ol><h3 id="å¸¸ç”¨ä»£ç ä»‹ç»"><a href="#å¸¸ç”¨ä»£ç ä»‹ç»" class="headerlink" title="å¸¸ç”¨ä»£ç ä»‹ç»"></a>å¸¸ç”¨ä»£ç ä»‹ç»</h3><p>å¸¸ç”¨çš„ä¸€ä¸ªbytebufferä»£ç ç®€å•ä»‹ç»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelDemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">&quot;data.txt&quot;</span>, <span class="string">&quot;rw&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> file.getChannel();</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="comment">// å‘ buffer å†™å…¥</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> channel.read(buffer);</span><br><span class="line">                log.debug(<span class="string">&quot;è¯»åˆ°å­—èŠ‚æ•°ï¼š&#123;&#125;&quot;</span>, len);</span><br><span class="line">                <span class="keyword">if</span> (len == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ‡æ¢ buffer è¯»æ¨¡å¼</span></span><br><span class="line">                buffer.flip();</span><br><span class="line">                <span class="keyword">while</span>(buffer.hasRemaining()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, (<span class="type">char</span>)buffer.get());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ‡æ¢ buffer å†™æ¨¡å¼ </span></span><br><span class="line">                <span class="comment">// è¿˜æœ‰ä¸€ç§ compactæ¨¡å¼ æ˜¯æŠŠæœªè¯»çš„éƒ¨åˆ†å‹ç¼©åˆ°å‰è¾¹ ç„¶ååˆ‡æ¢åˆ°å†™æ¨¡å¼</span></span><br><span class="line">                buffer.clear();</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é˜»å¡å’Œéé˜»å¡-nioä»£ç ä¾‹å­"><a href="#é˜»å¡å’Œéé˜»å¡-nioä»£ç ä¾‹å­" class="headerlink" title="é˜»å¡å’Œéé˜»å¡ nioä»£ç ä¾‹å­"></a>é˜»å¡å’Œéé˜»å¡ nioä»£ç ä¾‹å­</h3><p>é˜»å¡å’Œéé˜»å¡nioåŸºç¡€æœåŠ¡ç«¯ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.hyf.demo.nio.ByteBufferUtil.debugAll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NioSocketChannel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®¾ç½®ä¸ºéé˜»å¡</span></span><br><span class="line">            serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9999</span>));</span><br><span class="line"></span><br><span class="line">            List&lt;SocketChannel&gt; channelsList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯é˜»å¡æ¨¡å¼ è¿™é‡Œä¼šé˜»å¡</span></span><br><span class="line">                <span class="type">SocketChannel</span> <span class="variable">accept</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">                <span class="keyword">if</span> (accept != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// è®¾ç½®ä¸ºéé˜»å¡</span></span><br><span class="line">                    accept.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                    channelsList.add(accept);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (SocketChannel socketChannel : channelsList) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ˜¯é˜»å¡æ¨¡å¼ è¿™é‡Œä¹Ÿä¼šé˜»å¡</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> socketChannel.read(byteBuffer);</span><br><span class="line">                    <span class="keyword">if</span> (read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        byteBuffer.flip();</span><br><span class="line">                        debugAll(byteBuffer);</span><br><span class="line">                        byteBuffer.clear();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç çš„å¥½å¤„æ˜¯ è®¾ç½®ä¸ºéé˜»å¡åï¼Œæˆ‘ä»¬çš„å®¢æˆ·ç«¯è¿æ¥å°±ä¸ä¼šé˜»å¡ï¼Œè¯»å–ä¹Ÿä¸ä¼šé˜»å¡äº†ï¼Œä½†æ˜¯è¿™æ ·æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä¼šæ¶ˆè€—å¤§é‡cpuï¼ˆcpuç©ºè½¬ã€åˆ©ç”¨ç‡å¤ªé«˜ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨selectoræ¨¡å¼ï¼Œä½¿ç”¨selectoræ¥ç®¡ç†channelï¼Œä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†selector</p><h3 id="selecor-çš„å››ç§äº‹ä»¶"><a href="#selecor-çš„å››ç§äº‹ä»¶" class="headerlink" title="selecor çš„å››ç§äº‹ä»¶"></a>selecor çš„å››ç§äº‹ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Operation-set bit for read operations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Suppose that a selection key&#x27;s interest set contains</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;OP_READ&lt;/tt&gt; at the start of a &lt;a</span></span><br><span class="line"><span class="comment">     * href=&quot;Selector.html#selop&quot;&gt;selection operation&lt;/a&gt;.  If the selector</span></span><br><span class="line"><span class="comment">     * detects that the corresponding channel is ready for reading, has reached</span></span><br><span class="line"><span class="comment">     * end-of-stream, has been remotely shut down for further reading, or has</span></span><br><span class="line"><span class="comment">     * an error pending, then it will add &lt;tt&gt;OP_READ&lt;/tt&gt; to the key&#x27;s</span></span><br><span class="line"><span class="comment">     * ready-operation set and add the key to its selected-key&amp;nbsp;set.  &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_READ</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Operation-set bit for write operations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Suppose that a selection key&#x27;s interest set contains</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;OP_WRITE&lt;/tt&gt; at the start of a &lt;a</span></span><br><span class="line"><span class="comment">     * href=&quot;Selector.html#selop&quot;&gt;selection operation&lt;/a&gt;.  If the selector</span></span><br><span class="line"><span class="comment">     * detects that the corresponding channel is ready for writing, has been</span></span><br><span class="line"><span class="comment">     * remotely shut down for further writing, or has an error pending, then it</span></span><br><span class="line"><span class="comment">     * will add &lt;tt&gt;OP_WRITE&lt;/tt&gt; to the key&#x27;s ready set and add the key to its</span></span><br><span class="line"><span class="comment">     * selected-key&amp;nbsp;set.  &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_WRITE</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Operation-set bit for socket-connect operations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Suppose that a selection key&#x27;s interest set contains</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;OP_CONNECT&lt;/tt&gt; at the start of a &lt;a</span></span><br><span class="line"><span class="comment">     * href=&quot;Selector.html#selop&quot;&gt;selection operation&lt;/a&gt;.  If the selector</span></span><br><span class="line"><span class="comment">     * detects that the corresponding socket channel is ready to complete its</span></span><br><span class="line"><span class="comment">     * connection sequence, or has an error pending, then it will add</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;OP_CONNECT&lt;/tt&gt; to the key&#x27;s ready set and add the key to its</span></span><br><span class="line"><span class="comment">     * selected-key&amp;nbsp;set.  &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_CONNECT</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Operation-set bit for socket-accept operations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Suppose that a selection key&#x27;s interest set contains</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;OP_ACCEPT&lt;/tt&gt; at the start of a &lt;a</span></span><br><span class="line"><span class="comment">     * href=&quot;Selector.html#selop&quot;&gt;selection operation&lt;/a&gt;.  If the selector</span></span><br><span class="line"><span class="comment">     * detects that the corresponding server-socket channel is ready to accept</span></span><br><span class="line"><span class="comment">     * another connection, or has an error pending, then it will add</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;OP_ACCEPT&lt;/tt&gt; to the key&#x27;s ready set and add the key to its</span></span><br><span class="line"><span class="comment">     * selected-key&amp;nbsp;set.  &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_ACCEPT</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br><span class="line">```   </span><br><span class="line">### ä½¿ç”¨selector å¤„ç†nioæ¶ˆæ¯</span><br><span class="line">ä¸‹é¢çš„è¿™ä¸ªä¾‹å­æ˜¯ä½¿ç”¨selectorå¤„ç† nioæ¶ˆæ¯çš„</span><br><span class="line">```java</span><br><span class="line"><span class="keyword">package</span> com.hyf.demo.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.CharBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.CharacterCodingException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.CharsetDecoder;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.hyf.demo.nio.ByteBufferUtil.debugAll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NioSelectorSocketChannel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å»ºç«‹selector</span></span><br><span class="line">            <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line"></span><br><span class="line">            <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">            serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            <span class="comment">// ç»‘å®šserverSocketChannel</span></span><br><span class="line">            <span class="type">SelectionKey</span> <span class="variable">selectionKey</span> <span class="operator">=</span> serverSocketChannel.register(selector, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶</span></span><br><span class="line">            selectionKey.interestOps(SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®¾ç½®ä¸ºéé˜»å¡</span></span><br><span class="line">            serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9999</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// é˜»å¡ ç›‘å¬äº‹ä»¶çš„å‘ç”Ÿ  å¦‚æœäº‹ä»¶å¤„ç†äº† selectä¼šé˜»å¡ å¦‚æœæ²¡å¤„ç† åˆ™ä¸é˜»å¡  å¦‚æœä¸æƒ³å¤„ç†ï¼Œé‚£å°±å–æ¶ˆäº‹ä»¶cancel()</span></span><br><span class="line">                selector.select();</span><br><span class="line"></span><br><span class="line">                Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                        <span class="type">ServerSocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> channel.accept();</span><br><span class="line">                        <span class="comment">// selectoréƒ½æ˜¯å¿…é¡»å·¥ä½œåœ¨ éé˜»å¡æ¨¡å¼</span></span><br><span class="line">                        socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                        <span class="comment">// æ³¨å†Œ åˆ°selectorä¸Š  å› ä¸ºä¸€ä¸ªselectorå¯ä»¥ç®¡ç†å¤šä¸ªchanel</span></span><br><span class="line">                        <span class="type">SelectionKey</span> <span class="variable">scKey</span> <span class="operator">=</span> socketChannel.register(selector, <span class="number">0</span>, ByteBuffer.allocate(<span class="number">16</span>));</span><br><span class="line">                        scKey.interestOps(SelectionKey.OP_READ);</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> (ByteBuffer) key.attachment();</span><br><span class="line">                        <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> channel.read(byteBuffer);</span><br><span class="line">                        <span class="comment">// å®¢æˆ·ç«¯æ­£å¸¸æ–­å¼€ è¿”å›-1</span></span><br><span class="line">                        <span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;</span><br><span class="line">                            key.cancel();</span><br><span class="line">                            channel.close();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// å¤„ç†ç²˜åŒ…</span></span><br><span class="line">                            split(byteBuffer);</span><br><span class="line">                            <span class="comment">// å¤„ç†æ‰©å®¹</span></span><br><span class="line">                            <span class="keyword">if</span> (byteBuffer.position() == byteBuffer.limit()) &#123;</span><br><span class="line">                                <span class="type">ByteBuffer</span> <span class="variable">newBytebuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">2</span> * byteBuffer.capacity());</span><br><span class="line">                                byteBuffer.flip();</span><br><span class="line">                                newBytebuffer.put(byteBuffer);</span><br><span class="line">                                key.attach(newBytebuffer);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//                            byteBuffer.flip();</span></span><br><span class="line"><span class="comment">//                            debugRead(byteBuffer);</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// éœ€è¦æ‰‹åŠ¨åˆ é™¤  ä¸ç„¶äº‹ä»¶è™½ç„¶å¤„ç†äº† ç»‘å®šäº‹ä»¶çš„keyè¿˜å­˜åœ¨</span></span><br><span class="line">                    iterator.remove();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">split</span><span class="params">(ByteBuffer byteBuffer)</span> &#123;</span><br><span class="line"></span><br><span class="line">        byteBuffer.flip();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; byteBuffer.limit(); i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (byteBuffer.get(i) == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> i + <span class="number">1</span> - byteBuffer.position();</span><br><span class="line"></span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">target</span> <span class="operator">=</span> ByteBuffer.allocate(length);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; length; j++) &#123;</span><br><span class="line">                    target.put(byteBuffer.get());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å°† position è®¾ç½®ä¸º 0ï¼Œå‡†å¤‡å¼€å§‹è¯»å–</span></span><br><span class="line">                target.flip();</span><br><span class="line">                <span class="comment">// æˆ–è€…å°†å­—èŠ‚è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶ä¸€æ¬¡æ€§è¾“å‡º</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(target.array(), target.position(), target.remaining());</span><br><span class="line">                System.out.println(output);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        byteBuffer.compact();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æœåŠ¡æ®µä»£ç  å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NioSelectorClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socketChannel = SocketChannel.open();</span><br><span class="line">            socketChannel.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9999</span>));</span><br><span class="line"></span><br><span class="line">            socketChannel.write(Charset.defaultCharset().encode(<span class="string">&quot;huyunfeinihaocongjianihaok\noolopwew\n&quot;</span>));</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="nioç¼–ç¨‹è§£å†³çš„é—®é¢˜"><a href="#nioç¼–ç¨‹è§£å†³çš„é—®é¢˜" class="headerlink" title="nioç¼–ç¨‹è§£å†³çš„é—®é¢˜"></a>nioç¼–ç¨‹è§£å†³çš„é—®é¢˜</h3><blockquote><p>ä¸Šé¢çš„ä¾‹å­ç®€å•è§£å†³çš„ä»¥ä¸‹å‡ ä¸ªé—®é¢˜</p></blockquote><ol><li>ç²˜åŒ…é»åŒ…é—®é¢˜ï¼ˆTCPç¼–ç¨‹å¿…é¡»è€ƒè™‘çš„é—®é¢˜ï¼‰</li><li>å®¢æˆ·ç«¯å¼‚å¸¸ä¸­æ–­æˆ–è€…æ­£å¸¸é€€å‡ºå¤„ç†</li><li>bytebuffer æ‰©å®¹ ï¼ˆä¸Šé¢åªæ˜¯ç®€å•çš„æ‰©å®¹ï¼Œä½†æ˜¯å¾—è€ƒè™‘bytebufferçš„æ‰©å®¹å’Œç¼©å®¹ï¼ŒåšæˆåŠ¨æ€çš„æ›´å¥½ï¼Œnettyå°±åšçš„æ¯”è¾ƒå¥½ï¼‰</li></ol><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬å¾€å®¢æˆ·ç«¯å‘é€å†…å®¹ï¼Œéœ€è¦æ³¨æ„å“ªäº›é—®é¢˜å‘¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NioWrite</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">            <span class="type">SocketAddress</span> <span class="variable">socketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9000</span>);</span><br><span class="line">            serverSocketChannel.bind(socketAddress);</span><br><span class="line"></span><br><span class="line">            serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line"></span><br><span class="line">            <span class="type">SelectionKey</span> <span class="variable">selectionKey</span> <span class="operator">=</span> serverSocketChannel.register(selector, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">            selectionKey.interestOps(SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                selector.select();</span><br><span class="line"></span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                    iterator.remove();;</span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="type">ServerSocketChannel</span> <span class="variable">ssc</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line"></span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> ssc.accept();</span><br><span class="line">                        socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">SelectionKey</span> <span class="variable">sckey</span> <span class="operator">=</span> socketChannel.register(selector, <span class="number">0</span>, SelectionKey.OP_READ);</span><br><span class="line"></span><br><span class="line">                        <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3000000</span>; i++) &#123;</span><br><span class="line">                            stringBuffer.append(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> Charset.defaultCharset().encode(stringBuffer.toString());</span><br><span class="line">                        <span class="type">int</span> <span class="variable">write</span> <span class="operator">=</span> socketChannel.write(byteBuffer);</span><br><span class="line">                        log.info(<span class="string">&quot;å®é™…å†™å…¥äº† &#123;&#125;&quot;</span>, write);</span><br><span class="line">                        <span class="keyword">if</span> (byteBuffer.hasRemaining()) &#123;</span><br><span class="line">                            sckey.interestOps(SelectionKey.OP_WRITE + sckey.interestOps());</span><br><span class="line">                            sckey.attach(byteBuffer);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isWritable()) &#123;</span><br><span class="line">                        log.info(<span class="string">&quot;write able...&quot;</span>);</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> (ByteBuffer) key.attachment();</span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel)key.channel();</span><br><span class="line">                        <span class="type">int</span> <span class="variable">write</span> <span class="operator">=</span> channel.write(byteBuffer);</span><br><span class="line">                        <span class="keyword">if</span>(!byteBuffer.hasRemaining())&#123;</span><br><span class="line">                            log.info(<span class="string">&quot;cancel wrible&quot;</span>);</span><br><span class="line">                            key.interestOps(key.interestOps()-SelectionKey.OP_WRITE);</span><br><span class="line">                            key.attach(<span class="literal">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        log.info(<span class="string">&quot;å®é™…å†™å…¥äº† &#123;&#125;&quot;</span>, write);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„å®¢æˆ·ç«¯ä¾‹å­å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NioReadClient</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line"></span><br><span class="line">        <span class="type">SocketAddress</span> <span class="variable">socketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9000</span>);</span><br><span class="line">        socketChannel.connect(socketAddress);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> socketChannel.read(byteBuffer);</span><br><span class="line">            count += read;</span><br><span class="line">            System.out.println(count);</span><br><span class="line">            byteBuffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Selector selector = Selector.open();</span></span><br><span class="line"><span class="comment">//        socketChannel.configureBlocking(false);</span></span><br><span class="line"><span class="comment">//        socketChannel.register(selector, SelectionKey.OP_CONNECT + SelectionKey.OP_READ);</span></span><br><span class="line"><span class="comment">//        int count = 0;</span></span><br><span class="line"><span class="comment">//        while (true) &#123;</span></span><br><span class="line"><span class="comment">//            selector.select();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            while (iterator.hasNext())&#123;</span></span><br><span class="line"><span class="comment">//                SelectionKey sk = iterator.next();</span></span><br><span class="line"><span class="comment">//                iterator.remove();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                if(sk.isConnectable())&#123;</span></span><br><span class="line"><span class="comment">//                    System.out.println(&quot;connect...&quot;);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//                else if(sk.isReadable())&#123;</span></span><br><span class="line"><span class="comment">//                    ByteBuffer byteBuffer = ByteBuffer.allocate(1024);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                    int read = socketChannel.read(byteBuffer);</span></span><br><span class="line"><span class="comment">//                    count += read;</span></span><br><span class="line"><span class="comment">//                    System.out.println(count);</span></span><br><span class="line"><span class="comment">//                    byteBuffer.clear();</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤šçº¿ç¨‹ä¼˜åŒ–nioä»£ç "><a href="#å¤šçº¿ç¨‹ä¼˜åŒ–nioä»£ç " class="headerlink" title="å¤šçº¿ç¨‹ä¼˜åŒ–nioä»£ç "></a>å¤šçº¿ç¨‹ä¼˜åŒ–nioä»£ç </h3><p>ä»¥ä¸Šæˆ‘ä»¬å±•ç¤ºäº†nioçš„è¯»å–ã€å†™å…¥ ä»¥åŠé‡åˆ°çš„é—®é¢˜ï¼Œä½†æ˜¯æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦å®ç°çš„æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå¦‚æœæœ‰å¤§é‡è¿æ¥è¯·æ±‚è¿›æ¥ï¼Œåœ¨å¤„ç†readäº‹ä»¶çš„æ—¶å€™è¦å¾ˆä¹…ï¼Œé‚£å•çº¿ç¨‹æ˜¯ä¸æ˜¯å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†ä¸Šé¢çš„ä»£ç ä¼˜åŒ–æˆå¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£å»ºç«‹è¿æ¥ã€å¦å¤–ä¸€äº›çº¿ç¨‹ä¸“é—¨è´Ÿè´£è¯»å†™ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.CharBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedDeque;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NioThreadWork</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        Thread.currentThread().setName(<span class="string">&quot;boss&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ªserverSocketChannel</span></span><br><span class="line">            <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">            <span class="comment">// ç»‘å®šä¸€ä¸ªç«¯å£</span></span><br><span class="line">            <span class="type">SocketAddress</span> <span class="variable">socketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9999</span>);</span><br><span class="line">            serverSocketChannel.bind(socketAddress);</span><br><span class="line">            <span class="comment">// è®¾ç½®ä¸ºfalse</span></span><br><span class="line">            serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            <span class="comment">// æ‰“å¼€ä¸€ä¸ªselector</span></span><br><span class="line">            <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">            <span class="comment">// æ³¨å†Œchanel åˆ° selectorä¸Š</span></span><br><span class="line">            <span class="type">SelectionKey</span> <span class="variable">boosKey</span> <span class="operator">=</span> serverSocketChannel.register(selector, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶</span></span><br><span class="line">            boosKey.interestOps(SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">            <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&quot;work&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                log.info(<span class="string">&quot;ç­‰å¾…è¿æ¥ä¸­&quot;</span>);</span><br><span class="line">                selector.select();</span><br><span class="line"></span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                        log.info(<span class="string">&quot;è¿æ¥äº‹ä»¶å»ºç«‹&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">ServerSocketChannel</span> <span class="variable">ssc</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> ssc.accept();</span><br><span class="line">                        socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                        log.info(<span class="string">&quot;æ³¨å†Œè¯»å–äº‹ä»¶ before&quot;</span>);</span><br><span class="line">                        worker.register(socketChannel);</span><br><span class="line">                        log.info(<span class="string">&quot;æ³¨å†Œè¯»å–äº‹ä»¶ after&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> Thread thread;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> Selector selector;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">start</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> ConcurrentLinkedDeque&lt;Runnable&gt; linkedDeque = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedDeque</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Worker</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!start) &#123;</span><br><span class="line">                thread = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>, name);</span><br><span class="line">                thread.start();</span><br><span class="line">                selector = Selector.open();</span><br><span class="line">                start = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            linkedDeque.offer(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClosedChannelException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            selector.wakeup();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SneakyThrows</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">Runnable</span> <span class="variable">poll</span> <span class="operator">=</span> linkedDeque.poll();</span><br><span class="line">                <span class="keyword">if</span> (poll != <span class="literal">null</span>) &#123;</span><br><span class="line">                    poll.run();</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;è¯»å–äº‹ä»¶é˜»å¡&quot;</span>);</span><br><span class="line">                selector.select();</span><br><span class="line"></span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                    iterator.remove();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        log.info(<span class="string">&quot;è¯»æ•°æ®å¼€å§‹&quot;</span>);</span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">                        channel.read(byteBuffer);</span><br><span class="line">                        byteBuffer.flip();</span><br><span class="line"></span><br><span class="line">                        <span class="type">CharBuffer</span> <span class="variable">decode</span> <span class="operator">=</span> Charset.defaultCharset().decode(byteBuffer);</span><br><span class="line">                        <span class="keyword">while</span> (decode.hasRemaining()) &#123;</span><br><span class="line">                            log.info(<span class="string">&quot;content &#123;&#125;&quot;</span>, decode.get());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NioThreadClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span>SocketChannel.open();</span><br><span class="line"></span><br><span class="line">            <span class="type">SocketAddress</span> <span class="variable">socketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9999</span>);</span><br><span class="line">            socketChannel.connect(socketAddress);</span><br><span class="line"></span><br><span class="line">            socketChannel.write(Charset.defaultCharset().encode(<span class="string">&quot;ä½ å¥½&quot;</span>));</span><br><span class="line"></span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç ä¾¿å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„å¤šçº¿ç¨‹ç‰ˆæœ¬çš„è¯»å†™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œå¦‚æœå†å®Œå–„çš„è¯ï¼Œå¯ä»¥åŠ ä¸Šæˆ‘ä»¬ä¹‹å‰çš„å„ç§ä¼˜åŒ–ç‚¹ï¼Œå¯¹bytebufferçš„æ‰©å®¹ã€å¯¹ç²˜åŒ…çš„å¤„ç†ï¼Œå¯¹å®¢æˆ·ç«¯å¼‚å¸¸å…³é—­æ­£å¸¸å…³é—­çš„å¤„ç†ç­‰ ä¼šè®©ä»£ç æ›´åŠ å®Œå–„ï¼Œä½†æ˜¯æˆ‘ä»¬è‡ªå·±å¤„ç†è¿˜æ˜¯ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚nioæœ‰å¾ˆå¤šä»£ç å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”è¿˜æœ‰ä¸€ä¸ªè‡­åæ˜­è‘—çš„ç©ºè½®è®­å¯¼è‡´cpuæ‰“æ»¡çš„é—®é¢˜ï¼Œæ‰€ä»¥æœ‰å¿…è¦å°è£…ä¸€å¥—é«˜æ€§èƒ½çš„ç½‘ç»œæ¡†æ¶æ¥å¤„ç†è¿™äº›é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¤§åé¼é¼çš„netty</p><p>æ‰€ä»¥ä¸‹ä¸€ç¯‡,æˆ‘å°±æ¥ç®€å•ä»‹ç»ä¸‹nettyçš„ä½¿ç”¨ä»¥åŠåŸç†</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸Šä¸€ç¯‡è¯´è¿‡äº†åŸºç¡€IOæµçš„æ“ä½œï¼Œè¿™ç¯‡ç®€å•è¯´ä¸€ä¸‹ç½‘ç»œç¼–ç¨‹ï¼Œç½‘ç»œç¼–ç¨‹å°±æˆ‘è‡ªå·±ç†è§£å°±æ˜¯åœ¨ç½‘ç»œä¸–ç•Œä¸­è¿›è¡Œæ•°æ®çš„äº’ç›¸ä¼ é€’ï¼Œå®ƒåŸºäºOSIä¸ƒå±‚æ¨¡å‹ï¼Œè¿›è¡Œå±‚å±‚å°è£…ï¼Œæ¥å°†æ•°æ®æœ€ç»ˆå°è£…æˆäº†ä¸€ä¸ªä¸ªæ•°æ®åŒ…ï¼Œç„¶åå‘å¾€å¦å¤–ä¸€ç«¯ï¼Œè¿™ç¯‡æš‚æ—¶ä¸è¯´TCPã€UDPä»¥åŠsocketé€šä¿¡çš„å…¶å®ƒåè®®ï¼Œè¿™ç¯‡åªè¯´ä¸€ä¸‹è·ŸIOç›¸å…³çš„ç½‘ç»œç¼–ç¨‹&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="https://hxq94.github.io/categories/java/"/>
    
    <category term="ç½‘ç»œç¼–ç¨‹" scheme="https://hxq94.github.io/categories/java/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="ç½‘ç»œç¼–ç¨‹" scheme="https://hxq94.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>IO æµ</title>
    <link href="https://hxq94.github.io/2023/05/05/IO/"/>
    <id>https://hxq94.github.io/2023/05/05/IO/</id>
    <published>2023-05-05T12:42:35.044Z</published>
    <updated>2023-06-10T14:02:07.737Z</updated>
    
    <content type="html"><![CDATA[<p>IOæ˜¯ç½‘ç»œä¸–ç•Œä¸­ä¸å¯è·ç¼ºçš„å¹¶ä¸”å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯input|outputçš„ç¼©å†™ï¼Œæœ‰äº†å®ƒï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨ç½‘ç»œä¸­ä¼ è¾“æ•°æ®ï¼ŒåŒ…æ‹¬è¾“å…¥å’Œè¾“å‡º</p><span id="more"></span><h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><blockquote><p>è¾“å…¥æµï¼šä¸»è¦æœ‰InputStream å’Œ Readerè¿™ä¸¤ä¸ªå­—èŠ‚å’Œå­—ç¬¦æµ</p></blockquote><blockquote><p>è¾“å‡ºæµï¼šä¸»è¦æœ‰OutputStream å’Œ Writerè¿™ä¸¤ä¸ªå­—èŠ‚å’Œå­—ç¬¦æµ</p></blockquote><blockquote><p>å­—èŠ‚æµï¼šå¯ä»¥æ“ä½œä»»ä½•æ•°æ®</p></blockquote><blockquote><p>å­—ç¬¦æµï¼šè½¬ä¹ˆç”¨æ¥æ“ä½œå­—ç¬¦çš„ï¼Œæ¯”è¾ƒæ–¹ä¾¿</p></blockquote><h3 id="å¸¸ç”¨çš„æµ"><a href="#å¸¸ç”¨çš„æµ" class="headerlink" title="å¸¸ç”¨çš„æµ"></a>å¸¸ç”¨çš„æµ</h3><p>æµçš„ç§ç±»å¾ˆå¤šï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¸¸ç”¨çš„æµï¼ŒçŸ¥é“ä»–ä»¬çš„åŸç†å°±å¥½ï¼Œä»¥åç”¨åˆ°å…¶ä»–çš„å†å»æŸ¥é˜…å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FileInputStream/FileReader </span></span><br><span class="line"><span class="comment">// FileOutputStream/FileWriter</span></span><br><span class="line"><span class="keyword">package</span> com.hyf.demo.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileInputStreamTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†ä¸€ä¸ªæ–‡æœ¬å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">txt</span> <span class="operator">=</span> <span class="string">&quot;hello java&quot;</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/huyunfei/Downloads/java.txt&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file, <span class="literal">true</span>);</span><br><span class="line">            fileInputStream.write(txt.getBytes());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯»å–è·¯å¾„ä¸­çš„æ•°æ®  è¾“å‡ºåˆ°æ§åˆ¶å°</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileInputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">            <span class="comment">// 1. è¿™ç§æ–¹å¼æ˜¯ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚è¯»å–</span></span><br><span class="line">            <span class="type">int</span> msg;</span><br><span class="line">            <span class="keyword">while</span> ((msg = fileInputStream.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                System.out.println((<span class="type">char</span>) msg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2. è¿™ç§æ–¹å¼æ˜¯1024ä¸ªå­—èŠ‚è¯»å–</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> (fileInputStream.read(bytes) != -<span class="number">1</span>) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bytes));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fileInputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯æœ€åŸºç¡€çš„è¾“å…¥è¾“å‡º,è¿˜æœ‰ä¸“é—¨ç”¨äºè¯»å–å­—ç¬¦çš„æµ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferReaderTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†ä¸€ä¸ªæ–‡æœ¬å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">txt</span> <span class="operator">=</span> <span class="string">&quot;hello buffer\n&quot;</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/huyunfei/Downloads/java.txt&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BufferedOutputStream</span> <span class="variable">bufferedOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file));</span><br><span class="line">            bufferedOutputStream.write(txt.getBytes());</span><br><span class="line">            bufferedOutputStream.flush();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å­—ç¬¦bufferå†™å…¥åŸºç¡€ä»£ç </span></span><br><span class="line"><span class="comment">//            BufferedWriter bufferedWriter = new BufferedWriter(new FileWriter(file));</span></span><br><span class="line"><span class="comment">//            bufferedWriter.write(txt);</span></span><br><span class="line"><span class="comment">//            bufferedWriter.newLine();</span></span><br><span class="line"><span class="comment">//            bufferedWriter.flush();</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯»å–è·¯å¾„ä¸­çš„æ•°æ®  è¾“å‡ºåˆ°æ§åˆ¶å°</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bufferedReader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(file));</span><br><span class="line">            <span class="comment">// 1. è¿™ç§æ–¹å¼æ˜¯ä¸€è¡Œä¸€è¡Œè¯»å–</span></span><br><span class="line">            String msg;</span><br><span class="line">            <span class="keyword">while</span> ((msg = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2. è¿™ç§æ–¹å¼æ˜¯1024ä¸ªå­—èŠ‚è¯»å– ä¸Šé¢è¯»å–å®Œæ¯•å æµé‡Œé¢çš„æ•°æ®ä¼šæ¸…ç©º</span></span><br><span class="line"><span class="comment">//            char[] bytes = new char[1024];</span></span><br><span class="line"><span class="comment">//            while (bufferedReader.read(bytes) != -1) &#123;</span></span><br><span class="line"><span class="comment">//                System.out.println(new String(bytes));</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bufferedReader.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æŒ‰ç…§å¸¦bufferçš„æµè¯»å–çš„åŸºç¡€ä»£ç </p><p><h3 id="ç‰µæ‰¯åˆ°çš„ä¸¤ä¸ªé—®é¢˜"><a href="#ç‰µæ‰¯åˆ°çš„ä¸¤ä¸ªé—®é¢˜" class="headerlink" title="ç‰µæ‰¯åˆ°çš„ä¸¤ä¸ªé—®é¢˜"></a>ç‰µæ‰¯åˆ°çš„ä¸¤ä¸ªé—®é¢˜</h3><h4 id="ä¸ºä»€ä¹ˆè¦å‡ºç°å¸¦ç¼“å†²åŒºçš„æµ"><a href="#ä¸ºä»€ä¹ˆè¦å‡ºç°å¸¦ç¼“å†²åŒºçš„æµ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å‡ºç°å¸¦ç¼“å†²åŒºçš„æµ"></a>ä¸ºä»€ä¹ˆè¦å‡ºç°å¸¦ç¼“å†²åŒºçš„æµ</h4><h4 id="ä½¿ç”¨å¸¦ç¼“å†²çš„æµåŒ…è£…åŸºç¡€æµæ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼"><a href="#ä½¿ç”¨å¸¦ç¼“å†²çš„æµåŒ…è£…åŸºç¡€æµæ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼" class="headerlink" title="ä½¿ç”¨å¸¦ç¼“å†²çš„æµåŒ…è£…åŸºç¡€æµæ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼"></a>ä½¿ç”¨å¸¦ç¼“å†²çš„æµåŒ…è£…åŸºç¡€æµæ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼</h4><blockquote><p>æ¥ç€æˆ‘ä»¬æ¥è§£é‡Šç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¸¦ç¼“å†²åŒºçš„æµ?</p></blockquote><ol><li><p>ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬è¿›è¡Œé¢‘ç¹æ•°æ®è¯»å†™çš„æ—¶å€™ï¼Œå¾ˆè€—è´¹æ€§èƒ½ï¼Œäºæ˜¯æˆ‘ä»¬éœ€è¦å°†éœ€è¦è¯»å†™çš„æ•°æ®æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹æš‚å­˜èµ·æ¥ï¼Œç„¶åè¿›è¡Œä¸€ä¸ªæ‰¹é‡çš„è¯»å†™ï¼Œç”¨çš„ä¹Ÿæ˜¯é¡ºåºå†™ï¼Œç”¨æ¥ç¼“è§£ä¸åŒè®¾å¤‡ä¹‹é—´é¢‘ç¹çš„æ•°æ®è¯»å†™ï¼Œäºæ˜¯æœ‰äº†ç¼“å†²åŒºçš„å‡ºç°</p></li><li><p>æ€ä¹ˆè¯æ˜ä½¿ç”¨äº†buffer æ¯”ä¸ä½¿ç”¨buffer é€Ÿåº¦å¿«å‘¢ï¼Ÿ</p><ol><li>æºç å¦‚ä¸‹</li></ol> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span> b[], <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//åœ¨è¿™åˆ¤æ–­éœ€è¦å†™çš„æ•°æ®é•¿åº¦æ˜¯å¦å·²ç»è¶…å‡ºå®¹å™¨çš„é•¿åº¦ï¼ˆ8192byteï¼‰äº†,å¦‚æœè¶…å‡ºåˆ™ç›´æ¥å†™åˆ°ç›¸åº”çš„outputStreamä¸­,å¹¶æ¸…ç©ºç¼“å†²åŒº</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt;= buf.length) &#123;</span><br><span class="line">        <span class="comment">/* If the request length exceeds the size of the output buffer,</span></span><br><span class="line"><span class="comment">           flush the output buffer and then write the data directly.</span></span><br><span class="line"><span class="comment">           In this way buffered streams will cascade harmlessly. */</span></span><br><span class="line">        flushBuffer();</span><br><span class="line">        out.write(b, off, len);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç¼“å†²åŒºå‰©ä½™çš„å®¹é‡æ˜¯å¦è¿˜å¤Ÿå†™å…¥å½“å‰lençš„å†…å®¹,å¦‚æœä¸å¤Ÿåˆ™æ¸…ç©ºç¼“å†²åŒº</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt; buf.length - count) &#123;</span><br><span class="line">        flushBuffer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†è¦å†™çš„æ•°æ®å…ˆæ”¾å…¥å†…å­˜ä¸­,ç­‰å¾…æ•°æ®è¾¾åˆ°äº†ç¼“å†²åŒºçš„é•¿åº¦å,å†å†™åˆ°ç›¸åº”çš„outputStreamä¸­</span></span><br><span class="line">    System.arraycopy(b, off, buf, count, len);</span><br><span class="line">    count += len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä»–ä¸æ˜¯æ¯æ¬¡éƒ½è°ƒç”¨ç³»ç»Ÿçš„write è€Œæ˜¯ç§¯æ”’åˆ°8192byteåæ‰è°ƒç”¨ä¸€æ¬¡write å¤§å¤§å‡å°‘äº†ç³»ç»Ÿè°ƒç”¨</span></span><br></pre></td></tr></table></figure><ol start="2"><li>å®éªŒå¦‚ä¸‹</li></ol> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OSFileIO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">byte</span>[] data = <span class="string">&quot;123456789\n&quot;</span>.getBytes();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/data/io/out.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">switch</span> (args[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;0&quot;</span>:</span><br><span class="line">                testBasicFileIO();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                testBufferedFileIO();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testBasicFileIO</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            out.write(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testBufferedFileIO</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path);</span><br><span class="line">        <span class="type">BufferedOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file));</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            out.write(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿™æ®µä»£ç æ¥æºäºç½‘ç»œ</span></span><br></pre></td></tr></table></figure><p> å°†è¿™æ®µä»£ç ä¸Šä¼ åˆ°linuxç›®å½•</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/huyunfei/Documents/study/testCase/io</span><br></pre></td></tr></table></figure><p> ç„¶åæ‰§è¡Œ</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¯‘javaæ–‡ä»¶</span></span><br><span class="line">javac OSFileIO.java</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿ç”¨strace åˆ†æè¿™ä¸ªç¨‹åºæ¶‰åŠåˆ°çš„ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line">strace -ff -o out java OSFileIO $1</span><br></pre></td></tr></table></figure><p> å¯ä»¥å‘ç°æœ€ç»ˆçš„ç»“æœæ˜¯ï¼Œä¸ä½¿ç”¨bufferçš„æµï¼Œç³»ç»Ÿè°ƒç”¨çš„writeå¾ˆå¤šï¼Œè€Œä½¿ç”¨äº†bufferçš„è¾¾åˆ°äº†8192 byteæ‰ä¼šè¿›è¡Œä¸€ä¸ªç³»ç»Ÿwriteè°ƒç”¨ï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾ä½¿ç”¨bufferåé€Ÿåº¦æ›´å¿«</p></li></ol><blockquote><p>ç¬¬äºŒä¸ªé—®é¢˜ è¿™é‡Œæ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆ</p></blockquote><ol><li>æµä¸­æ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼æœ€ç»å…¸çš„å°±æ˜¯è£…é¥°è€…æ¨¡å¼ï¼Œå°±æ˜¯åœ¨å·²æœ‰ç±»ä¸Šè¿›è¡Œè£…é¥°å¢å¼ºã€‚è¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯å¯ä»¥ä¸æ”¹å˜å·²æœ‰çš„ç±»ï¼Œæ¯”ç»§æ‰¿çµæ´»ï¼Œå®Œå…¨éµå¾ªå¼€é—­åŸåˆ™ï¼›ç¼ºç‚¹æ˜¯å¢åŠ äº†æ›´å¤šçš„ç±»ï¼Œå¤šå±‚è£…é¥°å¢åŠ äº†ä»£ç å¤æ‚æ€§</li></ol><p>å…¶å®è¿˜æœ‰ä¸€äº›å¸¸ç”¨çš„æµï¼Œæ¯”å¦‚å¯¹è±¡æµï¼ˆå¯ä»¥ç›´æ¥ä¼ è¾“å¯¹è±¡ï¼‰ã€è¿˜æœ‰æˆ‘ä»¬ä¸€èˆ¬å¯¹äºæ–‡ä»¶çš„è¯»å†™æ¯”è¾ƒå¤šï¼Œä½†æ˜¯é¢‘ç¹çš„æ–‡ä»¶è¯»å†™å¹¶ä¸å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å­—èŠ‚æ•°ç»„æµï¼Œä¹Ÿç§°ä¸ºå†…å­˜æµï¼Œ</p><h3 id="å¯¹è±¡æµ"><a href="#å¯¹è±¡æµ" class="headerlink" title="å¯¹è±¡æµ"></a>å¯¹è±¡æµ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectIOTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å°†ä¸€ä¸ªå¯¹è±¡åºåˆ—åŒ–åˆ°æ–‡ä»¶ä¸­</span></span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;libei&quot;</span>, <span class="number">18</span>);</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;/Users/huyunfei/Downloads/java.txt&quot;</span>);</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">writeObjectStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">            writeObjectStream.writeObject(student);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å°†æ–‡ä»¶ä¸­å¯¹è±¡ååºåˆ—åŒ–å‡ºæ¥</span></span><br><span class="line"></span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/huyunfei/Downloads/java.txt&quot;</span>);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">readObjectStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line"></span><br><span class="line">            <span class="type">Student</span> <span class="variable">student1</span> <span class="operator">=</span> (Student) readObjectStream.readObject();</span><br><span class="line">            System.out.println(student1);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œä¸€å®šè¦å®ç°åºåˆ—åŒ–æ¥å£</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­—èŠ‚æ•°ç»„æµ"><a href="#å­—èŠ‚æ•°ç»„æµ" class="headerlink" title="å­—èŠ‚æ•°ç»„æµ"></a>å­—èŠ‚æ•°ç»„æµ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hyf.demo.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ByteArrayInputStreamTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">DataOutputStream</span> <span class="variable">dataOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(byteArrayOutputStream);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dataOutputStream.writeDouble(Math.random());</span><br><span class="line">            dataOutputStream.writeBoolean(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">            <span class="type">DataInputStream</span> <span class="variable">dataInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(byteArrayInputStream);</span><br><span class="line">            System.out.println(dataInputStream.available());</span><br><span class="line">            System.out.println(dataInputStream.readBoolean());</span><br><span class="line">            System.out.println(dataInputStream.readDouble());</span><br><span class="line">            System.out.println(dataInputStream.available());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨çš„æµå°±è¿™äº›ï¼Œæˆ‘ä»¬åœ¨æ—¥å¸¸å·¥ä½œç”¨åˆ°äº†æŸ¥æ‰‹å†Œå°±å¥½ã€‚</p><h3 id="é€‰ç”¨å“ªç§æµ"><a href="#é€‰ç”¨å“ªç§æµ" class="headerlink" title="é€‰ç”¨å“ªç§æµ"></a>é€‰ç”¨å“ªç§æµ</h3><blockquote><p>è®°å¾—åˆšæ‰æˆ‘ä»¬åˆ†æè¿‡äº†æœ‰ä¸€ä¸ªBufferOutoutStreamä¸ºä»€ä¹ˆå¿«ï¼Œé‚£å®ƒå’Œè¿™ä¸ªå†…å­˜æµByteOutputStreamæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p></blockquote><p>ByteOutputStream ä¼šæ¯æ¬¡åˆ›å»ºä¸€ä¸ª32ä¸ªbyteçš„bufferï¼Œæ¯æ¬¡å†™å…¥çš„æ—¶å€™ä¼šå¯¹æ¯”å‰©ä½™å®¹é‡æ˜¯å¦å¤Ÿç”¨ï¼Œå¦‚æœä¸å¤Ÿç”¨å°±growè¿™ä¸ªbuffer ç»§ç»­å†™å…¥ï¼Œä¸€ç›´ç­‰æ•°æ®å†™å®Œï¼Œè¿™äº›æ•°æ®éƒ½æ˜¯åœ¨å†…å­˜çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span> b[], <span class="type">int</span> off, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> ((off &lt; <span class="number">0</span>) || (off &gt; b.length) || (len &lt; <span class="number">0</span>) ||</span><br><span class="line">           ((off + len) - b.length &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// ç¡®ä¿buffer è¶³å¤Ÿ</span></span><br><span class="line">       ensureCapacity(count + len);</span><br><span class="line">       System.arraycopy(b, off, buf, count, len);</span><br><span class="line">       count += len;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¦‚æœæƒ³è¦å¿«é€Ÿå†™å…¥çš„è¯ï¼Œä½¿ç”¨ByteArrayOutputStream,å¦‚æœèµ„æºä¸å¤ªå¤Ÿç”¨çš„æ—¶å€™ï¼Œåº”è¯¥é€‰æ‹©BufferOutputStream</p><blockquote><p>ä¸‹ä¸€ç¯‡è¯´ä¸€ä¸‹å„ç§IOçš„åŒºåˆ«å’ŒèƒŒæ™¯ï¼Œä»¥åŠç½‘ç»œIOçš„æ¼”è¿›</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;IOæ˜¯ç½‘ç»œä¸–ç•Œä¸­ä¸å¯è·ç¼ºçš„å¹¶ä¸”å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯input|outputçš„ç¼©å†™ï¼Œæœ‰äº†å®ƒï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨ç½‘ç»œä¸­ä¼ è¾“æ•°æ®ï¼ŒåŒ…æ‹¬è¾“å…¥å’Œè¾“å‡º&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="https://hxq94.github.io/categories/java/"/>
    
    <category term="IO" scheme="https://hxq94.github.io/categories/java/IO/"/>
    
    
    <category term="IO" scheme="https://hxq94.github.io/tags/IO/"/>
    
  </entry>
  
  <entry>
    <title>é”åˆ†æ</title>
    <link href="https://hxq94.github.io/2022/06/04/%E9%94%81%E5%88%86%E6%9E%90/"/>
    <id>https://hxq94.github.io/2022/06/04/%E9%94%81%E5%88%86%E6%9E%90/</id>
    <published>2022-06-04T12:19:09.736Z</published>
    <updated>2023-06-18T12:02:55.716Z</updated>
    
    <content type="html"><![CDATA[<h3 id="synchronized-å®ç°åŸç†"><a href="#synchronized-å®ç°åŸç†" class="headerlink" title="synchronized å®ç°åŸç†"></a>synchronized å®ç°åŸç†</h3><ol><li>synchronizedæ˜¯jvmå±‚é¢çš„ä¸€ç§é”,å¦‚æœæ˜¯å¤šä¸ªjvmåˆ™åªèƒ½åœ¨ä¸€ä¸ªjvmä¸­ç”Ÿæ•ˆ å®ƒèƒ½ä¿è¯æœ‰åºæ€§ã€å¯è§ã€åŸå­æ€§</li><li>synchronizedå¯ä»¥åŠ åœ¨æ–¹æ³•ä¸Š å¯ä»¥æ˜¯ä¸€ä¸ªä»£ç å—ï¼Œwait/notifyä¹Ÿä»¥æ¥monitorå¯¹è±¡ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦ç”¨åœ¨åŒæ­¥ä¸­çš„åŸå› <span id="more"></span></li><li>synchronized æœ€ç»ˆé”ä½çš„æ˜¯ä¸€ä¸ªå¯¹è±¡çš„monitorã€‚javaæ˜¯ç¼–è¯‘æˆä¸ºclassæ–‡ä»¶ jvmæ‹¿åˆ°è¿™ä¸ªclassæ–‡ä»¶åå¯ä»¥å¾—åˆ°è¦æ‰§è¡Œçš„jvmæŒ‡ä»¤ï¼Œä»–ä¼šæŠŠè¿™äº›æŒ‡ä»¤æ ¹æ®c++ä»£ç è§£æåç¿»è¯‘æˆä¸ºæœºå™¨ç  äº¤ç»™æ“ä½œç³»ç»Ÿå»æ‰§è¡Œã€‚ åœ¨jvmåº•å±‚æ“ä½œjvmæŒ‡ä»¤çš„æºç å‘ç° å…¶å®monitoræ˜¯æœ‰ä¸€ä¸ªæ•°æ®ç»“æ„çš„ æ¯”å¦‚owner å­˜æ”¾çš„æ˜¯ç›®å‰å æœ‰é”çš„çº¿ç¨‹ EntryListå­˜æ”¾çš„åç»­æ¥ç«äº‰é”çš„çº¿ç¨‹ WaitSet æ˜¯å­˜æ”¾ä¹‹å‰è·å–è¿‡é”ï¼Œä½†æ˜¯åœ¨WAEIINGçŠ¶æ€çš„çº¿ç¨‹çš„</li><li>åœ¨1.5ä¹‹å‰ä»–æ˜¯ç›´æ¥åœ¨æ“ä½œç³»ç»Ÿå±‚é¢åŠ é”ï¼Œæ‰€ä»¥æ¯”è¾ƒé‡ï¼Œåœ¨1.6ä¹‹åå¯ä»¥é€šè¿‡é”å‡çº§æœºåˆ¶æ¥è®©é”çš„æ€§èƒ½æé«˜  å¤§æ¦‚å°±æ˜¯å¯ä»¥ä»æ— é”ã€åå‘é”ã€è½»é‡çº§é”åˆ°æœ€åçš„é‡é‡çº§é”<br>åå‘é”å°±æ˜¯å­˜åœ¨åŒæ­¥ä½†æ— ç«äº‰çš„æƒ…å†µ æ¯”å¦‚springçš„æºç ï¼Œå®ƒé‡Œé¢æœ‰ä¸€äº›æ–¹æ³•åŠ äº†åŒæ­¥ ä½†æ˜¯åŸºæœ¬æ˜¯æ²¡æœ‰ç«äº‰çš„ é‚£è¿™æ ·çš„è¯æ¯æ¬¡ç›´æ¥åˆ¤æ–­ä¸€ä¸‹ownerä¸­çš„çº¿ç¨‹æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå°±å¯ä»¥äº†<br>å‡è®¾å­˜åœ¨å°‘é‡çš„å‡ ä¸ªç«äº‰ é‚£ä¹ˆå°±ä¼šå‡çº§æˆä¸ºè½»é‡çº§é”ï¼Œè½»é‡çº§é”ä»–æ˜¯ä½¿ç”¨äº†casæœºåˆ¶ï¼Œæ²¡æœ‰è·å–åˆ°é”ä¸ä¼šæŒ‚èµ·ç­‰å¾…ï¼Œæ‰€ä»¥å°±ä¸æ¶‰åŠåˆ°cpuè°ƒåº¦ã€çº¿ç¨‹åˆ‡æ¢è¿™äº›æ¯”è¾ƒé‡çš„æ“ä½œï¼Œä»–ä¼šä¸€ç›´ç©ºè½®è®­è‡ªé€‚åº”è‡ªæ—‹ ä½†æ˜¯è¿™æ ·ä¼šè€—è´¹cpuèµ„æºï¼Œæ‰€ä»¥ä¸€æ—¦åˆ¤æ–­è‡ªæ—‹è¶…è¿‡å¤šå°‘æ¬¡ï¼Œå°±ä¼šè§‰å¾—çº¿ç¨‹ç«äº‰å¾ˆå‰å®³ï¼Œå°±è½¬æ¢ä¸ºé‡é‡çº§é”</li></ol><h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><ol><li>cas æ˜¯æ¯”è¾ƒå’Œäº¤æ¢çš„æ„æ€ æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç° å¯ä»¥è§£å†³å¹¶å‘é—®é¢˜ å®ƒä¸»è¦å®ç°åŸç†æ˜¯è¿™æ ·çš„<br> æœ‰ä¸€ä¸ªä¸»å­˜ä¸­çš„æœ€ç»ˆç»“æœå€¼ ä»–æ˜¯è¢«valitileä¿®é¥°çš„<br> è¿˜æœ‰æ¯ä¸€ä¸ªçº¿ç¨‹è¿›æ¥åä¼šæœ‰ä¸€ä¸ªæ‹¿åˆ°çš„å€¼<br> ä»¥åŠæˆ‘ä»¬è¦ä¿®æ”¹çš„å€¼<br>æ¯”å¦‚ ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘äº† ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°æ˜¯50 ç¬¬äºŒä¸ªçº¿ç¨‹æ‹¿åˆ°çš„ä¹Ÿæ˜¯50 è¦ä¿®æ”¹æˆ60<br>åœ¨ä¿®æ”¹æˆ60çš„æ—¶å€™ä¼šæŠŠå½“å‰æ‹¿åˆ°çš„å€¼è·Ÿå†…å­˜ä¸­çš„ç»“æœå€¼æ¯”è¾ƒä¸€ä¸‹ å¦‚æœä¸€æ ·ï¼Œæ‰ä¿®æ”¹æˆåŠŸ<br>é‚£ä¹ˆæ­¤æ—¶è¿™ä¸ªåœºæ™¯å°±æ˜¯<br>açº¿ç¨‹æ‹¿åˆ°50 è¿›è¡Œä¿®æ”¹ åˆ¤æ–­50å’Œå†…å­˜ä¸­çš„50ä¸€è‡´ ä¿®æ”¹æˆåŠŸ å†…å­˜ä¸­å€¼å˜ä¸º60<br>bçº¿ç¨‹æ‹¿åˆ°çš„ä¹Ÿæ˜¯50 è¿›è¡Œä¿®æ”¹ åˆ¤æ–­50å’Œå½“å‰å†…å­˜å€¼60 ä¸ä¸€è‡´ ä¿®æ”¹å¤±è´¥  è¿™æ ·å°±ä½¿ç”¨casè§£å†³äº†å¹¶å‘é—®é¢˜<br>ä½†æ˜¯casä¼šæœ‰ä¸¤ä¸ªé—®é¢˜ : åŸå­æ€§é—®é¢˜å’ŒABAé—®é¢˜<br>åŸå­æ€§é—®é¢˜ï¼šåˆ¤æ–­å’Œä¿®æ”¹æ˜¯ä¸¤æ­¥æ“ä½œ çœ‹åº•å±‚æ˜¯ä½¿ç”¨çš„lockå®ç° æ‰€ä»¥è§£å†³åŸå­æ€§é—®é¢˜<br>ABAé—®é¢˜ï¼š å‡è®¾æœ‰ä¸‰ä¸ªçº¿ç¨‹ a,b,c å¹¶å‘äº†<br>açº¿ç¨‹è¦æŠŠ100å˜ä¸º50 bçº¿ç¨‹ä¹Ÿè¦æŠŠ100å˜ä¸º50 cçº¿ç¨‹è¦æŠŠ50å˜ä¸º100<br>å‡è®¾æ­¤æ—¶açº¿ç¨‹ æˆåŠŸæ‰§è¡Œäº†  bçº¿ç¨‹åˆšæ‰§è¡Œå®Œå’Œaæ‹¿åˆ°100è¿™ä¸ªæ­¥éª¤ï¼Œé˜»å¡äº†ï¼›æ­¤æ—¶cçº¿ç¨‹æ‰§è¡Œ50å˜100æ“ä½œæˆåŠŸï¼Œä¹Ÿå°±åœ¨æ­¤æ—¶bçº¿ç¨‹æ¢å¤äº† åˆæŠŠ100 å˜æˆäº†50 ï¼›è¿™å°±å‡ºç°äº†é—®é¢˜<br>å¦‚æœè¦è§£å†³çš„è¯ éœ€è¦åŠ ä¸€ä¸ªç‰ˆæœ¬å· æ›´æ–°çš„æ—¶å€™æŠŠç‰ˆæœ¬å·æ›´æ–°+1 ä¸”åˆ¤æ–­æ¡ä»¶åŠ ä¸Šç‰ˆæœ¬åˆ¤æ–­</li></ol><h3 id="LongAdder-å’Œ-AtomicInterger"><a href="#LongAdder-å’Œ-AtomicInterger" class="headerlink" title="LongAdder å’Œ AtomicInterger"></a>LongAdder å’Œ AtomicInterger</h3><p>AtomicInterger å®ç°äº†casæ“ä½œ<br>LongAdder æ˜¯ä¼˜åŒ–åçš„cas  åŸç†æ˜¯æŠŠæ•°æ®åˆ†æ®µåä½œcas++ ä¼šæ ¹æ®æ¥çš„çº¿ç¨‹å¤šå°‘åŠ¨æ€çš„æ‰©ç¼©æ•°æ®åˆ†æ®µ æœ€åå†åšç´¯åŠ  åˆ†å¤šå°‘æ®µå…¶å®ç†è®ºä¸Šæ€§èƒ½å°±æé«˜å¤šå°‘å€<br>threadLocalä¹Ÿèƒ½è§£å†³ å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€å˜é‡çš„é—®é¢˜</p><h3 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h3><ol><li>å¤šä¸ªjvmçš„æ—¶å€™ä½¿ç”¨åˆ†å¸ƒå¼é” </li><li>æœ‰å¤šä¸ªå®ç°ç‰ˆæœ¬ åŸºäºmysqlçš„ redisçš„ zookeeperçš„</li><li>åˆ†å¸ƒå¼é”ä½¿ç”¨æœ€åŸºç¡€ç‰ˆæœ¬çš„redisçš„è¯  éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹<br>ï¼ˆ1ï¼‰åœ¨è®¾ç½®keyçš„æ—¶å€™è¦æŠŠvalueè®¾ç½®ä¸ºèƒ½æ ‡è¯†å½“å‰çº¿ç¨‹çš„å€¼<br>ï¼ˆ2ï¼‰ä¸”è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ˜¯setnxåŸå­æ“ä½œ<br>ï¼ˆ3ï¼‰é‡Šæ”¾é”è¦å†™åˆ°finallyé‡Œé¢ é‡Šæ”¾é”çš„æ—¶å€™è¦åˆ¤æ–­æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰çš„é”æ‰é‡Šæ”¾ é¿å…é‡Šæ”¾æ‰å…¶ä»–çº¿ç¨‹çš„é” ä¸”è¿™ä¸¤æ­¥è¦æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ ä½¿ç”¨luaè„šæœ¬æ¥å®ç°<br>ï¼ˆ4ï¼‰è¦æä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œå‡è®¾é”å†…ä¸šåŠ¡é€»è¾‘æ²¡æœ‰æ‰§è¡Œå®Œ è¦ç»­è¿‡æœŸæ—¶é—´</li><li>åŸºäºä»¥ä¸Šé—®é¢˜ redsiå¸®åŠ©æˆ‘ä»¬å°è£…äº†ä¸€ä¸ªredissonå®¢æˆ·ç«¯ å¸®åŠ©æˆ‘ä»¬å°è£…äº†ä»¥ä¸Šæ“ä½œ</li><li>ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯redisé›†ç¾¤ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªé—®é¢˜<br> ä¸»ä»åŒæ­¥åœºæ™¯çš„æ—¶å€™ å¦‚æœåˆšç»™masterä¸Šé”æˆåŠŸ masterç»™slaveåŒæ­¥æ•°æ®çš„æ—¶å€™æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆæ­¤æ—¶å†è·å–é”çš„æ—¶å€™ï¼Œåœ¨ä»èŠ‚ç‚¹æ˜¯è·å–ä¸åˆ°é”çš„ï¼Œå› ä¸ºredisçš„æ¨¡å‹æ˜¯AP,åªèƒ½ä¿è¯å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œä¿è¯ä¸äº†ä¸€è‡´æ€§<br> æ‰€ä»¥æ­¤æ—¶åº”è¯¥è€ƒè™‘ä½¿ç”¨redlockå»å®Œæˆåˆ†å¸ƒå¼é”çš„æ·»åŠ ï¼Œä½†æ˜¯ç½‘ä¸Šæœ‰redlockçš„é—®é¢˜ï¼Œæ‰€ä»¥åšåˆ†å¸ƒå¼é”è¿˜æ˜¯åº”è¯¥ä¼˜å…ˆè€ƒè™‘zookeeper<br> å¦‚æœæ˜¯åœ¨åˆ é™¤é”çš„æ—¶å€™æ²¡æœ‰ç”¨luaè„šæœ¬ä¹Ÿæ˜¯ä¼šæœ‰é—®é¢˜çš„ï¼šæ¯”å¦‚åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€çº¿ç¨‹æŒæœ‰çš„é”å·²ç»é€šè¿‡äº† açº¿ç¨‹æ­¤æ—¶å¼€å§‹é˜»å¡ åˆšå¥½è¿™æ—¶å€™é€šè¿‡è¿‡æœŸæ—¶é—´è¿‡æœŸäº†é”ï¼Œé‚£ä¹ˆçº¿ç¨‹bæ‹¿åˆ°é”ï¼Œæ­¤æ—¶açº¿ç¨‹å¼€å§‹æ‰§è¡Œ å°±ä¼šæŠŠçº¿ç¨‹bçš„é”é‡Šæ”¾æ‰</li><li>ä¸ºä»€ä¹ˆè¦é€‰æ‹©zookeeper<br> å› ä¸ºzookeeperæ˜¯åŸºäºCPæ¨¡å‹çš„æ•°æ®æ¨¡å‹ï¼Œzabæ¥ä¿è¯ä¸€è‡´æ€§é—®é¢˜ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´zookerperæ¯”redisæ€§èƒ½ä½ï¼Œä½†æ˜¯æˆ‘ä»¬çš„åœºæ™¯åˆæ˜¯é«˜å¹¶å‘ä¸‹çš„åˆ†å¸ƒå¼é”é—®é¢˜ï¼Œ<br> å¦‚æœå¯¹äºå¹¶å‘å‡ºç°çš„é—®é¢˜ä¸èƒ½å®¹å¿ï¼Œé‚£ä¹ˆåº”è¯¥ä¼˜å…ˆé€‰ç”¨zookeeperï¼Œå¹¶ä¸”redlock éœ€è¦è‡³å°‘5ä¸ªèŠ‚ç‚¹ ä»æ•ˆç‡ä¸Šè¯´å…¶å®ä¹Ÿä¸å¿«äº† </li><li>ç‰µæ‰¯åˆ°çš„ä¸€ä¸ªç§’æ€æƒ…å†µä¸‹ä½¿ç”¨åˆ†å¸ƒå¼é”çš„æ€§èƒ½é—®é¢˜ å…¶å®è¿˜æ˜¯åˆ†æ®µæ€æƒ³ï¼Œå°†åº“å­˜åˆ†å¸ƒåœ¨ä¸åŒçš„é”ä¸­ï¼Œé‚£ä¹ˆæ€§èƒ½ä¼šæç¤ºå¾ˆå¤š</li><li>å¯ä»¥è§£å†³ç¼“å­˜å’Œæ•°æ®åº“åŒå†™ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆå¸‚é¢ä¸Šæœ‰å»¶æ—¶åŒåˆ ã€å†…å­˜é˜Ÿåˆ—ï¼Œä¼˜åŒ–å¯ä»¥ä½¿ç”¨è¯»å†™é”ï¼‰</li></ol><h3 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h3><h2 id="å¯é‡å…¥é”"><a href="#å¯é‡å…¥é”" class="headerlink" title="å¯é‡å…¥é”"></a>å¯é‡å…¥é”</h2><ol><li>é”çš„ä¸€ä¸ªå…³é”®å°±æ˜¯ æœ‰å¹¶å‘ å¹¶ä¸”æœ‰ç«äº‰</li><li>å…¬å¹³é”åˆ¤æ–­stateä¸º0çš„æ—¶å€™ ä¸èƒ½ç›´æ¥casè·å–é” å› ä¸ºæ˜¯å…¬å¹³é”ï¼Œæ­¤æ—¶å¯èƒ½æœ‰å¾ˆå¤šçº¿ç¨‹å·²ç»åœ¨æ’é˜Ÿäº†</li><li>å…¶å®ƒçº¿ç¨‹å…¥é˜Ÿæ—¶å€™ ä»–è¦è‡ªæ—‹2æ¬¡ï¼Œè‡ªæ—‹ä¸¤æ¬¡çš„æ—¶å€™ä¼šå°è¯•è·å–é” </li><li>æ¯”å¦‚æœ‰ä¸‰ä¸ªçº¿ç¨‹ æ­¤æ—¶ç¬¬ä¸€ä¸ªå·²ç»é‡Šæ”¾äº†ï¼Œç¬¬äºŒä¸ªå°±ä¼šæ‹¿åˆ°é” ä¸”å˜ä¸ºthread==nullçš„headèŠ‚ç‚¹ï¼Œä½†æ˜¯æ­¤æ—¶ç¬¬ä¸‰ä¸ªçº¿ç¨‹æ¥äº† åœ¨å…¥é˜Ÿè¿‡ç¨‹ä¸­ä»–è¦è‡ªæ—‹ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šåˆ¤æ–­ï¼šæ¥è¯¢é—®èƒ½å¦è·å–åˆ°é”çš„çº¿ç¨‹ï¼Œæ˜¯ä¸æ˜¯é™¤å»thread==nullé‚£ä¸ªèŠ‚ç‚¹çš„ç¬¬äºŒä¸ªèŠ‚ç‚¹ å¦‚æœä¸æ˜¯thread==nullçš„é‚£ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹ è‚¯å®šä¸èƒ½è·å–é”</li><li>ç¬¬äºŒä¸ªçº¿ç¨‹æ¥å…¥é˜Ÿçš„æ—¶å€™ä¼šè¿›è¡Œè‡ªæ—‹ è‡ªæ—‹çš„æ—¶å€™ä¼šåˆ¤æ–­ï¼šé”æ˜¯è‡ªç”±çŠ¶æ€ ä¸”å»ç«äº‰çš„çº¿ç¨‹æ˜¯thread==nullåé¢çš„èŠ‚ç‚¹çš„çº¿ç¨‹æ‰æœ‰èµ„æ ¼è¿›è¡Œcasè·å–é” å¯é‡å…¥çš„æ—¶å€™ä¹Ÿä¼šåˆ¤æ–­<br>æŒæœ‰é”çš„çº¿ç¨‹æ°¸è¿œä¸åœ¨é˜Ÿåˆ—ä¸­</li></ol><p>return h != t &amp;&amp;<br>            ((s = h.next) == null || s.thread != Thread.currentThread());</p><p>ç¬¬ä¸€ç§ï¼šé˜Ÿåˆ—æ²¡æœ‰åˆå§‹åŒ– h!=t è¿”å›false è¿”å›false æ„å‘³ç€å¯ä»¥å°è¯•casè·å–é”<br>ç¬¬äºŒç§ï¼šå¦‚æœé˜Ÿåˆ—åˆå§‹åŒ–äº†ï¼Œåˆå§‹åŒ–å åˆ†ä¸¤ç§æƒ…å†µ<br>    1.1: å¦‚æœé˜Ÿåˆ—ä¸­çš„å…ƒç´ æ¯”è¾ƒå¤š é‚£ä¹ˆh!t è¿”å›true  è¿”å›true è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µ<br>        1.1.1  å¦‚æœ(s = h.next) == null è¿”å›true è¯´æ˜æœ‰ä¸¤ä¸ªå…ƒç´   åé¢çš„ s.thread != Thread.currentThread() å°±ä¸åˆ¤æ–­äº† é‚£ä¹ˆè‚¯å®šè¦æ’é˜Ÿ<br>        1.1.2  å¦‚æœ(s = h.next) == null è¿”å›false è¯´æ˜æœ‰å¤šä¸ªå…ƒç´   æ­¤æ—¶ s.thread != Thread.currentThread() å¦‚æœè¿”å›true è¯´æ˜ä¸æ˜¯é‡å…¥ è‚¯å®šè¦æ’é˜Ÿ  å¦‚æœè¿”å›false è¯´æ˜æ˜¯é‡å…¥çš„ é‚£ä¹ˆå¯ä»¥å°è¯•casè·å–é”<br>    1.2: å¦‚æœé˜Ÿåˆ—ä¸­çš„å…ƒç´ åªæœ‰ä¸€ä¸ªï¼Œè¯´æ˜æœ€åä¸€ä¸ªçº¿ç¨‹åŠ é”äº† å‰é¢çš„éƒ½å·²ç»unlockäº†  æ­¤æ—¶ h!=tè¿”å›çš„æ˜¯ false é‚£ä¹ˆç›´æ¥å»casç«äº‰é”</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;synchronized-å®ç°åŸç†&quot;&gt;&lt;a href=&quot;#synchronized-å®ç°åŸç†&quot; class=&quot;headerlink&quot; title=&quot;synchronized å®ç°åŸç†&quot;&gt;&lt;/a&gt;synchronized å®ç°åŸç†&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;synchronizedæ˜¯jvmå±‚é¢çš„ä¸€ç§é”,å¦‚æœæ˜¯å¤šä¸ªjvmåˆ™åªèƒ½åœ¨ä¸€ä¸ªjvmä¸­ç”Ÿæ•ˆ å®ƒèƒ½ä¿è¯æœ‰åºæ€§ã€å¯è§ã€åŸå­æ€§&lt;/li&gt;
&lt;li&gt;synchronizedå¯ä»¥åŠ åœ¨æ–¹æ³•ä¸Š å¯ä»¥æ˜¯ä¸€ä¸ªä»£ç å—ï¼Œwait/notifyä¹Ÿä»¥æ¥monitorå¯¹è±¡ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦ç”¨åœ¨åŒæ­¥ä¸­çš„åŸå› </summary>
    
    
    
    <category term="java" scheme="https://hxq94.github.io/categories/java/"/>
    
    <category term="é”åˆ†æ" scheme="https://hxq94.github.io/categories/java/%E9%94%81%E5%88%86%E6%9E%90/"/>
    
    
    <category term="java" scheme="https://hxq94.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://hxq94.github.io/2022/03/27/hello-world/"/>
    <id>https://hxq94.github.io/2022/03/27/hello-world/</id>
    <published>2022-03-27T10:30:32.722Z</published>
    <updated>2023-04-27T14:17:47.981Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><span id="more"></span><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot;&gt;documentation&lt;/a&gt; for more info. If you get any problems when using Hexo, you can find the answer in &lt;a href=&quot;https://hexo.io/docs/troubleshooting.html&quot;&gt;troubleshooting&lt;/a&gt; or you can ask me on &lt;a href=&quot;https://github.com/hexojs/hexo/issues&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="https://hxq94.github.io/categories/java/"/>
    
    <category term="hello word" scheme="https://hxq94.github.io/categories/java/hello-word/"/>
    
    
    <category term="java" scheme="https://hxq94.github.io/tags/java/"/>
    
  </entry>
  
</feed>
