{"posts":[{"title":"é”åˆ†æ","text":"synchronized å®ç°åŸç† synchronizedæ˜¯jvmå±‚é¢çš„ä¸€ç§é”,å¦‚æœæ˜¯å¤šä¸ªjvmåˆ™åªèƒ½åœ¨ä¸€ä¸ªjvmä¸­ç”Ÿæ•ˆ å®ƒèƒ½ä¿è¯æœ‰åºæ€§ã€å¯è§ã€åŸå­æ€§ synchronizedå¯ä»¥åŠ åœ¨æ–¹æ³•ä¸Š å¯ä»¥æ˜¯ä¸€ä¸ªä»£ç å—ï¼Œwait/notifyä¹Ÿä»¥æ¥monitorå¯¹è±¡ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦ç”¨åœ¨åŒæ­¥ä¸­çš„åŸå›  synchronized æœ€ç»ˆé”ä½çš„æ˜¯ä¸€ä¸ªå¯¹è±¡çš„monitorã€‚javaæ˜¯ç¼–è¯‘æˆä¸ºclassæ–‡ä»¶ jvmæ‹¿åˆ°è¿™ä¸ªclassæ–‡ä»¶åå¯ä»¥å¾—åˆ°è¦æ‰§è¡Œçš„jvmæŒ‡ä»¤ï¼Œä»–ä¼šæŠŠè¿™äº›æŒ‡ä»¤æ ¹æ®c++ä»£ç è§£æåç¿»è¯‘æˆä¸ºæœºå™¨ç  äº¤ç»™æ“ä½œç³»ç»Ÿå»æ‰§è¡Œã€‚ åœ¨jvmåº•å±‚æ“ä½œjvmæŒ‡ä»¤çš„æºç å‘ç° å…¶å®monitoræ˜¯æœ‰ä¸€ä¸ªæ•°æ®ç»“æ„çš„ æ¯”å¦‚owner å­˜æ”¾çš„æ˜¯ç›®å‰å æœ‰é”çš„çº¿ç¨‹ EntryListå­˜æ”¾çš„åç»­æ¥ç«äº‰é”çš„çº¿ç¨‹ WaitSet æ˜¯å­˜æ”¾ä¹‹å‰è·å–è¿‡é”ï¼Œä½†æ˜¯åœ¨WAEIINGçŠ¶æ€çš„çº¿ç¨‹çš„ åœ¨1.5ä¹‹å‰ä»–æ˜¯ç›´æ¥åœ¨æ“ä½œç³»ç»Ÿå±‚é¢åŠ é”ï¼Œæ‰€ä»¥æ¯”è¾ƒé‡ï¼Œåœ¨1.6ä¹‹åå¯ä»¥é€šè¿‡é”å‡çº§æœºåˆ¶æ¥è®©é”çš„æ€§èƒ½æé«˜ å¤§æ¦‚å°±æ˜¯å¯ä»¥ä»æ— é”ã€åå‘é”ã€è½»é‡çº§é”åˆ°æœ€åçš„é‡é‡çº§é”åå‘é”å°±æ˜¯å­˜åœ¨åŒæ­¥ä½†æ— ç«äº‰çš„æƒ…å†µ æ¯”å¦‚springçš„æºç ï¼Œå®ƒé‡Œé¢æœ‰ä¸€äº›æ–¹æ³•åŠ äº†åŒæ­¥ ä½†æ˜¯åŸºæœ¬æ˜¯æ²¡æœ‰ç«äº‰çš„ é‚£è¿™æ ·çš„è¯æ¯æ¬¡ç›´æ¥åˆ¤æ–­ä¸€ä¸‹ownerä¸­çš„çº¿ç¨‹æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå°±å¯ä»¥äº†å‡è®¾å­˜åœ¨å°‘é‡çš„å‡ ä¸ªç«äº‰ é‚£ä¹ˆå°±ä¼šå‡çº§æˆä¸ºè½»é‡çº§é”ï¼Œè½»é‡çº§é”ä»–æ˜¯ä½¿ç”¨äº†casæœºåˆ¶ï¼Œæ²¡æœ‰è·å–åˆ°é”ä¸ä¼šæŒ‚èµ·ç­‰å¾…ï¼Œæ‰€ä»¥å°±ä¸æ¶‰åŠåˆ°cpuè°ƒåº¦ã€çº¿ç¨‹åˆ‡æ¢è¿™äº›æ¯”è¾ƒé‡çš„æ“ä½œï¼Œä»–ä¼šä¸€ç›´ç©ºè½®è®­è‡ªé€‚åº”è‡ªæ—‹ ä½†æ˜¯è¿™æ ·ä¼šè€—è´¹cpuèµ„æºï¼Œæ‰€ä»¥ä¸€æ—¦åˆ¤æ–­è‡ªæ—‹è¶…è¿‡å¤šå°‘æ¬¡ï¼Œå°±ä¼šè§‰å¾—çº¿ç¨‹ç«äº‰å¾ˆå‰å®³ï¼Œå°±è½¬æ¢ä¸ºé‡é‡çº§é” CAS cas æ˜¯æ¯”è¾ƒå’Œäº¤æ¢çš„æ„æ€ æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç° å¯ä»¥è§£å†³å¹¶å‘é—®é¢˜ å®ƒä¸»è¦å®ç°åŸç†æ˜¯è¿™æ ·çš„ æœ‰ä¸€ä¸ªä¸»å­˜ä¸­çš„æœ€ç»ˆç»“æœå€¼ ä»–æ˜¯è¢«valitileä¿®é¥°çš„ è¿˜æœ‰æ¯ä¸€ä¸ªçº¿ç¨‹è¿›æ¥åä¼šæœ‰ä¸€ä¸ªæ‹¿åˆ°çš„å€¼ ä»¥åŠæˆ‘ä»¬è¦ä¿®æ”¹çš„å€¼æ¯”å¦‚ ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘äº† ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°æ˜¯50 ç¬¬äºŒä¸ªçº¿ç¨‹æ‹¿åˆ°çš„ä¹Ÿæ˜¯50 è¦ä¿®æ”¹æˆ60åœ¨ä¿®æ”¹æˆ60çš„æ—¶å€™ä¼šæŠŠå½“å‰æ‹¿åˆ°çš„å€¼è·Ÿå†…å­˜ä¸­çš„ç»“æœå€¼æ¯”è¾ƒä¸€ä¸‹ å¦‚æœä¸€æ ·ï¼Œæ‰ä¿®æ”¹æˆåŠŸé‚£ä¹ˆæ­¤æ—¶è¿™ä¸ªåœºæ™¯å°±æ˜¯açº¿ç¨‹æ‹¿åˆ°50 è¿›è¡Œä¿®æ”¹ åˆ¤æ–­50å’Œå†…å­˜ä¸­çš„50ä¸€è‡´ ä¿®æ”¹æˆåŠŸ å†…å­˜ä¸­å€¼å˜ä¸º60bçº¿ç¨‹æ‹¿åˆ°çš„ä¹Ÿæ˜¯50 è¿›è¡Œä¿®æ”¹ åˆ¤æ–­50å’Œå½“å‰å†…å­˜å€¼60 ä¸ä¸€è‡´ ä¿®æ”¹å¤±è´¥ è¿™æ ·å°±ä½¿ç”¨casè§£å†³äº†å¹¶å‘é—®é¢˜ä½†æ˜¯casä¼šæœ‰ä¸¤ä¸ªé—®é¢˜ : åŸå­æ€§é—®é¢˜å’ŒABAé—®é¢˜åŸå­æ€§é—®é¢˜ï¼šåˆ¤æ–­å’Œä¿®æ”¹æ˜¯ä¸¤æ­¥æ“ä½œ çœ‹åº•å±‚æ˜¯ä½¿ç”¨çš„lockå®ç° æ‰€ä»¥è§£å†³åŸå­æ€§é—®é¢˜ABAé—®é¢˜ï¼š å‡è®¾æœ‰ä¸‰ä¸ªçº¿ç¨‹ a,b,c å¹¶å‘äº†açº¿ç¨‹è¦æŠŠ100å˜ä¸º50 bçº¿ç¨‹ä¹Ÿè¦æŠŠ100å˜ä¸º50 cçº¿ç¨‹è¦æŠŠ50å˜ä¸º100å‡è®¾æ­¤æ—¶açº¿ç¨‹ æˆåŠŸæ‰§è¡Œäº† bçº¿ç¨‹åˆšæ‰§è¡Œå®Œå’Œaæ‹¿åˆ°100è¿™ä¸ªæ­¥éª¤ï¼Œé˜»å¡äº†ï¼›æ­¤æ—¶cçº¿ç¨‹æ‰§è¡Œ50å˜100æ“ä½œæˆåŠŸï¼Œä¹Ÿå°±åœ¨æ­¤æ—¶bçº¿ç¨‹æ¢å¤äº† åˆæŠŠ100 å˜æˆäº†50 ï¼›è¿™å°±å‡ºç°äº†é—®é¢˜å¦‚æœè¦è§£å†³çš„è¯ éœ€è¦åŠ ä¸€ä¸ªç‰ˆæœ¬å· æ›´æ–°çš„æ—¶å€™æŠŠç‰ˆæœ¬å·æ›´æ–°+1 ä¸”åˆ¤æ–­æ¡ä»¶åŠ ä¸Šç‰ˆæœ¬åˆ¤æ–­ LongAdder å’Œ AtomicIntergerAtomicInterger å®ç°äº†casæ“ä½œLongAdder æ˜¯ä¼˜åŒ–åçš„cas åŸç†æ˜¯æŠŠæ•°æ®åˆ†æ®µåä½œcas++ ä¼šæ ¹æ®æ¥çš„çº¿ç¨‹å¤šå°‘åŠ¨æ€çš„æ‰©ç¼©æ•°æ®åˆ†æ®µ æœ€åå†åšç´¯åŠ  åˆ†å¤šå°‘æ®µå…¶å®ç†è®ºä¸Šæ€§èƒ½å°±æé«˜å¤šå°‘å€threadLocalä¹Ÿèƒ½è§£å†³ å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€å˜é‡çš„é—®é¢˜ åˆ†å¸ƒå¼é” å¤šä¸ªjvmçš„æ—¶å€™ä½¿ç”¨åˆ†å¸ƒå¼é” æœ‰å¤šä¸ªå®ç°ç‰ˆæœ¬ åŸºäºmysqlçš„ redisçš„ zookeeperçš„ åˆ†å¸ƒå¼é”ä½¿ç”¨æœ€åŸºç¡€ç‰ˆæœ¬çš„redisçš„è¯ éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼ˆ1ï¼‰åœ¨è®¾ç½®keyçš„æ—¶å€™è¦æŠŠvalueè®¾ç½®ä¸ºèƒ½æ ‡è¯†å½“å‰çº¿ç¨‹çš„å€¼ï¼ˆ2ï¼‰ä¸”è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ˜¯setnxåŸå­æ“ä½œï¼ˆ3ï¼‰é‡Šæ”¾é”è¦å†™åˆ°finallyé‡Œé¢ é‡Šæ”¾é”çš„æ—¶å€™è¦åˆ¤æ–­æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰çš„é”æ‰é‡Šæ”¾ é¿å…é‡Šæ”¾æ‰å…¶ä»–çº¿ç¨‹çš„é” ä¸”è¿™ä¸¤æ­¥è¦æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ ä½¿ç”¨luaè„šæœ¬æ¥å®ç°ï¼ˆ4ï¼‰è¦æä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œå‡è®¾é”å†…ä¸šåŠ¡é€»è¾‘æ²¡æœ‰æ‰§è¡Œå®Œ è¦ç»­è¿‡æœŸæ—¶é—´ åŸºäºä»¥ä¸Šé—®é¢˜ redsiå¸®åŠ©æˆ‘ä»¬å°è£…äº†ä¸€ä¸ªredissonå®¢æˆ·ç«¯ å¸®åŠ©æˆ‘ä»¬å°è£…äº†ä»¥ä¸Šæ“ä½œ ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯redisé›†ç¾¤ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªé—®é¢˜ ä¸»ä»åŒæ­¥åœºæ™¯çš„æ—¶å€™ å¦‚æœåˆšç»™masterä¸Šé”æˆåŠŸ masterç»™slaveåŒæ­¥æ•°æ®çš„æ—¶å€™æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆæ­¤æ—¶å†è·å–é”çš„æ—¶å€™ï¼Œåœ¨ä»èŠ‚ç‚¹æ˜¯è·å–ä¸åˆ°é”çš„ï¼Œå› ä¸ºredisçš„æ¨¡å‹æ˜¯AP,åªèƒ½ä¿è¯å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œä¿è¯ä¸äº†ä¸€è‡´æ€§ æ‰€ä»¥æ­¤æ—¶åº”è¯¥è€ƒè™‘ä½¿ç”¨redlockå»å®Œæˆåˆ†å¸ƒå¼é”çš„æ·»åŠ ï¼Œä½†æ˜¯ç½‘ä¸Šæœ‰redlockçš„é—®é¢˜ï¼Œæ‰€ä»¥åšåˆ†å¸ƒå¼é”è¿˜æ˜¯åº”è¯¥ä¼˜å…ˆè€ƒè™‘zookeeper å¦‚æœæ˜¯åœ¨åˆ é™¤é”çš„æ—¶å€™æ²¡æœ‰ç”¨luaè„šæœ¬ä¹Ÿæ˜¯ä¼šæœ‰é—®é¢˜çš„ï¼šæ¯”å¦‚åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€çº¿ç¨‹æŒæœ‰çš„é”å·²ç»é€šè¿‡äº† açº¿ç¨‹æ­¤æ—¶å¼€å§‹é˜»å¡ åˆšå¥½è¿™æ—¶å€™é€šè¿‡è¿‡æœŸæ—¶é—´è¿‡æœŸäº†é”ï¼Œé‚£ä¹ˆçº¿ç¨‹bæ‹¿åˆ°é”ï¼Œæ­¤æ—¶açº¿ç¨‹å¼€å§‹æ‰§è¡Œ å°±ä¼šæŠŠçº¿ç¨‹bçš„é”é‡Šæ”¾æ‰ ä¸ºä»€ä¹ˆè¦é€‰æ‹©zookeeper å› ä¸ºzookeeperæ˜¯åŸºäºCPæ¨¡å‹çš„æ•°æ®æ¨¡å‹ï¼Œzabæ¥ä¿è¯ä¸€è‡´æ€§é—®é¢˜ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´zookerperæ¯”redisæ€§èƒ½ä½ï¼Œä½†æ˜¯æˆ‘ä»¬çš„åœºæ™¯åˆæ˜¯é«˜å¹¶å‘ä¸‹çš„åˆ†å¸ƒå¼é”é—®é¢˜ï¼Œ å¦‚æœå¯¹äºå¹¶å‘å‡ºç°çš„é—®é¢˜ä¸èƒ½å®¹å¿ï¼Œé‚£ä¹ˆåº”è¯¥ä¼˜å…ˆé€‰ç”¨zookeeperï¼Œå¹¶ä¸”redlock éœ€è¦è‡³å°‘5ä¸ªèŠ‚ç‚¹ ä»æ•ˆç‡ä¸Šè¯´å…¶å®ä¹Ÿä¸å¿«äº† ç‰µæ‰¯åˆ°çš„ä¸€ä¸ªç§’æ€æƒ…å†µä¸‹ä½¿ç”¨åˆ†å¸ƒå¼é”çš„æ€§èƒ½é—®é¢˜ å…¶å®è¿˜æ˜¯åˆ†æ®µæ€æƒ³ï¼Œå°†åº“å­˜åˆ†å¸ƒåœ¨ä¸åŒçš„é”ä¸­ï¼Œé‚£ä¹ˆæ€§èƒ½ä¼šæç¤ºå¾ˆå¤š å¯ä»¥è§£å†³ç¼“å­˜å’Œæ•°æ®åº“åŒå†™ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆå¸‚é¢ä¸Šæœ‰å»¶æ—¶åŒåˆ ã€å†…å­˜é˜Ÿåˆ—ï¼Œä¼˜åŒ–å¯ä»¥ä½¿ç”¨è¯»å†™é”ï¼‰ AQSå¯é‡å…¥é” é”çš„ä¸€ä¸ªå…³é”®å°±æ˜¯ æœ‰å¹¶å‘ å¹¶ä¸”æœ‰ç«äº‰ å…¬å¹³é”åˆ¤æ–­stateä¸º0çš„æ—¶å€™ ä¸èƒ½ç›´æ¥casè·å–é” å› ä¸ºæ˜¯å…¬å¹³é”ï¼Œæ­¤æ—¶å¯èƒ½æœ‰å¾ˆå¤šçº¿ç¨‹å·²ç»åœ¨æ’é˜Ÿäº† å…¶å®ƒçº¿ç¨‹å…¥é˜Ÿæ—¶å€™ ä»–è¦è‡ªæ—‹2æ¬¡ï¼Œè‡ªæ—‹ä¸¤æ¬¡çš„æ—¶å€™ä¼šå°è¯•è·å–é” æ¯”å¦‚æœ‰ä¸‰ä¸ªçº¿ç¨‹ æ­¤æ—¶ç¬¬ä¸€ä¸ªå·²ç»é‡Šæ”¾äº†ï¼Œç¬¬äºŒä¸ªå°±ä¼šæ‹¿åˆ°é” ä¸”å˜ä¸ºthread==nullçš„headèŠ‚ç‚¹ï¼Œä½†æ˜¯æ­¤æ—¶ç¬¬ä¸‰ä¸ªçº¿ç¨‹æ¥äº† åœ¨å…¥é˜Ÿè¿‡ç¨‹ä¸­ä»–è¦è‡ªæ—‹ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šåˆ¤æ–­ï¼šæ¥è¯¢é—®èƒ½å¦è·å–åˆ°é”çš„çº¿ç¨‹ï¼Œæ˜¯ä¸æ˜¯é™¤å»thread==nullé‚£ä¸ªèŠ‚ç‚¹çš„ç¬¬äºŒä¸ªèŠ‚ç‚¹ å¦‚æœä¸æ˜¯thread==nullçš„é‚£ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹ è‚¯å®šä¸èƒ½è·å–é” ç¬¬äºŒä¸ªçº¿ç¨‹æ¥å…¥é˜Ÿçš„æ—¶å€™ä¼šè¿›è¡Œè‡ªæ—‹ è‡ªæ—‹çš„æ—¶å€™ä¼šåˆ¤æ–­ï¼šé”æ˜¯è‡ªç”±çŠ¶æ€ ä¸”å»ç«äº‰çš„çº¿ç¨‹æ˜¯thread==nullåé¢çš„èŠ‚ç‚¹çš„çº¿ç¨‹æ‰æœ‰èµ„æ ¼è¿›è¡Œcasè·å–é” å¯é‡å…¥çš„æ—¶å€™ä¹Ÿä¼šåˆ¤æ–­æŒæœ‰é”çš„çº¿ç¨‹æ°¸è¿œä¸åœ¨é˜Ÿåˆ—ä¸­ return h != t &amp;&amp; ((s = h.next) == null || s.thread != Thread.currentThread()); ç¬¬ä¸€ç§ï¼šé˜Ÿåˆ—æ²¡æœ‰åˆå§‹åŒ– h!=t è¿”å›false è¿”å›false æ„å‘³ç€å¯ä»¥å°è¯•casè·å–é”ç¬¬äºŒç§ï¼šå¦‚æœé˜Ÿåˆ—åˆå§‹åŒ–äº†ï¼Œåˆå§‹åŒ–å åˆ†ä¸¤ç§æƒ…å†µ 1.1: å¦‚æœé˜Ÿåˆ—ä¸­çš„å…ƒç´ æ¯”è¾ƒå¤š é‚£ä¹ˆh!t è¿”å›true è¿”å›true è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µ 1.1.1 å¦‚æœ(s = h.next) == null è¿”å›true è¯´æ˜æœ‰ä¸¤ä¸ªå…ƒç´  åé¢çš„ s.thread != Thread.currentThread() å°±ä¸åˆ¤æ–­äº† é‚£ä¹ˆè‚¯å®šè¦æ’é˜Ÿ 1.1.2 å¦‚æœ(s = h.next) == null è¿”å›false è¯´æ˜æœ‰å¤šä¸ªå…ƒç´  æ­¤æ—¶ s.thread != Thread.currentThread() å¦‚æœè¿”å›true è¯´æ˜ä¸æ˜¯é‡å…¥ è‚¯å®šè¦æ’é˜Ÿ å¦‚æœè¿”å›false è¯´æ˜æ˜¯é‡å…¥çš„ é‚£ä¹ˆå¯ä»¥å°è¯•casè·å–é” 1.2: å¦‚æœé˜Ÿåˆ—ä¸­çš„å…ƒç´ åªæœ‰ä¸€ä¸ªï¼Œè¯´æ˜æœ€åä¸€ä¸ªçº¿ç¨‹åŠ é”äº† å‰é¢çš„éƒ½å·²ç»unlockäº† æ­¤æ—¶ h!=tè¿”å›çš„æ˜¯ false é‚£ä¹ˆç›´æ¥å»casç«äº‰é”","link":"/2022/06/04/%E9%94%81%E5%88%86%E6%9E%90/"},{"title":"å‘½ä»¤","text":"ä»Šå¤©æ•´äº†ä¸‹ä»“åº“ï¼Œå’Œç”µè„‘ä¸Šçš„æ–‡ä»¶ï¼Œå‘ç°æœ‰å¾ˆå¤šæ˜¯é›¶æ•£çš„ï¼Œä¸æ˜¯å¤ªè§„æ•´ï¼ˆè™½ç„¶ä¹‹å‰ä¹Ÿä¸æ˜¯ä¹±æ”¾çš„ï¼‰ï¼Œä½†æ˜¯æ–‡ä»¶å¤šäº†å°±æœ‰ç‚¹ä¹±äº†ï¼Œä»Šå¤©æŠ½ç©ºæŠŠé¡¹ç›®æ•´ç†ä¸‹ å¸¸ç”¨å‘½ä»¤mac åˆ‡æ¢jdkç‰ˆæœ¬ mac åˆ‡æ¢jdkç‰ˆæœ¬ 123456# .zshrcæ–‡ä»¶ä¸­ æ·»åŠ ä»¥ä¸‹é…ç½®:export JAVA_8_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk1.8.0_261.jdk/Contents/Home&quot;export JAVA_17_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk-17.jdk/Contents/Home&quot;export JAVA_HOME=$JAVA_8_HOMEalias jdk8=&quot;export JAVA_HOME=$JAVA_8_HOME&quot;alias jdk17=&quot;export JAVA_HOME=$JAVA_17_HOME&quot; ç„¶åæ‰§è¡Œ 1source ~/.zshrc kafkaå¿«é€Ÿä½“éªŒdocker-compose kafkaå¿«é€Ÿä½“éªŒdocker-compose 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647version: &quot;4&quot;services: zookeeper: image: 'bitnami/zookeeper:latest' ports: - '2181:2181' environment: # åŒ¿åç™»å½•--å¿…é¡»å¼€å¯ - ALLOW_ANONYMOUS_LOGIN=yes #volumes: #- ./zookeeper:/bitnami/zookeeper # è¯¥é•œåƒå…·ä½“é…ç½®å‚è€ƒ https://github.com/bitnami/bitnami-docker-kafka/blob/master/README.md kafka: image: 'bitnami/kafka:2.8.0' container_name: 'small-kafka' ports: - '9092:9092' - '9999:9095' environment: - KAFKA_BROKER_ID=1 - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092 # å®¢æˆ·ç«¯è®¿é—®åœ°å€ï¼Œæ›´æ¢æˆè‡ªå·±çš„ - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://192.168.26.100:9092 - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181 # å…è®¸ä½¿ç”¨PLAINTEXTåè®®(é•œåƒä¸­é»˜è®¤ä¸ºå…³é—­,éœ€è¦æ‰‹åŠ¨å¼€å¯) - ALLOW_PLAINTEXT_LISTENER=yes # å…³é—­è‡ªåŠ¨åˆ›å»º topic åŠŸèƒ½ - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=false # å…¨å±€æ¶ˆæ¯è¿‡æœŸæ—¶é—´ 6 å°æ—¶(æµ‹è¯•æ—¶å¯ä»¥è®¾ç½®çŸ­ä¸€ç‚¹) - KAFKA_CFG_LOG_RETENTION_HOURS=6 # å¼€å¯JMXç›‘æ§ # - JMX_PORT=9999 #volumes: #- ./kafka:/bitnami/kafka depends_on: - zookeeper # Web ç®¡ç†ç•Œé¢ å¦å¤–ä¹Ÿå¯ä»¥ç”¨exporter+prometheus+grafanaçš„æ–¹å¼æ¥ç›‘æ§ https://github.com/danielqsj/kafka_exporter kafka_manager: image: 'hlebalbau/kafka-manager:latest' ports: - &quot;9000:9000&quot; environment: ZK_HOSTS: &quot;zookeeper:2181&quot; APPLICATION_SECRET: letmein depends_on: - zookeeper - kafka æŸ¥çœ‹git config123ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰çš„é…ç½®ä»¥åŠå®ƒä»¬æ‰€åœ¨çš„æ–‡ä»¶ï¼š$ git config --list --show-origin å¤‡ä»½hexo12345678910111. å…ˆæ‹‰ä¸€ä¸ªæ–°çš„åˆ†æ”¯åšå¤‡ä»½ï¼Œæˆ‘è¿™é‡Œå«hexo2. ç”±äºhexoå…¶å®æäº¤åˆ°gitçš„æ˜¯.depoy.gitçš„ä¸œè¥¿ï¼Œblogä¸‹æ˜¯æ²¡æœ‰.gitçš„æ‰€ä»¥æˆ‘ä»¬å…ˆè¦åœ¨blog çš„æ ¹ç›®å½• æ‰§è¡Œ git init3. ç”±äºæ­¤æ—¶è¿˜æ²¡æœ‰å’Œè¿œç¨‹å…³è”èµ·æ¥ï¼Œæ‰€ä»¥è¦æ‰§è¡Œ git remote add origin git@github.com:hxq94/hxq94.github.io.git4. ç„¶åæ‰§è¡Œgit remote -v æŸ¥çœ‹æ˜¯å¦å·²ç»å…³è”5. ç„¶ågit fetch 6. git checkout hexo5. ç„¶åæ‰§è¡Œgit add .6. å¯ä»¥ä½¿ç”¨git status æŸ¥çœ‹æ·»åŠ çš„æ–‡ä»¶7. ç„¶ågit commit -m &quot;init&quot;8. ç„¶ågit push -u origin hexo æ¢å¤hexo123451. git clone &quot;git@github.com:hxq94/hxq94.github.io.git&quot;2. npm install hexo-cli3. npm install4. npm install hexo-deployer-git5. å’Œä¹‹å‰ä¸€æ · hexo clean g d","link":"/2023/12/23/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"},{"title":"netty","text":"nio è™½ç„¶ä½¿ç”¨äº†å¤šè·¯å¤ç”¨ï¼Œä½†æ˜¯çœŸæ­£å®ç°ä¸€ä¸ªç½‘ç»œç¼–ç¨‹è¿˜éœ€è¦è€ƒè™‘å¾ˆå¤šé—®é¢˜ï¼Œæ‰€ä»¥å‡ºç°äº†nettyè¿™ç§åŸºäºnioçš„ç½‘ç»œç¼–ç¨‹æ¡†æ¶ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬ç®€åŒ–å¼€å‘ç½‘ç»œç›¸å…³é—®é¢˜çš„éš¾åº¦ï¼Œnettyä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼æ¥æ¥æ”¶å„ç§äº‹ä»¶ï¼Œå¹¶æä¾›é“¾å¼pipelineçš„æ–¹å¼å¸®åŠ©æˆ‘ä»¬å¤„ç†æ•°æ®ï¼Œå¹¶ä¸”å¢å¼ºäº†nioçš„ByteBufferï¼Œè¿˜æä¾›äº†ä¸€ç³»åˆ—ä¾‹å¦‚å¿ƒè·³ã€å¼‚æ­¥ç­‰æ–¹å¼æ¥å¸®åŠ©æˆ‘ä»¬æ„å»ºä»£ç  nettyæ¶æ„ä»ç½‘ä¸Šæ‰¾äº†ä¸¤å¼ å›¾ï¼Œnettyçš„æ€»ä½“æ¶æ„ï¼Œä»¥åŠnettyçš„çº¿ç¨‹æ¨¡å‹å¦‚ä¸‹ è¿™å¼ å›¾è¡¨æ˜äº†nettyå¯ä»¥æœ‰å¤šä¸ªeventloopGroup æ¯ä¸ªeventLoopGroupä¸­åŒ…å«å¤šä¸ªeventLoopï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¼‚æ­¥æ‰§è¡Œä¸€äº›ioäº‹ä»¶ï¼Œå¹¶ä¸”è¿˜è¡¨æ˜nettyä¸­æœ‰å¤šæ¡æµæ°´çº¿ï¼Œå…¶ä¸­æ¯ä¸ªæµæ°´çº¿piplineéƒ½å¿…ç„¶æœ‰ä¸€ä¸ªheadå’Œtailçš„åŒå‘é“¾è¡¨æ¥å¯¹åº”å…¥ç«™å’Œå‡ºç«™ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå‡ºæˆ˜éœ€è¦ç¼–ç ï¼Œå…¥ç«™éœ€è¦è§£ç ï¼Œå¦‚æœpipelineä¸Šçš„äº‹ä»¶éœ€è¦å¤„ç†å¾ˆä¹…ï¼Œé‚£ä¹ˆå¯ä»¥äº¤ç»™é“¾ä¸Šçš„ä¸‹ä¸€ä¸ªå¤„ç†å™¨å¤„ç†ï¼Œä¹Ÿå¯ä»¥æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œï¼Œè¿™æ ·å˜ç›¸æé«˜äº†å¤„ç†é€Ÿåº¦ é€šè¿‡eventLoopå¯ä»¥æ‹¿åˆ°channelï¼Œè¿›è€Œå¤„ç†æˆ‘ä»¬çš„ioäº‹ä»¶ ä¸Šä¸€ä¸ªæ —å­æœ€ç®€å•çš„nettyæœåŠ¡å™¨ä¸€ä¸ªç®€å•çš„nettyçš„ç½‘ç»œç¼–ç¨‹ğŸŒ° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122// æœåŠ¡å™¨ç«¯package com.hyf.demo.netty;import io.netty.bootstrap.ServerBootstrap;import io.netty.buffer.ByteBuf;import io.netty.channel.*;import io.netty.channel.nio.NioEventLoopGroup;import io.netty.channel.socket.nio.NioServerSocketChannel;import io.netty.channel.socket.nio.NioSocketChannel;import io.netty.handler.codec.string.StringDecoder;import io.netty.handler.logging.LogLevel;import io.netty.handler.logging.LoggingHandler;import lombok.extern.slf4j.Slf4j;import java.nio.charset.Charset;@Slf4jpublic class NettyServerDemo { public static void main(String[] args) throws InterruptedException { // å¯ä»¥ç»™æŸä¸ªhandleræŒ‡å®šç‰¹å®šçš„NioEventLoopGroup EventLoopGroup defaultEventLoopGroup = new DefaultEventLoopGroup(); // çº¿ç¨‹æ•°é»˜è®¤æ˜¯è¿™ä¹ˆå¤š private static final int DEFAULT_EVENT_LOOP_THREADS = Math.max(1, SystemPropertyUtil.getInt(&quot;io.netty.eventLoopThreads&quot;, NettyRuntime.availableProcessors() * 2)); ChannelFuture channelFuture = new ServerBootstrap() // ä¸€ä¸ªåªå¤„ç†accept äº‹ä»¶ ä¸€ä¸ªå¤„ç†å…¶ä»–äº‹ä»¶ acceptäº‹ä»¶çš„NioEventLoopGroupä¸ç®¡è®¾ç½®å‡ ï¼Œå…¶å®åˆ°æœ€åéƒ½æ˜¯1 .group(new NioEventLoopGroup(2), new NioEventLoopGroup(2)) .channel(NioServerSocketChannel.class) // è¿™é‡Œæ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™SocketChannelçš„ è€Œä¸æ˜¯ç»™ServerSocketChannelçš„ .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() { @Override protected void initChannel(NioSocketChannel nioSocketChannel) throws Exception { // åŠ ä¸ªæ—¥å¿— nioSocketChannel.pipeline().addLast(new LoggingHandler()); // æ‹¿åˆ°pipeline è®¾ç½®è§£ç å™¨// nioSocketChannel.pipeline().addLast(new StringDecoder()); // è¿™é‡Œä¸ºä»€ä¹ˆç”¨ChannelInboundHandlerAdapter è€Œä¸æ˜¯ChannelInboundHandler // æ˜¯å› ä¸ºä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼ï¼Œå¯ä»¥æŒ‡å®šå“ªäº›æ–¹æ³•æˆ‘å¯ä»¥å®ç°ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶å®ç° // è¿™é‡Œå¦‚æœæ–¹æ³•è¦å‘ä¸‹ä¼ é€’ å…¶å®å¯ä»¥ä½¿ç”¨ChannelInboundHandlerAdapter å¦‚æœè¦ç›´æ¥é‡Šæ”¾ å¯ä»¥ä½¿ç”¨SimpleChannelInboundHandler nioSocketChannel.pipeline().addLast(&quot;handler1&quot;, new ChannelInboundHandlerAdapter() { @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { ByteBuf buf = (ByteBuf) msg; log.info(buf.toString(Charset.defaultCharset())); // ä¼šå‘ä¸‹ä¸€ä¸ªhandlerä¼ é€’æ•°æ® // ç°åœ¨ä½¿ç”¨çš„ChannelInboundHandlerAdapter æ‰€ä»¥éœ€è¦è°ƒç”¨è¿™ä¸€å¥ å¦‚æœæ˜¯SimpleChannelInboundHandlerå°±ä¸éœ€è¦äº† ctx.fireChannelRead(msg); } }).addLast(defaultEventLoopGroup, &quot;handler2&quot;, new ChannelInboundHandlerAdapter() { @Override public void channelRead(ChannelHandlerContext channelHandlerContext, Object msg) throws Exception { ByteBuf buf = (ByteBuf) msg; // è¿™é‡Œæ‰“å‡ºçš„çº¿ç¨‹å’Œhandler1 æ‰“å‡ºæ¥çš„ä¸ä¸€æ · log.info(buf.toString(Charset.defaultCharset())); } }); } // ç»‘å®šæœåŠ¡ç«¯ç«¯å£ }).bind(9999); // èƒ½åœ¨å…³é—­ååšä¸€äº›å¤„ç† channelFuture.channel().closeFuture().sync(); // ç¡®ä¿æ˜¯åœ¨è¿æ¥å…³é—­åšçš„å¤„ç† log.info(&quot;close do something...&quot;); // ä¼˜é›…å…³é—­ä¸€äº›eventLoopGroupä¸­çš„çº¿ç¨‹ defaultEventLoopGroup.shutdownGracefully(); }}// client package com.hyf.demo.netty;import io.netty.bootstrap.Bootstrap;import io.netty.channel.Channel;import io.netty.channel.ChannelFuture;import io.netty.channel.ChannelInitializer;import io.netty.channel.nio.NioEventLoopGroup;import io.netty.channel.socket.nio.NioSocketChannel;import io.netty.handler.codec.string.StringEncoder;import io.netty.handler.logging.LoggingHandler;import lombok.extern.slf4j.Slf4j;@Slf4jpublic class NettyClientDemo { public static void main(String[] args) throws InterruptedException { NioEventLoopGroup eventExecutors = new NioEventLoopGroup(2); ChannelFuture channelFuture = new Bootstrap().group(eventExecutors) .channel(NioSocketChannel.class) .handler(new ChannelInitializer&lt;Channel&gt;() { @Override protected void initChannel(Channel channel) throws Exception { channel.pipeline().addLast(new LoggingHandler()); channel.pipeline().addLast(new StringEncoder()); } } ) // å¼‚æ­¥éé˜»å¡ .connect(&quot;localhost&quot;, 9999) // ç”±äºnettyä¸­éƒ½æ˜¯å¼‚æ­¥çš„ æ‰€ä»¥è¦syncç­‰å¾… .sync() // è·å–æŠ½è±¡è¿‡åçš„channelé€šé“ .channel() // å†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº .writeAndFlush(&quot;hello&quot;); // èƒ½åœ¨å…³é—­ååšä¸€äº›å¤„ç† channelFuture.channel().closeFuture().sync(); // ç¡®ä¿æ˜¯åœ¨è¿æ¥å…³é—­åšçš„å¤„ç† log.info(&quot;close do something...&quot;); // ä¼˜é›…å…³é—­ä¸€äº›eventLoopGroupä¸­çš„çº¿ç¨‹ eventExecutors.shutdownGracefully(); }} ä¸Šé¢è¿™ä¸ªä¾‹å­æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„æœåŠ¡å™¨ã€å®¢æˆ·ç«¯ç¼–ç¨‹æ¨¡ç‰ˆä»£ç ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬çš„ä»£ç ä¹Ÿå°±æ˜¯æ ¹æ®è¿™ä¸ªæ¨¡ç‰ˆæ¥æ‰©å±•äº†ï¼Œä»–çš„å…·ä½“æµç¨‹å¦‚ä¸‹ ä»£ç æµç¨‹å›¾ ä»¥ä¸Šæµç¨‹è¯´æ˜äº†ä»¥ä¸‹å‡ ç‚¹ nettyæ˜¯å¼‚æ­¥çš„ï¼Œå¯ä»¥åˆ†é…workGroup çº¿ç¨‹æ±  å’Œ boosGroupçº¿ç¨‹æ± ï¼Œå¯åŠ¨æ˜¯é€šè¿‡BootStrapæ¥å¯åŠ¨çš„ NioEventLoopGroup æä¾›äº†nextæ¥å£ï¼Œå¯ä»¥æŒ‰ç…§è´Ÿè½½å‡è¡¡ç­–ç•¥æ¥æŒ‡å®šå“ªä¸ªNioEventLoopæ¥å·¥ä½œ å› ä¸ºå®ç°äº†ScheduledExecutorService æ‰€ä»¥å¯ä»¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€æ™®é€šä»»åŠ¡ ä»¥åŠIoäº‹ä»¶çš„å¤„ç† ä½†æ˜¯DefaultEventLoopGroupå¤„ç†ä¸äº†IOäº‹ä»¶ æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“ æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆâ€¦ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰ handler åˆ† Inbound å’Œ Outbound ä¸¤ç±» æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰ å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº ByteBuf ByteBufæ˜¯nettyåœ¨nio ByteBufferä¸Šåšçš„å¢å¼º é’ˆå¯¹äºByteBuf æœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ ByteBufå¯ä»¥å¼€è¾Ÿç›´æ¥å†…å­˜ ä¹Ÿå¯ä»¥å¼€è¾Ÿå †å†…å­˜ ç›´æ¥å†…å­˜éœ€è¦æ‰‹åŠ¨ç®¡ç†é‡Šæ”¾ ByteBufå…·å¤‡æ± åŒ–å’Œéæ± åŒ–èƒ½åŠ› æ± åŒ–æé«˜å·¥ä½œæ•ˆç‡ï¼Œä½†æ˜¯å¤æ‚åº¦å˜é«˜ å¯ä»¥ä½¿ç”¨sliceåˆ‡ç‰‡ æ¥æ¨¡æ‹ŸåŠåŒ…ç°è±¡ ä»–æœ‰å¾ˆå¤šå’Œé›¶æ‹·è´ç›¸å…³çš„ç±»ï¼Œæ¯”å¦‚copy\\duplicate\\sliceç­‰ ç²˜åŒ…åŠåŒ…ç°è±¡åŸå› ç²˜åŒ…åŠåŒ…å‡ºç°çš„åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ åº”ç”¨å±‚æœ‰æ¥æ”¶å’Œå‘é€ç¼“å†²åŒºé™åˆ¶ ä¼ è¾“å±‚æœ‰æ»‘åŠ¨çª—å£æœºåˆ¶ ç½‘ç»œå±‚æœ‰MTU MCCé™åˆ¶ ç²˜åŒ…åŠåŒ…è§£å†³æ–¹æ¡ˆåœ¨nettyä¸­æœ‰ä»¥ä¸‹å‡ ç§è§£å†³æ–¹æ¡ˆ çŸ­è¿æ¥ æ¯æ¬¡å‘é€å®Œæ•°æ®å°±æ–­å¼€è¿æ¥ å¯ä»¥è§£å†³ç²˜åŒ…é—®é¢˜ è§£å†³ä¸äº†åŠåŒ…é—®é¢˜ nettyæä¾›çš„å®šé•¿è§£ç å™¨ ï¼Œå¯ä»¥è§£å†³é—®é¢˜ ä½†æ˜¯æµªè´¹ç©ºé—´ åˆ†éš”ç¬¦è§£ç å™¨ ï¼Œå¯ä»¥è§£å†³é—®é¢˜ ä½†æ˜¯æ•ˆç‡ä½ éœ€è¦æ‰¾åˆ°åˆ†éš”ç¬¦ å¸§è§£ç å™¨:LengthFieldBasedFrameDecoder è¿™ä¸ªè§£ç å™¨æä¾›çš„å‚æ•°è§£é‡Šå¦‚ä¸‹ maxFrameLength è¶…è¿‡è¿™ä¸ªé•¿åº¦äº†è¿˜æ²¡å®Œ å°±æŠ¥é”™ lengthFieldOffset é•¿åº¦å­—æ®µåç§»é‡ï¼ˆå°±æ˜¯ä»£è¡¨å®é™…å†…å®¹æœ‰å¤šé•¿çš„çš„é•¿åº¦å­—æ®µæ˜¯ä»ç¬¬å‡ ä¸ªå­—èŠ‚å¼€å§‹çš„ï¼‰ lengthFieldLength ç”¨æ¥è®°å½•å†…å®¹é•¿åº¦çš„å­—æ®µçš„å®é™…å­—èŠ‚æ˜¯å¤šå°‘ lengthAdjustment é•¿åº¦å­—æ®µä¸ºåŸºå‡† è¿˜æœ‰å‡ ä¸ªå­—æ®µæ˜¯å†…å®¹ initialBytesToStrip ä»å¤´å‰¥ç¦»å‡ ä¸ªå­—èŠ‚ï¼ˆç›¸å½“äºåœ¨æœ€ç»ˆçš„ç»“æœæ˜¯æ²¡æœ‰å‰¥ç¦»çš„é‚£å‡ ä¸ªå­—èŠ‚çš„ï¼‰ è‡ªå®šä¹‰httpåè®®çš„ä¸€ä¸ªä¾‹å­ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152 NioEventLoopGroup boss = new NioEventLoopGroup();NioEventLoopGroup worker = new NioEventLoopGroup();try { ServerBootstrap serverBootstrap = new ServerBootstrap(); serverBootstrap.channel(NioServerSocketChannel.class); serverBootstrap.group(boss, worker); serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override protected void initChannel(SocketChannel ch) throws Exception { ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG)); ch.pipeline().addLast(new HttpServerCodec()); ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;HttpRequest&gt;() { @Override protected void channelRead0(ChannelHandlerContext ctx, HttpRequest msg) throws Exception { // è·å–è¯·æ±‚ log.debug(msg.uri()); // è¿”å›å“åº” DefaultFullHttpResponse response = new DefaultFullHttpResponse(msg.protocolVersion(), HttpResponseStatus.OK); byte[] bytes = &quot;&lt;h1&gt;Hello, world!&lt;/h1&gt;&quot;.getBytes(); response.headers().setInt(CONTENT_LENGTH, bytes.length); response.content().writeBytes(bytes); // å†™å›å“åº” ctx.writeAndFlush(response); } }); /*ch.pipeline().addLast(new ChannelInboundHandlerAdapter() { @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { log.debug(&quot;{}&quot;, msg.getClass()); if (msg instanceof HttpRequest) { // è¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´ } else if (msg instanceof HttpContent) { //è¯·æ±‚ä½“ } } });*/ } }); ChannelFuture channelFuture = serverBootstrap.bind(8080).sync(); channelFuture.channel().closeFuture().sync();} catch (InterruptedException e) { log.error(&quot;server error&quot;, e);} finally { boss.shutdownGracefully(); worker.shutdownGracefully();} è¿è¡Œåè®¿é—®æµè§ˆå™¨ lcoalhost:8080 æµè§ˆå™¨æ‰“å‡ºhello word è‡ªå®šä¹‰åè®®çš„ä¾‹å­è‡ªå®šä¹‰åè®®éœ€è¦æ»¡è¶³ä»¥ä¸‹è¦æ±‚ é­”æ•°ï¼Œç”¨æ¥åœ¨ç¬¬ä¸€æ—¶é—´åˆ¤å®šæ˜¯å¦æ˜¯æ— æ•ˆæ•°æ®åŒ… ç‰ˆæœ¬å·ï¼Œå¯ä»¥æ”¯æŒåè®®çš„å‡çº§ åºåˆ—åŒ–ç®—æ³•ï¼Œæ¶ˆæ¯æ­£æ–‡åˆ°åº•é‡‡ç”¨å“ªç§åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹å¼ï¼Œå¯ä»¥ç”±æ­¤æ‰©å±•ï¼Œä¾‹å¦‚ï¼šjsonã€protobufã€hessianã€jdk æŒ‡ä»¤ç±»å‹ï¼Œæ˜¯ç™»å½•ã€æ³¨å†Œã€å•èŠã€ç¾¤èŠâ€¦ è·Ÿä¸šåŠ¡ç›¸å…³ è¯·æ±‚åºå·ï¼Œä¸ºäº†åŒå·¥é€šä¿¡ï¼Œæä¾›å¼‚æ­¥èƒ½åŠ› æ­£æ–‡é•¿åº¦ æ¶ˆæ¯æ­£æ–‡ ä¸€ä¸ªğŸŒ° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138package com.hyf.demo.netty;import io.netty.buffer.ByteBuf;import io.netty.buffer.ByteBufAllocator;import io.netty.channel.ChannelHandlerContext;import io.netty.handler.codec.ByteToMessageCodec;import io.netty.handler.codec.MessageToMessageCodec;import lombok.extern.slf4j.Slf4j;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.util.List;@Slf4jpublic class MessageCodecSharable extends MessageToMessageCodec&lt;ByteBuf, Message&gt; { @Override protected void encode(ChannelHandlerContext ctx, Message msg, List&lt;Object&gt; outList) throws Exception { // å°†msgå†…å®¹ å†™å…¥nettyå¸®åŠ©æˆ‘ä»¬åˆ›å»ºçš„Bytebufä¸­// ByteBuf out = ctx.alloc().buffer(); ByteBuf out = ByteBufAllocator.DEFAULT.buffer(1024); // 1. 4 å­—èŠ‚çš„é­”æ•° out.writeBytes(new byte[]{1, 2, 3, 4}); // 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬, out.writeByte(1); // 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1 out.writeByte(0); // 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹ out.writeByte(msg.getMessageType()); // 5. 4 ä¸ªå­—èŠ‚ out.writeInt(msg.getSequenceId()); // æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å…… out.writeByte(0xff); // 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„ ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(msg); byte[] bytes = bos.toByteArray(); // 7. é•¿åº¦ out.writeInt(bytes.length); // 8. å†™å…¥å†…å®¹ out.writeBytes(bytes); outList.add(out); } @Override protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception { int magicNum = in.readInt(); byte version = in.readByte(); byte serializerType = in.readByte(); byte messageType = in.readByte(); int sequenceId = in.readInt(); in.readByte(); int length = in.readInt(); byte[] bytes = new byte[length]; in.readBytes(bytes, 0, length); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bytes)); Message message = (Message) ois.readObject(); log.debug(&quot;{}, {}, {}, {}, {}, {}&quot;, magicNum, version, serializerType, messageType, sequenceId, length); log.debug(&quot;{}&quot;, message); // ä¸ºäº†ç»™ä¸‹ä¸€ä¸ªhandlerä½¿ç”¨ out.add(message); }}// æµ‹è¯•ç±»package com.hyf.demo.netty;import com.fasterxml.jackson.databind.ObjectMapper;import io.netty.buffer.ByteBuf;import io.netty.buffer.ByteBufAllocator;import io.netty.buffer.Unpooled;import io.netty.channel.embedded.EmbeddedChannel;import io.netty.handler.logging.LoggingHandler;import java.io.ByteArrayOutputStream;import java.io.IOException;import java.util.ArrayList;import java.util.List;public class Test { public static void main(String[] args) throws Exception { EmbeddedChannel channel = new EmbeddedChannel( new LoggingHandler(),// new LengthFieldBasedFrameDecoder(// 1024, 12, 4, 0, 0), new MessageCodecSharable() );// encode// Message message = new Message(&quot;zhangsan&quot;, &quot;123&quot;); Message message = new Message(1, 2);// channel.writeOutbound(message);// decode ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(); List&lt;Object&gt; messageList = new ArrayList&lt;&gt;(); new MessageCodecSharable().encode(null, message, messageList);// System.out.println(messageList); channel.writeInbound(convertListToByteBuf(messageList));// ByteBuf s1 = buf.slice(0, 100);// ByteBuf s2 = buf.slice(100, buf.readableBytes() - 100);// s1.retain(); // å¼•ç”¨è®¡æ•° 2// channel.writeInbound(s1); // release 1// channel.writeInbound(s2); } public static ByteBuf convertListToByteBuf(List&lt;Object&gt; list) { // åˆ›å»ºä¸€ä¸ªæ–°çš„ByteBuf ByteBuf byteBuf = Unpooled.buffer(); // åˆ›å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„è¾“å‡ºæµ ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); try { // åˆ›å»ºObjectMapperå¯¹è±¡ ObjectMapper objectMapper = new ObjectMapper(); // å°†åˆ—è¡¨è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ byte[] byteArray = objectMapper.writeValueAsBytes(list); // å°†å­—èŠ‚æ•°ç»„è¾“å‡ºæµçš„å†…å®¹å†™å…¥ByteBuf byteBuf.writeBytes(byteArrayOutputStream.toByteArray()); byteBuf.writeBytes(byteArray); } catch (IOException e) { e.printStackTrace(); } return byteBuf; }}","link":"/2023/06/13/netty/"},{"title":"NIO","text":"ä¸Šä¸€ç¯‡è¯´è¿‡äº†åŸºç¡€IOæµçš„æ“ä½œï¼Œè¿™ç¯‡ç®€å•è¯´ä¸€ä¸‹ç½‘ç»œç¼–ç¨‹ï¼Œç½‘ç»œç¼–ç¨‹å°±æˆ‘è‡ªå·±ç†è§£å°±æ˜¯åœ¨ç½‘ç»œä¸–ç•Œä¸­è¿›è¡Œæ•°æ®çš„äº’ç›¸ä¼ é€’ï¼Œå®ƒåŸºäºOSIä¸ƒå±‚æ¨¡å‹ï¼Œè¿›è¡Œå±‚å±‚å°è£…ï¼Œæ¥å°†æ•°æ®æœ€ç»ˆå°è£…æˆäº†ä¸€ä¸ªä¸ªæ•°æ®åŒ…ï¼Œç„¶åå‘å¾€å¦å¤–ä¸€ç«¯ï¼Œè¿™ç¯‡æš‚æ—¶ä¸è¯´TCPã€UDPä»¥åŠsocketé€šä¿¡çš„å…¶å®ƒåè®®ï¼Œè¿™ç¯‡åªè¯´ä¸€ä¸‹è·ŸIOç›¸å…³çš„ç½‘ç»œç¼–ç¨‹ ç›´æ¥ä¸Šæ —å­æœ€ç®€å•çš„IOä¸€ä¸ªç®€å•çš„åŸºäºIOçš„ç½‘ç»œç¼–ç¨‹ğŸŒ° 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980// Serverpackage com.hyf.demo.bio;import java.io.BufferedReader;import java.io.IOException;import java.io.InputStreamReader;import java.net.InetSocketAddress;import java.net.ServerSocket;import java.net.Socket;import java.net.SocketAddress;public class Server { public static void main(String[] args) { // åˆ›å»ºè¿æ¥ try { ServerSocket serverSocket = new ServerSocket(); SocketAddress socketAddress = new InetSocketAddress(&quot;localhost&quot;, 9999); serverSocket.bind(socketAddress); System.out.println(&quot;ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥&quot;); // 1.è¿™é‡Œä¼šç­‰å¾…å®¢æˆ·ç«¯è¿æ¥é˜»å¡ Socket socket = serverSocket.accept(); System.out.println(&quot;å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ&quot;); // è¯»å–socketè¾“å…¥æµä¸­çš„æ•°æ® BufferedReader inputStream = new BufferedReader(new InputStreamReader(socket.getInputStream())); String msg; // 2. è¿™é‡Œä¼šé˜»å¡ç­‰å¾…å®¢æˆ·ç«¯æ¶ˆæ¯ while ((msg = inputStream.readLine()) != null) { System.out.println(msg); } } catch (IOException e) { e.printStackTrace(); } }}// Clientpackage com.hyf.demo.bio;import java.io.BufferedReader;import java.io.IOException;import java.io.InputStreamReader;import java.io.OutputStream;import java.net.InetSocketAddress;import java.net.Socket;import java.net.SocketAddress;public class Client { public static void main(String[] args) { // åˆ›å»ºsocket Socket socket = new Socket(); SocketAddress socketAddress = new InetSocketAddress(&quot;localhost&quot;, 9999); try { socket.connect(socketAddress); System.out.println(&quot;è¿æ¥æœåŠ¡ç«¯æˆåŠŸ&quot;); BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(System.in)); String msg; // è¿™é‡Œä¼šç­‰å¾…æ§åˆ¶å°è¾“å…¥ é˜»å¡ while ((msg = bufferedReader.readLine()) != null) { OutputStream outputStream = socket.getOutputStream(); // ä½¿ç”¨äº†readline éœ€è¦åŠ å…¥\\n \\rç­‰ ä¸ç„¶ä¸ç®—ä¸€è¡Œ outputStream.write((msg+&quot;\\n&quot;).getBytes()); outputStream.flush(); } } catch (IOException e) { e.printStackTrace(); } }} å­˜åœ¨çš„é—®é¢˜ä¸Šé¢çš„ä»£ç è¿è¡Œèµ·æ¥åï¼Œå¯ä»¥åœ¨æ§åˆ¶å°è¿›è¡ŒåŸºæœ¬çš„ç®€å•çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„é€šè®¯ï¼Œä½†æ˜¯ä¸Šé¢çš„ä»£ç æœ‰å‡ ä¸ªé—®é¢˜ åªèƒ½æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ æœåŠ¡ç«¯ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥åªèƒ½é˜»å¡ç­‰å¾… è§£å†³åªèƒ½æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ è§£å†³åªèƒ½æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ ç›´æ¥ä¸Šä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135Serverpackage com.hyf.demo.bio;import java.io.BufferedReader;import java.io.IOException;import java.io.InputStreamReader;import java.net.InetSocketAddress;import java.net.ServerSocket;import java.net.Socket;import java.net.SocketAddress;import java.util.ArrayList;import java.util.Iterator;import java.util.List;import java.util.concurrent.LinkedBlockingDeque;import java.util.concurrent.ThreadFactory;import java.util.concurrent.ThreadPoolExecutor;import java.util.concurrent.TimeUnit;public class Server { public static void main(String[] args) { // å­˜å‚¨socketçš„list è¿™é‡Œæ¶‰åŠåˆ°å¤šçº¿ç¨‹ç¼–ç¨‹ æ‰€ä»¥å¯ä»¥ä½¿ç”¨å¸¦é”çš„list ä½†æ˜¯è¿™é‡Œdemoçš„è¯ è‡ªå·±ä½¿ç”¨synchronizedä»£ç å»å†™ // è¿™é‡Œå¯ä»¥ä½¿ç”¨CopyOnWriteArrayList ä½†æ˜¯CopyOnWriteArrayList è¿­ä»£åˆ é™¤çš„æ—¶å€™ä¼šæœ‰é—®é¢˜ // æ‰€ä»¥å¯ä»¥ä½¿ç”¨Collections.synchronizedList(new ArrayList&lt;&gt;()); List&lt;Socket&gt; socketList = new ArrayList&lt;&gt;(); ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(5, 10, 60L, TimeUnit.SECONDS, new LinkedBlockingDeque&lt;&gt;(5), new ThreadFactory() { @Override public Thread newThread(Runnable r) { Thread thread = new Thread(r); return thread; } }, new ThreadPoolExecutor.DiscardOldestPolicy()); // åˆ›å»ºè¿æ¥ try { ServerSocket serverSocket = new ServerSocket(); SocketAddress socketAddress = new InetSocketAddress(&quot;localhost&quot;, 9999); serverSocket.bind(socketAddress); System.out.println(&quot;ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥&quot;); // å¼€å¯ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨å¤„ç†å®¢æˆ·ç«¯è¿æ¥ new Thread(() -&gt; { while (true) { try { Socket socket = serverSocket.accept(); socketList.add(socket); System.out.println(&quot;æ–°åŠ å…¥ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç«¯å£ &quot; + socket.getPort()); TimeUnit.MILLISECONDS.sleep(200); } catch (InterruptedException e) { e.printStackTrace(); } catch (IOException e) { e.printStackTrace(); } } }).start(); // 1.è¿™é‡Œä¼šç­‰å¾…å®¢æˆ·ç«¯è¿æ¥é˜»å¡ while (true) { synchronized (Server.class) { // éå†socketList Iterator&lt;Socket&gt; iterator = socketList.iterator(); while (iterator.hasNext()) { Socket socket = iterator.next(); iterator.remove(); // è¯»å–socketè¾“å…¥æµä¸­çš„æ•°æ® // 2. è¿™é‡Œä¼šé˜»å¡ç­‰å¾…å®¢æˆ·ç«¯æ¶ˆæ¯ threadPoolExecutor.execute(() -&gt; { try { BufferedReader inputStream = new BufferedReader(new InputStreamReader(socket.getInputStream())); String msg; while (true) { if (((msg = inputStream.readLine()) != null)) { System.out.println(Thread.currentThread().getName() + &quot; ç«¯å£ &quot; + socket.getPort() + &quot; &quot; + msg); } } } catch (IOException e) { e.printStackTrace(); } }); } } } } catch (IOException e) { e.printStackTrace(); } }}// Clientpackage com.hyf.demo.bio;import java.io.BufferedReader;import java.io.IOException;import java.io.InputStreamReader;import java.io.OutputStream;import java.net.InetSocketAddress;import java.net.Socket;import java.net.SocketAddress;public class Client { public static void main(String[] args) { // åˆ›å»ºsocket Socket socket = new Socket(); SocketAddress socketAddress = new InetSocketAddress(&quot;localhost&quot;, 9999); try { socket.connect(socketAddress); System.out.println(&quot;è¿æ¥æœåŠ¡ç«¯æˆåŠŸ&quot;); BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(System.in)); String msg; // è¿™é‡Œä¼šç­‰å¾…æ§åˆ¶å°è¾“å…¥ é˜»å¡ while ((msg = bufferedReader.readLine()) != null) { OutputStream outputStream = socket.getOutputStream(); // ä½¿ç”¨äº†readline éœ€è¦åŠ å…¥\\n \\rç­‰ ä¸ç„¶ä¸ç®—ä¸€è¡Œ outputStream.write((msg+&quot;\\n&quot;).getBytes()); outputStream.flush(); } } catch (IOException e) { e.printStackTrace(); } }} serverè¾“å‡ºå¦‚ä¸‹ 12345ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥æ–°åŠ å…¥ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç«¯å£ 54968æ–°åŠ å…¥ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç«¯å£ 54972Thread-1 ç«¯å£ 54968 æˆ‘æ˜¯å®¢æˆ·ç«¯1Thread-2 ç«¯å£ 54972 æˆ‘æ˜¯å®¢æˆ·ç«¯2 clientè¾“å‡ºå¦‚ä¸‹ 12è¿æ¥æœåŠ¡ç«¯æˆåŠŸæˆ‘æ˜¯å®¢æˆ·ç«¯1 è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ æœåŠ¡ç«¯åªèƒ½é˜»å¡ç­‰å¾… è¿™ä¸ªé—®é¢˜å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯BIOï¼Œæ‰€ä»¥åªèƒ½é˜»å¡ç­‰å¾…ï¼Œé å¼€å¤šä¸ªçº¿ç¨‹å»è¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿåªèƒ½åº”å¯¹è¿æ¥æ•°æ¯”è¾ƒå°‘çš„æƒ…æ™¯ï¼Œå¦‚æœè¿æ¥æ•°ä¸€æ—¦ä¸Šæ¥ï¼Œé‚£ä¹ˆä¸€ç›´å¼€çº¿ç¨‹ä¹Ÿæ˜¯ä¸€ç¬”å¾ˆå¤§çš„å¼€é”€ï¼Œæ‰€ä»¥æ‰æœ‰äº†NIOè¿™æ ·çš„çš„éé˜»å¡IOæ¥è§£å†³è¿™ä¸ªé—®é¢˜ NIONIOå’Œ IOçš„åŒºåˆ« é˜»å¡çš„ IO ä¼šé˜»å¡åœ¨ IO æ“ä½œä¸Š, NIO é˜»å¡åœ¨äº‹ä»¶è·å–ä¸Š NIOè§£å†³çš„é—®é¢˜ å·¥ä½œåœ¨éé˜»å¡çº¿ç¨‹ä¸Šï¼Œçº¿ç¨‹åˆ©ç”¨ç‡æé«˜ é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šçš„åœºæ™¯ï¼Œä½†æ˜¯æµé‡è¾ƒå°‘ å¸¸ç”¨ä»£ç ä»‹ç»å¸¸ç”¨çš„ä¸€ä¸ªbytebufferä»£ç ç®€å•ä»‹ç» 123456789101112131415161718192021222324252627@Slf4jpublic class ChannelDemo1 { public static void main(String[] args) { try (RandomAccessFile file = new RandomAccessFile(&quot;data.txt&quot;, &quot;rw&quot;)) { FileChannel channel = file.getChannel(); ByteBuffer buffer = ByteBuffer.allocate(10); do { // å‘ buffer å†™å…¥ int len = channel.read(buffer); log.debug(&quot;è¯»åˆ°å­—èŠ‚æ•°ï¼š{}&quot;, len); if (len == -1) { break; } // åˆ‡æ¢ buffer è¯»æ¨¡å¼ buffer.flip(); while(buffer.hasRemaining()) { log.debug(&quot;{}&quot;, (char)buffer.get()); } // åˆ‡æ¢ buffer å†™æ¨¡å¼ // è¿˜æœ‰ä¸€ç§ compactæ¨¡å¼ æ˜¯æŠŠæœªè¯»çš„éƒ¨åˆ†å‹ç¼©åˆ°å‰è¾¹ ç„¶ååˆ‡æ¢åˆ°å†™æ¨¡å¼ buffer.clear(); } while (true); } catch (IOException e) { e.printStackTrace(); } }} é˜»å¡å’Œéé˜»å¡ nioä»£ç ä¾‹å­é˜»å¡å’Œéé˜»å¡nioåŸºç¡€æœåŠ¡ç«¯ä»£ç  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253package com.hyf.demo.nio;import java.io.IOException;import java.net.InetSocketAddress;import java.nio.ByteBuffer;import java.nio.channels.ServerSocketChannel;import java.nio.channels.SocketChannel;import java.util.ArrayList;import java.util.List;import static com.hyf.demo.nio.ByteBufferUtil.debugAll;public class NioSocketChannel { public static void main(String[] args) { ByteBuffer byteBuffer = ByteBuffer.allocate(64); try { ServerSocketChannel serverSocketChannel = ServerSocketChannel.open(); // è®¾ç½®ä¸ºéé˜»å¡ serverSocketChannel.configureBlocking(false); serverSocketChannel.bind(new InetSocketAddress(9999)); List&lt;SocketChannel&gt; channelsList = new ArrayList&lt;&gt;(); while (true) { // å¦‚æœæ˜¯é˜»å¡æ¨¡å¼ è¿™é‡Œä¼šé˜»å¡ SocketChannel accept = serverSocketChannel.accept(); if (accept != null) { // è®¾ç½®ä¸ºéé˜»å¡ accept.configureBlocking(false); channelsList.add(accept); } for (SocketChannel socketChannel : channelsList) { // å¦‚æœæ˜¯é˜»å¡æ¨¡å¼ è¿™é‡Œä¹Ÿä¼šé˜»å¡ int read = socketChannel.read(byteBuffer); if (read &gt; 0) { byteBuffer.flip(); debugAll(byteBuffer); byteBuffer.clear(); } } } } catch (IOException e) { e.printStackTrace(); } }} ä¸Šé¢çš„ä»£ç çš„å¥½å¤„æ˜¯ è®¾ç½®ä¸ºéé˜»å¡åï¼Œæˆ‘ä»¬çš„å®¢æˆ·ç«¯è¿æ¥å°±ä¸ä¼šé˜»å¡ï¼Œè¯»å–ä¹Ÿä¸ä¼šé˜»å¡äº†ï¼Œä½†æ˜¯è¿™æ ·æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä¼šæ¶ˆè€—å¤§é‡cpuï¼ˆcpuç©ºè½¬ã€åˆ©ç”¨ç‡å¤ªé«˜ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨selectoræ¨¡å¼ï¼Œä½¿ç”¨selectoræ¥ç®¡ç†channelï¼Œä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†selector selecor çš„å››ç§äº‹ä»¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175/** * Operation-set bit for read operations. * * &lt;p&gt; Suppose that a selection key's interest set contains * &lt;tt&gt;OP_READ&lt;/tt&gt; at the start of a &lt;a * href=&quot;Selector.html#selop&quot;&gt;selection operation&lt;/a&gt;. If the selector * detects that the corresponding channel is ready for reading, has reached * end-of-stream, has been remotely shut down for further reading, or has * an error pending, then it will add &lt;tt&gt;OP_READ&lt;/tt&gt; to the key's * ready-operation set and add the key to its selected-key&amp;nbsp;set. &lt;/p&gt; */ public static final int OP_READ = 1 &lt;&lt; 0; /** * Operation-set bit for write operations. * * &lt;p&gt; Suppose that a selection key's interest set contains * &lt;tt&gt;OP_WRITE&lt;/tt&gt; at the start of a &lt;a * href=&quot;Selector.html#selop&quot;&gt;selection operation&lt;/a&gt;. If the selector * detects that the corresponding channel is ready for writing, has been * remotely shut down for further writing, or has an error pending, then it * will add &lt;tt&gt;OP_WRITE&lt;/tt&gt; to the key's ready set and add the key to its * selected-key&amp;nbsp;set. &lt;/p&gt; */ public static final int OP_WRITE = 1 &lt;&lt; 2; /** * Operation-set bit for socket-connect operations. * * &lt;p&gt; Suppose that a selection key's interest set contains * &lt;tt&gt;OP_CONNECT&lt;/tt&gt; at the start of a &lt;a * href=&quot;Selector.html#selop&quot;&gt;selection operation&lt;/a&gt;. If the selector * detects that the corresponding socket channel is ready to complete its * connection sequence, or has an error pending, then it will add * &lt;tt&gt;OP_CONNECT&lt;/tt&gt; to the key's ready set and add the key to its * selected-key&amp;nbsp;set. &lt;/p&gt; */ public static final int OP_CONNECT = 1 &lt;&lt; 3; /** * Operation-set bit for socket-accept operations. * * &lt;p&gt; Suppose that a selection key's interest set contains * &lt;tt&gt;OP_ACCEPT&lt;/tt&gt; at the start of a &lt;a * href=&quot;Selector.html#selop&quot;&gt;selection operation&lt;/a&gt;. If the selector * detects that the corresponding server-socket channel is ready to accept * another connection, or has an error pending, then it will add * &lt;tt&gt;OP_ACCEPT&lt;/tt&gt; to the key's ready set and add the key to its * selected-key&amp;nbsp;set. &lt;/p&gt; */ public static final int OP_ACCEPT = 1 &lt;&lt; 4;``` ### ä½¿ç”¨selector å¤„ç†nioæ¶ˆæ¯ä¸‹é¢çš„è¿™ä¸ªä¾‹å­æ˜¯ä½¿ç”¨selectorå¤„ç† nioæ¶ˆæ¯çš„```javapackage com.hyf.demo.nio;import java.io.IOException;import java.net.InetSocketAddress;import java.nio.ByteBuffer;import java.nio.CharBuffer;import java.nio.channels.SelectionKey;import java.nio.channels.Selector;import java.nio.channels.ServerSocketChannel;import java.nio.channels.SocketChannel;import java.nio.charset.CharacterCodingException;import java.nio.charset.Charset;import java.nio.charset.CharsetDecoder;import java.util.Iterator;import java.util.Set;import static com.hyf.demo.nio.ByteBufferUtil.debugAll;public class NioSelectorSocketChannel { public static void main(String[] args) { try { // å»ºç«‹selector Selector selector = Selector.open(); ServerSocketChannel serverSocketChannel = ServerSocketChannel.open(); serverSocketChannel.configureBlocking(false); // ç»‘å®šserverSocketChannel SelectionKey selectionKey = serverSocketChannel.register(selector, 0, null); // è®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶ selectionKey.interestOps(SelectionKey.OP_ACCEPT); // è®¾ç½®ä¸ºéé˜»å¡ serverSocketChannel.bind(new InetSocketAddress(9999)); while (true) { // é˜»å¡ ç›‘å¬äº‹ä»¶çš„å‘ç”Ÿ å¦‚æœäº‹ä»¶å¤„ç†äº† selectä¼šé˜»å¡ å¦‚æœæ²¡å¤„ç† åˆ™ä¸é˜»å¡ å¦‚æœä¸æƒ³å¤„ç†ï¼Œé‚£å°±å–æ¶ˆäº‹ä»¶cancel() selector.select(); Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys(); Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator(); while (iterator.hasNext()) { SelectionKey key = iterator.next(); if (key.isAcceptable()) { ServerSocketChannel channel = (ServerSocketChannel) key.channel(); SocketChannel socketChannel = channel.accept(); // selectoréƒ½æ˜¯å¿…é¡»å·¥ä½œåœ¨ éé˜»å¡æ¨¡å¼ socketChannel.configureBlocking(false); // æ³¨å†Œ åˆ°selectorä¸Š å› ä¸ºä¸€ä¸ªselectorå¯ä»¥ç®¡ç†å¤šä¸ªchanel SelectionKey scKey = socketChannel.register(selector, 0, ByteBuffer.allocate(16)); scKey.interestOps(SelectionKey.OP_READ); } else if (key.isReadable()) { SocketChannel channel = (SocketChannel) key.channel(); ByteBuffer byteBuffer = (ByteBuffer) key.attachment(); int read = channel.read(byteBuffer); // å®¢æˆ·ç«¯æ­£å¸¸æ–­å¼€ è¿”å›-1 if (read == -1) { key.cancel(); channel.close(); } else { // å¤„ç†ç²˜åŒ… split(byteBuffer); // å¤„ç†æ‰©å®¹ if (byteBuffer.position() == byteBuffer.limit()) { ByteBuffer newBytebuffer = ByteBuffer.allocate(2 * byteBuffer.capacity()); byteBuffer.flip(); newBytebuffer.put(byteBuffer); key.attach(newBytebuffer); }// byteBuffer.flip();// debugRead(byteBuffer); } } // éœ€è¦æ‰‹åŠ¨åˆ é™¤ ä¸ç„¶äº‹ä»¶è™½ç„¶å¤„ç†äº† ç»‘å®šäº‹ä»¶çš„keyè¿˜å­˜åœ¨ iterator.remove(); } } } catch (IOException e) { e.printStackTrace(); } } private static void split(ByteBuffer byteBuffer) { byteBuffer.flip(); for (int i = 0; i &lt; byteBuffer.limit(); i++) { if (byteBuffer.get(i) == '\\n') { int length = i + 1 - byteBuffer.position(); ByteBuffer target = ByteBuffer.allocate(length); for (int j = 0; j &lt; length; j++) { target.put(byteBuffer.get()); } // å°† position è®¾ç½®ä¸º 0ï¼Œå‡†å¤‡å¼€å§‹è¯»å– target.flip(); // æˆ–è€…å°†å­—èŠ‚è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶ä¸€æ¬¡æ€§è¾“å‡º String output = new String(target.array(), target.position(), target.remaining()); System.out.println(output); } } byteBuffer.compact(); }} ä¸Šé¢æ˜¯æœåŠ¡æ®µä»£ç  å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ 1234567891011121314151617181920212223package com.hyf.demo.nio;import java.io.IOException;import java.net.InetSocketAddress;import java.nio.channels.SocketChannel;import java.nio.charset.Charset;public class NioSelectorClient { public static void main(String[] args) { SocketChannel socketChannel = null; try { socketChannel = SocketChannel.open(); socketChannel.connect(new InetSocketAddress(9999)); socketChannel.write(Charset.defaultCharset().encode(&quot;huyunfeinihaocongjianihaok\\noolopwew\\n&quot;)); System.in.read(); } catch (IOException e) { e.printStackTrace(); } }} nioç¼–ç¨‹è§£å†³çš„é—®é¢˜ ä¸Šé¢çš„ä¾‹å­ç®€å•è§£å†³çš„ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ ç²˜åŒ…é»åŒ…é—®é¢˜ï¼ˆTCPç¼–ç¨‹å¿…é¡»è€ƒè™‘çš„é—®é¢˜ï¼‰ å®¢æˆ·ç«¯å¼‚å¸¸ä¸­æ–­æˆ–è€…æ­£å¸¸é€€å‡ºå¤„ç† bytebuffer æ‰©å®¹ ï¼ˆä¸Šé¢åªæ˜¯ç®€å•çš„æ‰©å®¹ï¼Œä½†æ˜¯å¾—è€ƒè™‘bytebufferçš„æ‰©å®¹å’Œç¼©å®¹ï¼ŒåšæˆåŠ¨æ€çš„æ›´å¥½ï¼Œnettyå°±åšçš„æ¯”è¾ƒå¥½ï¼‰ ä½†æ˜¯å¦‚æœæˆ‘ä»¬å¾€å®¢æˆ·ç«¯å‘é€å†…å®¹ï¼Œéœ€è¦æ³¨æ„å“ªäº›é—®é¢˜å‘¢ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182package com.hyf.demo.nio;import lombok.extern.slf4j.Slf4j;import java.io.IOException;import java.net.InetSocketAddress;import java.net.SocketAddress;import java.nio.ByteBuffer;import java.nio.channels.*;import java.nio.charset.Charset;import java.util.Iterator;@Slf4jpublic class NioWrite { public static void main(String[] args) { try { ServerSocketChannel serverSocketChannel = ServerSocketChannel.open(); SocketAddress socketAddress = new InetSocketAddress(9000); serverSocketChannel.bind(socketAddress); serverSocketChannel.configureBlocking(false); Selector selector = Selector.open(); SelectionKey selectionKey = serverSocketChannel.register(selector, 0, null); selectionKey.interestOps(SelectionKey.OP_ACCEPT); while (true) { selector.select(); Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator(); while (iterator.hasNext()) { SelectionKey key = iterator.next(); iterator.remove();; if (key.isAcceptable()) { ServerSocketChannel ssc = (ServerSocketChannel) key.channel(); SocketChannel socketChannel = ssc.accept(); socketChannel.configureBlocking(false); SelectionKey sckey = socketChannel.register(selector, 0, SelectionKey.OP_READ); StringBuffer stringBuffer = new StringBuffer(); for (int i = 0; i &lt; 3000000; i++) { stringBuffer.append(&quot;a&quot;); } ByteBuffer byteBuffer = Charset.defaultCharset().encode(stringBuffer.toString()); int write = socketChannel.write(byteBuffer); log.info(&quot;å®é™…å†™å…¥äº† {}&quot;, write); if (byteBuffer.hasRemaining()) { sckey.interestOps(SelectionKey.OP_WRITE + sckey.interestOps()); sckey.attach(byteBuffer); } } else if (key.isWritable()) { log.info(&quot;write able...&quot;); ByteBuffer byteBuffer = (ByteBuffer) key.attachment(); SocketChannel channel = (SocketChannel)key.channel(); int write = channel.write(byteBuffer); if(!byteBuffer.hasRemaining()){ log.info(&quot;cancel wrible&quot;); key.interestOps(key.interestOps()-SelectionKey.OP_WRITE); key.attach(null); } log.info(&quot;å®é™…å†™å…¥äº† {}&quot;, write); } } } } catch (IOException e) { e.printStackTrace(); } }} å¯¹åº”çš„å®¢æˆ·ç«¯ä¾‹å­å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263package com.hyf.demo.nio;import java.io.IOException;import java.net.InetSocketAddress;import java.net.SocketAddress;import java.nio.ByteBuffer;import java.nio.channels.SelectionKey;import java.nio.channels.Selector;import java.nio.channels.SocketChannel;import java.util.Iterator;public class NioReadClient { public static void main(String[] args) throws IOException { SocketChannel socketChannel = SocketChannel.open(); SocketAddress socketAddress = new InetSocketAddress(9000); socketChannel.connect(socketAddress); int count = 0; while (true){ ByteBuffer byteBuffer = ByteBuffer.allocate(1024); int read = socketChannel.read(byteBuffer); count += read; System.out.println(count); byteBuffer.clear(); }// Selector selector = Selector.open();// socketChannel.configureBlocking(false);// socketChannel.register(selector, SelectionKey.OP_CONNECT + SelectionKey.OP_READ);// int count = 0;// while (true) {// selector.select();//// Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();//// while (iterator.hasNext()){// SelectionKey sk = iterator.next();// iterator.remove();//// if(sk.isConnectable()){// System.out.println(&quot;connect...&quot;);// }// else if(sk.isReadable()){// ByteBuffer byteBuffer = ByteBuffer.allocate(1024);//// int read = socketChannel.read(byteBuffer);// count += read;// System.out.println(count);// byteBuffer.clear();// }// }//// } }} å¤šçº¿ç¨‹ä¼˜åŒ–nioä»£ç ä»¥ä¸Šæˆ‘ä»¬å±•ç¤ºäº†nioçš„è¯»å–ã€å†™å…¥ ä»¥åŠé‡åˆ°çš„é—®é¢˜ï¼Œä½†æ˜¯æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦å®ç°çš„æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå¦‚æœæœ‰å¤§é‡è¿æ¥è¯·æ±‚è¿›æ¥ï¼Œåœ¨å¤„ç†readäº‹ä»¶çš„æ—¶å€™è¦å¾ˆä¹…ï¼Œé‚£å•çº¿ç¨‹æ˜¯ä¸æ˜¯å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†ä¸Šé¢çš„ä»£ç ä¼˜åŒ–æˆå¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£å»ºç«‹è¿æ¥ã€å¦å¤–ä¸€äº›çº¿ç¨‹ä¸“é—¨è´Ÿè´£è¯»å†™ï¼Œä»£ç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143package com.hyf.demo.nio;import lombok.SneakyThrows;import lombok.extern.slf4j.Slf4j;import java.io.IOException;import java.net.InetSocketAddress;import java.net.SocketAddress;import java.nio.ByteBuffer;import java.nio.CharBuffer;import java.nio.channels.*;import java.nio.charset.Charset;import java.util.Iterator;import java.util.concurrent.ConcurrentLinkedDeque;import java.util.concurrent.TimeUnit;@Slf4jpublic class NioThreadWork { public static void main(String[] args) { Thread.currentThread().setName(&quot;boss&quot;); try { // åˆ›å»ºä¸€ä¸ªserverSocketChannel ServerSocketChannel serverSocketChannel = ServerSocketChannel.open(); // ç»‘å®šä¸€ä¸ªç«¯å£ SocketAddress socketAddress = new InetSocketAddress(9999); serverSocketChannel.bind(socketAddress); // è®¾ç½®ä¸ºfalse serverSocketChannel.configureBlocking(false); // æ‰“å¼€ä¸€ä¸ªselector Selector selector = Selector.open(); // æ³¨å†Œchanel åˆ° selectorä¸Š SelectionKey boosKey = serverSocketChannel.register(selector, 0, null); // æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶ boosKey.interestOps(SelectionKey.OP_ACCEPT); Worker worker = new Worker(&quot;work&quot;); while (true) { log.info(&quot;ç­‰å¾…è¿æ¥ä¸­&quot;); selector.select(); Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator(); while (iterator.hasNext()) { SelectionKey key = iterator.next(); iterator.remove(); if (key.isAcceptable()) { log.info(&quot;è¿æ¥äº‹ä»¶å»ºç«‹&quot;); ServerSocketChannel ssc = (ServerSocketChannel) key.channel(); SocketChannel socketChannel = ssc.accept(); socketChannel.configureBlocking(false); log.info(&quot;æ³¨å†Œè¯»å–äº‹ä»¶ before&quot;); worker.register(socketChannel); log.info(&quot;æ³¨å†Œè¯»å–äº‹ä»¶ after&quot;); } } } } catch (IOException e) { e.printStackTrace(); } } public static class Worker implements Runnable { private String name; private Thread thread; private volatile Selector selector; private volatile boolean start = false; private ConcurrentLinkedDeque&lt;Runnable&gt; linkedDeque = new ConcurrentLinkedDeque&lt;&gt;(); public Worker(String name) { this.name = name; } public void register(SocketChannel socketChannel) throws IOException { if (!start) { thread = new Thread(this, name); thread.start(); selector = Selector.open(); start = true; } linkedDeque.offer(() -&gt; { try { socketChannel.register(selector, SelectionKey.OP_READ); } catch (ClosedChannelException e) { e.printStackTrace(); } }); selector.wakeup(); } @SneakyThrows @Override public void run() { while (true) { Runnable poll = linkedDeque.poll(); if (poll != null) { poll.run(); } log.info(&quot;è¯»å–äº‹ä»¶é˜»å¡&quot;); selector.select(); Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator(); while (iterator.hasNext()) { SelectionKey key = iterator.next(); iterator.remove(); if (key.isReadable()) { log.info(&quot;è¯»æ•°æ®å¼€å§‹&quot;); SocketChannel channel = (SocketChannel) key.channel(); ByteBuffer byteBuffer = ByteBuffer.allocate(1024); channel.read(byteBuffer); byteBuffer.flip(); CharBuffer decode = Charset.defaultCharset().decode(byteBuffer); while (decode.hasRemaining()) { log.info(&quot;content {}&quot;, decode.get()); } } } } } }} å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ 12345678910111213141516171819202122232425262728package com.hyf.demo.nio;import java.io.IOException;import java.net.InetSocketAddress;import java.net.SocketAddress;import java.nio.channels.SocketChannel;import java.nio.charset.Charset;public class NioThreadClient { public static void main(String[] args) { try { SocketChannel socketChannel =SocketChannel.open(); SocketAddress socketAddress = new InetSocketAddress(9999); socketChannel.connect(socketAddress); socketChannel.write(Charset.defaultCharset().encode(&quot;ä½ å¥½&quot;)); System.in.read(); } catch (IOException e) { e.printStackTrace(); } }} ä»¥ä¸Šä»£ç ä¾¿å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„å¤šçº¿ç¨‹ç‰ˆæœ¬çš„è¯»å†™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œå¦‚æœå†å®Œå–„çš„è¯ï¼Œå¯ä»¥åŠ ä¸Šæˆ‘ä»¬ä¹‹å‰çš„å„ç§ä¼˜åŒ–ç‚¹ï¼Œå¯¹bytebufferçš„æ‰©å®¹ã€å¯¹ç²˜åŒ…çš„å¤„ç†ï¼Œå¯¹å®¢æˆ·ç«¯å¼‚å¸¸å…³é—­æ­£å¸¸å…³é—­çš„å¤„ç†ç­‰ ä¼šè®©ä»£ç æ›´åŠ å®Œå–„ï¼Œä½†æ˜¯æˆ‘ä»¬è‡ªå·±å¤„ç†è¿˜æ˜¯ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚nioæœ‰å¾ˆå¤šä»£ç å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”è¿˜æœ‰ä¸€ä¸ªè‡­åæ˜­è‘—çš„ç©ºè½®è®­å¯¼è‡´cpuæ‰“æ»¡çš„é—®é¢˜ï¼Œæ‰€ä»¥æœ‰å¿…è¦å°è£…ä¸€å¥—é«˜æ€§èƒ½çš„ç½‘ç»œæ¡†æ¶æ¥å¤„ç†è¿™äº›é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¤§åé¼é¼çš„netty æ‰€ä»¥ä¸‹ä¸€ç¯‡,æˆ‘å°±æ¥ç®€å•ä»‹ç»ä¸‹nettyçš„ä½¿ç”¨ä»¥åŠåŸç†","link":"/2023/05/08/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"},{"title":"IO æµ","text":"IOæ˜¯ç½‘ç»œä¸–ç•Œä¸­ä¸å¯è·ç¼ºçš„å¹¶ä¸”å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯input|outputçš„ç¼©å†™ï¼Œæœ‰äº†å®ƒï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨ç½‘ç»œä¸­ä¼ è¾“æ•°æ®ï¼ŒåŒ…æ‹¬è¾“å…¥å’Œè¾“å‡º åˆ†ç±» è¾“å…¥æµï¼šä¸»è¦æœ‰InputStream å’Œ Readerè¿™ä¸¤ä¸ªå­—èŠ‚å’Œå­—ç¬¦æµ è¾“å‡ºæµï¼šä¸»è¦æœ‰OutputStream å’Œ Writerè¿™ä¸¤ä¸ªå­—èŠ‚å’Œå­—ç¬¦æµ å­—èŠ‚æµï¼šå¯ä»¥æ“ä½œä»»ä½•æ•°æ® å­—ç¬¦æµï¼šè½¬ä¹ˆç”¨æ¥æ“ä½œå­—ç¬¦çš„ï¼Œæ¯”è¾ƒæ–¹ä¾¿ å¸¸ç”¨çš„æµæµçš„ç§ç±»å¾ˆå¤šï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¸¸ç”¨çš„æµï¼ŒçŸ¥é“ä»–ä»¬çš„åŸç†å°±å¥½ï¼Œä»¥åç”¨åˆ°å…¶ä»–çš„å†å»æŸ¥é˜…å³å¯ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950// FileInputStream/FileReader // FileOutputStream/FileWriterpackage com.hyf.demo.io;import java.io.File;import java.io.FileInputStream;import java.io.FileOutputStream;import java.io.IOException;public class FileInputStreamTest { public static void main(String[] args) { // å°†ä¸€ä¸ªæ–‡æœ¬å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ String txt = &quot;hello java&quot;; File file = new File(&quot;/Users/huyunfei/Downloads/java.txt&quot;); try { FileOutputStream fileInputStream = new FileOutputStream(file, true); fileInputStream.write(txt.getBytes()); } catch (IOException e) { e.printStackTrace(); } // è¯»å–è·¯å¾„ä¸­çš„æ•°æ® è¾“å‡ºåˆ°æ§åˆ¶å° FileInputStream fileInputStream = null; try { fileInputStream = new FileInputStream(file); // 1. è¿™ç§æ–¹å¼æ˜¯ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚è¯»å– int msg; while ((msg = fileInputStream.read()) != -1) { System.out.println((char) msg); } // 2. è¿™ç§æ–¹å¼æ˜¯1024ä¸ªå­—èŠ‚è¯»å– byte[] bytes = new byte[1024]; while (fileInputStream.read(bytes) != -1) { System.out.println(new String(bytes)); } } catch (IOException e) { e.printStackTrace(); } finally { try { fileInputStream.close(); } catch (IOException e) { e.printStackTrace(); } } }} è¿™ä¸ªæ˜¯æœ€åŸºç¡€çš„è¾“å…¥è¾“å‡º,è¿˜æœ‰ä¸“é—¨ç”¨äºè¯»å–å­—ç¬¦çš„æµ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253package com.hyf.demo.io;import java.io.*;public class BufferReaderTest { public static void main(String[] args) { // å°†ä¸€ä¸ªæ–‡æœ¬å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ String txt = &quot;hello buffer\\n&quot;; File file = new File(&quot;/Users/huyunfei/Downloads/java.txt&quot;); try { BufferedOutputStream bufferedOutputStream = new BufferedOutputStream(new FileOutputStream(file)); bufferedOutputStream.write(txt.getBytes()); bufferedOutputStream.flush(); // å­—ç¬¦bufferå†™å…¥åŸºç¡€ä»£ç // BufferedWriter bufferedWriter = new BufferedWriter(new FileWriter(file));// bufferedWriter.write(txt);// bufferedWriter.newLine();// bufferedWriter.flush(); } catch (IOException e) { e.printStackTrace(); } // è¯»å–è·¯å¾„ä¸­çš„æ•°æ® è¾“å‡ºåˆ°æ§åˆ¶å° BufferedReader bufferedReader = null; try { bufferedReader = new BufferedReader(new FileReader(file)); // 1. è¿™ç§æ–¹å¼æ˜¯ä¸€è¡Œä¸€è¡Œè¯»å– String msg; while ((msg = bufferedReader.readLine()) != null) { System.out.println(msg); } // 2. è¿™ç§æ–¹å¼æ˜¯1024ä¸ªå­—èŠ‚è¯»å– ä¸Šé¢è¯»å–å®Œæ¯•å æµé‡Œé¢çš„æ•°æ®ä¼šæ¸…ç©º// char[] bytes = new char[1024];// while (bufferedReader.read(bytes) != -1) {// System.out.println(new String(bytes));// } } catch (IOException e) { e.printStackTrace(); } finally { try { bufferedReader.close(); } catch (IOException e) { e.printStackTrace(); } } }} ä¸Šé¢æ˜¯æŒ‰ç…§å¸¦bufferçš„æµè¯»å–çš„åŸºç¡€ä»£ç  ç‰µæ‰¯åˆ°çš„ä¸¤ä¸ªé—®é¢˜ä¸ºä»€ä¹ˆè¦å‡ºç°å¸¦ç¼“å†²åŒºçš„æµä½¿ç”¨å¸¦ç¼“å†²çš„æµåŒ…è£…åŸºç¡€æµæ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼ æ¥ç€æˆ‘ä»¬æ¥è§£é‡Šç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¸¦ç¼“å†²åŒºçš„æµ? ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬è¿›è¡Œé¢‘ç¹æ•°æ®è¯»å†™çš„æ—¶å€™ï¼Œå¾ˆè€—è´¹æ€§èƒ½ï¼Œäºæ˜¯æˆ‘ä»¬éœ€è¦å°†éœ€è¦è¯»å†™çš„æ•°æ®æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹æš‚å­˜èµ·æ¥ï¼Œç„¶åè¿›è¡Œä¸€ä¸ªæ‰¹é‡çš„è¯»å†™ï¼Œç”¨çš„ä¹Ÿæ˜¯é¡ºåºå†™ï¼Œç”¨æ¥ç¼“è§£ä¸åŒè®¾å¤‡ä¹‹é—´é¢‘ç¹çš„æ•°æ®è¯»å†™ï¼Œäºæ˜¯æœ‰äº†ç¼“å†²åŒºçš„å‡ºç° æ€ä¹ˆè¯æ˜ä½¿ç”¨äº†buffer æ¯”ä¸ä½¿ç”¨buffer é€Ÿåº¦å¿«å‘¢ï¼Ÿ æºç å¦‚ä¸‹ 12345678910111213141516171819 public synchronized void write(byte b[], int off, int len) throws IOException { //åœ¨è¿™åˆ¤æ–­éœ€è¦å†™çš„æ•°æ®é•¿åº¦æ˜¯å¦å·²ç»è¶…å‡ºå®¹å™¨çš„é•¿åº¦ï¼ˆ8192byteï¼‰äº†,å¦‚æœè¶…å‡ºåˆ™ç›´æ¥å†™åˆ°ç›¸åº”çš„outputStreamä¸­,å¹¶æ¸…ç©ºç¼“å†²åŒº if (len &gt;= buf.length) { /* If the request length exceeds the size of the output buffer, flush the output buffer and then write the data directly. In this way buffered streams will cascade harmlessly. */ flushBuffer(); out.write(b, off, len); return; } // åˆ¤æ–­ç¼“å†²åŒºå‰©ä½™çš„å®¹é‡æ˜¯å¦è¿˜å¤Ÿå†™å…¥å½“å‰lençš„å†…å®¹,å¦‚æœä¸å¤Ÿåˆ™æ¸…ç©ºç¼“å†²åŒº if (len &gt; buf.length - count) { flushBuffer(); } // å°†è¦å†™çš„æ•°æ®å…ˆæ”¾å…¥å†…å­˜ä¸­,ç­‰å¾…æ•°æ®è¾¾åˆ°äº†ç¼“å†²åŒºçš„é•¿åº¦å,å†å†™åˆ°ç›¸åº”çš„outputStreamä¸­ System.arraycopy(b, off, buf, count, len); count += len;}// ä»–ä¸æ˜¯æ¯æ¬¡éƒ½è°ƒç”¨ç³»ç»Ÿçš„write è€Œæ˜¯ç§¯æ”’åˆ°8192byteåæ‰è°ƒç”¨ä¸€æ¬¡write å¤§å¤§å‡å°‘äº†ç³»ç»Ÿè°ƒç”¨ å®éªŒå¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839import java.io.BufferedOutputStream;import java.io.File;import java.io.FileOutputStream;public class OSFileIO { static byte[] data = &quot;123456789\\n&quot;.getBytes(); static String path = &quot;/data/io/out.txt&quot;; public static void main(String[] args) throws Exception { switch (args[0]) { case &quot;0&quot;: testBasicFileIO(); break; case &quot;1&quot;: testBufferedFileIO(); break; default: break; } } public static void testBasicFileIO() throws Exception { File file = new File(path); FileOutputStream out = new FileOutputStream(file); while (true) { out.write(data); } } public static void testBufferedFileIO() throws Exception { File file = new File(path); BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream(file)); while (true) { out.write(data); } }}// è¿™æ®µä»£ç æ¥æºäºç½‘ç»œ å°†è¿™æ®µä»£ç ä¸Šä¼ åˆ°linuxç›®å½• 1/Users/huyunfei/Documents/study/testCase/io ç„¶åæ‰§è¡Œ 1234# ç¼–è¯‘javaæ–‡ä»¶javac OSFileIO.java# ä½¿ç”¨strace åˆ†æè¿™ä¸ªç¨‹åºæ¶‰åŠåˆ°çš„ç³»ç»Ÿè°ƒç”¨strace -ff -o out java OSFileIO $1 å¯ä»¥å‘ç°æœ€ç»ˆçš„ç»“æœæ˜¯ï¼Œä¸ä½¿ç”¨bufferçš„æµï¼Œç³»ç»Ÿè°ƒç”¨çš„writeå¾ˆå¤šï¼Œè€Œä½¿ç”¨äº†bufferçš„è¾¾åˆ°äº†8192 byteæ‰ä¼šè¿›è¡Œä¸€ä¸ªç³»ç»Ÿwriteè°ƒç”¨ï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾ä½¿ç”¨bufferåé€Ÿåº¦æ›´å¿« ç¬¬äºŒä¸ªé—®é¢˜ è¿™é‡Œæ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆ æµä¸­æ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼æœ€ç»å…¸çš„å°±æ˜¯è£…é¥°è€…æ¨¡å¼ï¼Œå°±æ˜¯åœ¨å·²æœ‰ç±»ä¸Šè¿›è¡Œè£…é¥°å¢å¼ºã€‚è¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯å¯ä»¥ä¸æ”¹å˜å·²æœ‰çš„ç±»ï¼Œæ¯”ç»§æ‰¿çµæ´»ï¼Œå®Œå…¨éµå¾ªå¼€é—­åŸåˆ™ï¼›ç¼ºç‚¹æ˜¯å¢åŠ äº†æ›´å¤šçš„ç±»ï¼Œå¤šå±‚è£…é¥°å¢åŠ äº†ä»£ç å¤æ‚æ€§ å…¶å®è¿˜æœ‰ä¸€äº›å¸¸ç”¨çš„æµï¼Œæ¯”å¦‚å¯¹è±¡æµï¼ˆå¯ä»¥ç›´æ¥ä¼ è¾“å¯¹è±¡ï¼‰ã€è¿˜æœ‰æˆ‘ä»¬ä¸€èˆ¬å¯¹äºæ–‡ä»¶çš„è¯»å†™æ¯”è¾ƒå¤šï¼Œä½†æ˜¯é¢‘ç¹çš„æ–‡ä»¶è¯»å†™å¹¶ä¸å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å­—èŠ‚æ•°ç»„æµï¼Œä¹Ÿç§°ä¸ºå†…å­˜æµï¼Œ å¯¹è±¡æµ1234567891011121314151617181920212223242526272829303132333435363738package com.hyf.demo.io;import java.io.*;public class ObjectIOTest { public static void main(String[] args) { try { // å°†ä¸€ä¸ªå¯¹è±¡åºåˆ—åŒ–åˆ°æ–‡ä»¶ä¸­ Student student = new Student(&quot;libei&quot;, 18); FileOutputStream fileOutputStream = new FileOutputStream(&quot;/Users/huyunfei/Downloads/java.txt&quot;); ObjectOutputStream writeObjectStream = new ObjectOutputStream(fileOutputStream); writeObjectStream.writeObject(student); // å°†æ–‡ä»¶ä¸­å¯¹è±¡ååºåˆ—åŒ–å‡ºæ¥ FileInputStream fileInputStream = new FileInputStream(&quot;/Users/huyunfei/Downloads/java.txt&quot;); ObjectInputStream readObjectStream = new ObjectInputStream(fileInputStream); Student student1 = (Student) readObjectStream.readObject(); System.out.println(student1); } catch (IOException | ClassNotFoundException e) { e.printStackTrace(); } }}// è¿™é‡Œä¸€å®šè¦å®ç°åºåˆ—åŒ–æ¥å£class Student implements Serializable { private String name; private Integer age; public Student(String name, Integer age) { this.name = name; this.age = age; }} å­—èŠ‚æ•°ç»„æµ1234567891011121314151617181920212223242526package com.hyf.demo.io;import java.io.*;public class ByteArrayInputStreamTest { public static void main(String[] args) { ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); DataOutputStream dataOutputStream = new DataOutputStream(byteArrayOutputStream); try { dataOutputStream.writeDouble(Math.random()); dataOutputStream.writeBoolean(true); ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(byteArrayOutputStream.toByteArray()); DataInputStream dataInputStream = new DataInputStream(byteArrayInputStream); System.out.println(dataInputStream.available()); System.out.println(dataInputStream.readBoolean()); System.out.println(dataInputStream.readDouble()); System.out.println(dataInputStream.available()); } catch (IOException e) { e.printStackTrace(); } }} å¸¸ç”¨çš„æµå°±è¿™äº›ï¼Œæˆ‘ä»¬åœ¨æ—¥å¸¸å·¥ä½œç”¨åˆ°äº†æŸ¥æ‰‹å†Œå°±å¥½ã€‚ é€‰ç”¨å“ªç§æµ è®°å¾—åˆšæ‰æˆ‘ä»¬åˆ†æè¿‡äº†æœ‰ä¸€ä¸ªBufferOutoutStreamä¸ºä»€ä¹ˆå¿«ï¼Œé‚£å®ƒå’Œè¿™ä¸ªå†…å­˜æµByteOutputStreamæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ ByteOutputStream ä¼šæ¯æ¬¡åˆ›å»ºä¸€ä¸ª32ä¸ªbyteçš„bufferï¼Œæ¯æ¬¡å†™å…¥çš„æ—¶å€™ä¼šå¯¹æ¯”å‰©ä½™å®¹é‡æ˜¯å¦å¤Ÿç”¨ï¼Œå¦‚æœä¸å¤Ÿç”¨å°±growè¿™ä¸ªbuffer ç»§ç»­å†™å…¥ï¼Œä¸€ç›´ç­‰æ•°æ®å†™å®Œï¼Œè¿™äº›æ•°æ®éƒ½æ˜¯åœ¨å†…å­˜çš„ 12345678910public synchronized void write(byte b[], int off, int len) { if ((off &lt; 0) || (off &gt; b.length) || (len &lt; 0) || ((off + len) - b.length &gt; 0)) { throw new IndexOutOfBoundsException(); } // ç¡®ä¿buffer è¶³å¤Ÿ ensureCapacity(count + len); System.arraycopy(b, off, buf, count, len); count += len; } æ‰€ä»¥å¦‚æœæƒ³è¦å¿«é€Ÿå†™å…¥çš„è¯ï¼Œä½¿ç”¨ByteArrayOutputStream,å¦‚æœèµ„æºä¸å¤ªå¤Ÿç”¨çš„æ—¶å€™ï¼Œåº”è¯¥é€‰æ‹©BufferOutputStream ä¸‹ä¸€ç¯‡è¯´ä¸€ä¸‹å„ç§IOçš„åŒºåˆ«å’ŒèƒŒæ™¯ï¼Œä»¥åŠç½‘ç»œIOçš„æ¼”è¿›","link":"/2023/05/05/IO/"},{"title":"Hello World","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot; More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","link":"/2022/03/27/hello-world/"}],"tags":[{"name":"IO","slug":"IO","link":"/tags/IO/"},{"name":"java","slug":"java","link":"/tags/java/"},{"name":"ç½‘ç»œç¼–ç¨‹","slug":"ç½‘ç»œç¼–ç¨‹","link":"/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"},{"name":"å¸¸ç”¨","slug":"å¸¸ç”¨","link":"/tags/%E5%B8%B8%E7%94%A8/"}],"categories":[{"name":"java","slug":"java","link":"/categories/java/"},{"name":"é”åˆ†æ","slug":"java/é”åˆ†æ","link":"/categories/java/%E9%94%81%E5%88%86%E6%9E%90/"},{"name":"IO","slug":"java/IO","link":"/categories/java/IO/"},{"name":"ç½‘ç»œç¼–ç¨‹","slug":"java/ç½‘ç»œç¼–ç¨‹","link":"/categories/java/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"},{"name":"å¸¸ç”¨å‘½ä»¤","slug":"å¸¸ç”¨å‘½ä»¤","link":"/categories/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"},{"name":"hello word","slug":"java/hello-word","link":"/categories/java/hello-word/"},{"name":"å¸¸ç”¨","slug":"å¸¸ç”¨å‘½ä»¤/å¸¸ç”¨","link":"/categories/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/%E5%B8%B8%E7%94%A8/"}],"pages":[{"title":"","text":"ä¸ªäººç®€ä»‹æ”»åŸç‹®ï¼Œå–œæ¬¢å¬æ­Œçœ‹ç”µå½±è¯»æ–‡ç”µå°ï¼Œä¸€ä¸ªäººèµ°å¤œè·¯ åˆ†äº«è€ç½—è¯´è¿‡çš„çš„ä¸€æ®µè¯ï¼š â€œæ¯ä¸€ä¸ªç”Ÿå‘½æ¥åˆ°ä¸–é—´éƒ½æ³¨å®šæ”¹å˜ä¸–ç•Œï¼Œåˆ«æ— é€‰æ‹©ã€‚è¦ä¹ˆå˜å¾—å¥½ä¸€ç‚¹ï¼Œè¦ä¹ˆå˜å¾—åä¸€ç‚¹ã€‚ä½ å¦‚æœèµ°è¿›ç¤¾ä¼šä¸ºäº†ç”Ÿå­˜ä¸ºäº†ä»€ä¹ˆä¸è¦è„¸çš„ç†ç”±ï¼Œå˜æˆäº†ä¸€ä¸ªæ¶å¿ƒçš„æˆå¹´äººç¤¾ä¼šä¸­çš„ä¸€å‘˜ï¼Œé‚£ä½ å°±æŠŠè¿™ä¸ªä¸–ç•Œå˜å¾—æ¶å¿ƒäº†ä¸€ç‚¹ç‚¹ã€‚å¦‚æœä½ ä¸€ç”Ÿåˆšæ­£ä¸é˜¿ï¼Œå¦‚æœä½ ä¸€ç”Ÿè€¿ç›´ï¼Œæ²¡æœ‰åšä»»ä½•æ¶å¿ƒçš„äº‹æƒ…ï¼Œæ²¡åšå¯¹åˆ«äººæœ‰å®³çš„äº‹æƒ…ï¼Œä¸€è¾ˆå­æ‹¼äº†è€å‘½å‹‰å¼ºæŠŠè‡ªå·±èº«è¾¹çš„å‡ ä¸ªäººç…§é¡¾å¥½äº†ï¼Œæ²¡æœ‰æˆåæ²¡æœ‰å‘è´¢ï¼Œæ²¡æœ‰æˆå°±ä¼Ÿå¤§çš„äº‹ä¸šï¼Œç„¶åè€¿ç€è„–å­ä¸€ç”Ÿæ­£ç›´ï¼Œåˆ°äº†ä¸ƒå…«åå²è€¿ç€è„–å­å»ä¸–äº†ã€‚ä½ è¿™ä¸€ç”Ÿæ˜¯ä¸æ˜¯æ²¡æœ‰æ”¹å˜ä¸–ç•Œï¼Ÿä½ è¿˜æ˜¯æ”¹å˜ä¸–ç•Œäº†ï¼Œä½ æŠŠè¿™ä¸ªä¸–ç•Œå˜å¾—ç¾å¥½äº†ä¸€ç‚¹ç‚¹ã€‚å› ä¸ºä¸–ç•Œä¸Šåˆå¤šäº†ä¸€ä¸ªå¥½äººã€‚â€œ å†å²ä¹¦å¤ªå°ï¼Œåªä¼šè®°ä½é‚£äº›å¤©æ‰ä½†æ˜¯æ„Ÿè°¢äº’è”ç½‘ï¼Œè¿™ä¸ªæ—¶ä»£èƒ½å¤Ÿè®°ä½æ¯ä¸€ä¸ªåšå‡ºè´¡çŒ®çš„äººè¿™äº›è´¡çŒ®è®°å½•åœ¨githubä¸Š,è®°å½•åœ¨æ— æ—¶æ— åˆ»éƒ½åœ¨æµæ·Œçš„æ•°æ®é‡Œ æ¥åˆ°è¿™é‡Œçš„å°ä¼™ä¼´ä»¬æˆ‘ä»¬ä¸€èµ·åŠ æ²¹ï¼ åšå®¢ä¿¡æ¯ ç½‘ç«™é‡‡ç”¨çš„Icarusä¸»é¢˜ è¿½æ±‚å°½å¯èƒ½çš„ç®€æ´ï¼Œæ¸…æ™°ï¼Œæ˜“ç”¨ã€‚ åœ¨Icarusä¸»é¢˜ä¹‹ä¸Šè¿›è¡Œäº†éƒ¨åˆ†ä¿®æ”¹ã€‚","link":"/about/index.html"},{"title":"","text":"äº”é¢œå…­è‰²çš„ç”Ÿæ´»å•Š free time","link":"/album/index.html"},{"title":"categories","text":"","link":"/categories/index.html"},{"title":"","text":"ç»™æˆ‘ç•™ä¸ªè¨€å§ ç•™è¨€æ¿åŠ è½½ä¸­ï¼Œè¯·ç¨ç­‰... $.getScript(\"https://unpkg.com/gitalk/dist/gitalk.min.js\", function () { var gitalk = new Gitalk({ clientID: 'a1ad219ff90da8100007', clientSecret: '97b9266d67d87e37cdcb328e10460af8295a4e7d', id: '2423', repo: 'hxq94.github.io', owner: 'hxq94', admin: \"hxq94\", createIssueManually: true, distractionFreeMode: false }); gitalk.render('comment-container1'); });","link":"/self-talking/index.html"}]}